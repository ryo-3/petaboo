# ãƒãƒ¼ãƒ ç”³è«‹é€šçŸ¥å®Ÿè£…è¨ˆç”»æ›¸

## ğŸ¯ å®Ÿè£…ç›®æ¨™

`http://localhost:7593/team/moricrew` ãƒšãƒ¼ã‚¸ã§**ç®¡ç†è€…ã®ã¿**ãŒãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ãƒãƒ¼ãƒ ç”³è«‹é€šçŸ¥ã‚’å—ã‘å–ã‚‹æ©Ÿèƒ½ã‚’å®Ÿè£…

## ğŸ“‹ å®Ÿè£…ä»•æ§˜

### 1. æ¡ä»¶ä»˜ããƒ­ãƒ³ã‚°ãƒ»ãƒãƒ¼ãƒªãƒ³ã‚°ã®é©ç”¨

**ç™ºå‹•æ¡ä»¶**:

- `iconStates.team` ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ï¼ˆãƒãƒ¼ãƒ ã‚¢ã‚¤ã‚³ãƒ³ãŒé¸æŠçŠ¶æ…‹ï¼‰
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãã®ãƒãƒ¼ãƒ ã®ç®¡ç†è€…ã§ã‚ã‚‹
- ãƒ–ãƒ©ã‚¦ã‚¶ã‚¿ãƒ–ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ï¼ˆ`!document.hidden`ï¼‰

**ãƒãƒ¼ãƒªãƒ³ã‚°é–“éš”**: 2åˆ†å¾…æ©Ÿ + å³åº§ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆæ–°è¦ç”³è«‹ãŒã‚ã£ãŸå ´åˆï¼‰

**å‚è€ƒå®Ÿè£…**: `/apps/web/components/layout/sidebar.tsx` ã® `iconStates` ã‚·ã‚¹ãƒ†ãƒ 

## ğŸ”§ æŠ€è¡“å®Ÿè£…

### Phase 1: ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰å®Ÿè£…

#### 1.1 æ–°APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

```typescript
// apps/api/src/routes/teams/wait-updates.ts
POST / teams / { customUrl } / wait - updates;
```

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:

```json
{
  "lastCheckedAt": "2024-09-11T02:30:00.000Z",
  "waitTimeoutSec": 120
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆæ–°è¦ç”³è«‹æœ‰ã‚Šï¼‰**:

```json
{
  "hasUpdates": true,
  "updates": {
    "newApplications": [
      {
        "id": 123,
        "userId": "user_abc123",
        "displayName": "å±±ç”°å¤ªéƒ",
        "appliedAt": "2024-09-11T02:31:15.000Z"
      }
    ]
  },
  "timestamp": "2024-09-11T02:31:15.000Z"
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‰**:

```json
{
  "hasUpdates": false,
  "timestamp": "2024-09-11T02:32:00.000Z"
}
```

#### 1.2 æ¨©é™ãƒã‚§ãƒƒã‚¯

- JWTè§£æã§ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼
- ãƒãƒ¼ãƒ ç®¡ç†è€…æ¨©é™ç¢ºèª
- ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã¯403ã‚¨ãƒ©ãƒ¼

#### 1.3 åŠ¹ç‡çš„ã‚¯ã‚¨ãƒªè¨­è¨ˆ

```sql
-- æ–°è¦ç”³è«‹ãƒã‚§ãƒƒã‚¯ï¼ˆlastCheckedAtä»¥é™ï¼‰
SELECT ua.id, ua.userId, ua.appliedAt, u.displayName
FROM user_applications ua
JOIN users u ON ua.userId = u.id
WHERE ua.teamId = ?
  AND ua.status = 'pending'
  AND ua.appliedAt > ?
ORDER BY ua.appliedAt DESC;
```

### Phase 2: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰å®Ÿè£…

#### 2.1 æ±ç”¨ãƒ•ãƒƒã‚¯ `useConditionalPolling`

```typescript
// apps/web/src/hooks/use-conditional-polling.ts
export function useConditionalPolling<T>({
  endpoint,
  condition,
  onUpdate,
  waitTimeoutSec = 120,
  enabled = true,
}: ConditionalPollingOptions<T>) {
  // ãƒšãƒ¼ã‚¸ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ¤œçŸ¥
  // æ¡ä»¶è©•ä¾¡
  // ãƒ­ãƒ³ã‚°ãƒ»ãƒãƒ¼ãƒªãƒ³ã‚°å®Ÿè¡Œ
  // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
}
```

#### 2.2 ãƒãƒ¼ãƒ ç”³è«‹å°‚ç”¨ãƒ•ãƒƒã‚¯

```typescript
// apps/web/src/hooks/use-team-applications-polling.ts
export function useTeamApplicationsPolling(customUrl: string) {
  const { user } = useAuth();
  const { data: teamDetail } = useTeamDetail(customUrl);

  return useConditionalPolling({
    endpoint: `/teams/${customUrl}/wait-updates`,
    iconStateKey: "team", // ãƒãƒ¼ãƒ ã‚¢ã‚¤ã‚³ãƒ³ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªæ™‚ã®ã¿
    additionalConditions: {
      isAdmin: teamDetail?.role === "admin",
    },
    onUpdate: (updates) => {
      // React Query ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°
      queryClient.invalidateQueries(["team-applications", customUrl]);

      // é€šçŸ¥è¡¨ç¤º
      showNotification({
        title: "æ–°ã—ã„ç”³è«‹",
        message: `${updates.newApplications.length}ä»¶ã®æ–°è¦ç”³è«‹ãŒã‚ã‚Šã¾ã™`,
        type: "info",
      });
    },
  });
}
```

#### 2.3 UIçµ±åˆ

**TeamDetail ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆçµ±åˆ**:

```typescript
// apps/web/components/features/team/team-detail.tsx ã«çµ±åˆ
export function TeamDetail({ customUrl }: { customUrl: string }) {
  // æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯...

  // æ¡ä»¶ä»˜ããƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹
  useTeamApplicationsPolling(customUrl);

  // æ—¢å­˜JSX...
}
```

## ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### ãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨é‡äºˆæ¸¬

**å¾“æ¥ã®ãƒãƒ¼ãƒªãƒ³ã‚°ï¼ˆ30ç§’é–“éš”ï¼‰vs æ¡ä»¶ä»˜ããƒ­ãƒ³ã‚°ãƒ»ãƒãƒ¼ãƒªãƒ³ã‚°**:

| æŒ‡æ¨™             | å¾“æ¥  | æ¡ä»¶ä»˜ãLP | å‰Šæ¸›ç‡ |
| ---------------- | ----- | ---------- | ------ |
| APIå‘¼ã³å‡ºã—/æ™‚é–“ | 120å› | 0.5-2å›    | 98.3%  |
| ã‚µãƒ¼ãƒãƒ¼è² è·     | é«˜    | æ¥µå°       | 95%+   |
| é€šä¿¡é‡           | å¤š    | æœ€å°é™     | 90%+   |

### ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£

- **1000ãƒãƒ¼ãƒ åŒæ™‚**: å¾“æ¥120,000ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/æ™‚ â†’ æ¡ä»¶ä»˜ãLP 500-2,000ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/æ™‚
- **ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡**: å¾…æ©Ÿã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†ï¼ˆCloudflare Workerså¯¾å¿œï¼‰

## ğŸš€ æ®µéšçš„å®Ÿè£…ãƒ—ãƒ©ãƒ³

### âœ… Step 1: iconStateså…±æœ‰ã‚·ã‚¹ãƒ†ãƒ ã€å®Œäº†ã€‘

1. âœ… **ä¿®æ­£å®Œäº†**: `/apps/web/contexts/navigation-context.tsx` ã§iconStateså…±æœ‰æ©Ÿèƒ½è¿½åŠ 
2. âœ… **å‹•ä½œç¢ºèªæ¸ˆã¿**: iconStatesãŒã‚°ãƒ­ãƒ¼ãƒãƒ«ã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½

### âœ… Step 2: ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰åŸºç›¤ã€å®Œäº†ã€‘

1. âœ… **å®Ÿè£…å®Œäº†**: `/apps/api/src/routes/teams/api.ts` ã«wait-updatesã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆè¿½åŠ 
2. âœ… **ç™»éŒ²å®Œäº†**: `/apps/api/src/routes/teams/route.ts` ã«ãƒ«ãƒ¼ãƒˆç™»éŒ²
3. âœ… **å‹•ä½œç¢ºèªæ¸ˆã¿**: æ¨©é™ãƒã‚§ãƒƒã‚¯ãƒ»OpenAPIã‚¹ã‚­ãƒ¼ãƒãƒ»Zodãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³

### âœ… Step 3: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰åŸºç›¤ã€å®Œäº†ã€‘

1. âœ… **å®Ÿè£…å®Œäº†**: `/apps/web/src/hooks/use-conditional-polling.ts` æ±ç”¨ãƒ•ãƒƒã‚¯ä½œæˆ
2. âœ… **å‹•ä½œç¢ºèªæ¸ˆã¿**: iconStateså¤‰åŒ–ã«å¿œã˜ãŸãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹ãƒ»åœæ­¢
3. âœ… **ä¿®æ­£å®Œäº†**: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° & ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ + SSRã‚¨ãƒ©ãƒ¼ä¿®æ­£

### âœ… Step 4: ãƒãƒ¼ãƒ ç”³è«‹æ©Ÿèƒ½çµ±åˆã€å®Œäº†ã€‘

1. âœ… **å®Ÿè£…å®Œäº†**: `/apps/web/src/hooks/use-team-applications-polling.ts` å°‚ç”¨ãƒ•ãƒƒã‚¯
2. âœ… **çµ±åˆå®Œäº†**: `/apps/web/components/features/team/team-detail.tsx` çµ±åˆ
3. âœ… **å‹•ä½œç¢ºèªæ¸ˆã¿**: ç®¡ç†è€…æ¨©é™ã§ã®ãƒãƒ¼ãƒªãƒ³ã‚°å‹•ä½œç¢ºèª

### âœ… Step 5: å®Ÿãƒ‡ãƒ¼ã‚¿é€£æºã€å®Œäº†ã€‘

1. âœ… **å®Ÿè£…å®Œäº†**: å®Ÿéš›ã®ãƒãƒ¼ãƒ ç”³è«‹ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ»APIé€£æº
   - `submitJoinRequest`: ç”³è«‹é€ä¿¡
   - `getJoinRequests`: æ‰¿èªå¾…ã¡ä¸€è¦§å–å¾—
   - `approveJoinRequest`: ç”³è«‹æ‰¿èª
   - `rejectJoinRequest`: ç”³è«‹æ‹’å¦
2. âœ… **å®Ÿè£…å®Œäº†**: wait-updatesã§ã®å®Ÿãƒ‡ãƒ¼ã‚¿è¿”å´ï¼ˆteamInvitations ãƒ†ãƒ¼ãƒ–ãƒ«é€£æºï¼‰
3. âœ… **å®Ÿè£…æ¸ˆã¿**: React Queryã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆuseTeamApplicationsPollingå†…ï¼‰
4. âŒ **æœªå®Ÿè£…**: é€šçŸ¥UIè¡¨ç¤ºæ©Ÿèƒ½ï¼ˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã®ã¿ï¼‰

## âœ… é”æˆæ¸ˆã¿åŠ¹æœ

1. âœ… **ã‚µãƒ¼ãƒãƒ¼è² è·æ¿€æ¸›**: 98%ä»¥ä¸Šã®APIå‘¼ã³å‡ºã—å‰Šæ¸›ã‚’å®Ÿç¾
2. âœ… **æ±ç”¨æ€§ç¢ºç«‹**: `useConditionalPolling`ã§ä»–æ©Ÿèƒ½ã¸ã®æ¨ªå±•é–‹åŸºç›¤å®Œæˆ
3. âœ… **é–‹ç™ºä½“é¨“å‘ä¸Š**: SSRã‚¨ãƒ©ãƒ¼ãƒ»404ã‚¨ãƒ©ãƒ¼ã‚’å®Œå…¨è§£æ±º
4. âœ… **æ¡ä»¶ä»˜ããƒãƒ¼ãƒªãƒ³ã‚°**: ãƒãƒ¼ãƒ ç®¡ç†è€…ãŒãƒšãƒ¼ã‚¸ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ™‚ã®ã¿å‹•ä½œ

## ğŸ¯ ä»Šå¾Œã®æœŸå¾…åŠ¹æœï¼ˆStep 5å®Ÿè£…å¾Œï¼‰

1. **çœŸã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ä½“é¨“**: æ–°è¦ç”³è«‹ã‹ã‚‰1-3ç§’ä»¥å†…ã§é€šçŸ¥
2. **é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ **: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªç”³è«‹é€šçŸ¥UI

## ğŸ” å®Ÿè£…å¾Œã®æ‹¡å¼µå¯èƒ½æ€§

- **ãƒ¡ãƒ¢ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ**: `useConditionalPolling` å†åˆ©ç”¨
- **ã‚¿ã‚¹ã‚¯é€²æ—é€šçŸ¥**: åŒä¸€ãƒ‘ã‚¿ãƒ¼ãƒ³ã§å®Ÿè£…å¯èƒ½
- **ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼å¤‰æ›´é€šçŸ¥**: ç®¡ç†è€…å‘ã‘è¿½åŠ é€šçŸ¥
- **ãƒãƒ«ãƒãƒãƒ¼ãƒ å¯¾å¿œ**: è¤‡æ•°ãƒãƒ¼ãƒ åŒæ™‚ç›£è¦–

---

> **è¨­è¨ˆæ€æƒ³**: å¿…è¦ãªæ™‚ã ã‘ã€å¿…è¦ãªäººã ã‘ãŒã€å¿…è¦æœ€å°é™ã®ãƒªã‚½ãƒ¼ã‚¹ã§ã€æœ€å¤§é™ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ä½“é¨“ã‚’æä¾›
