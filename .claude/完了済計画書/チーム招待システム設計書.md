# チーム招待システム設計書

## 概要

招待コード方式から、招待URL + 承認制度に変更する新しいチーム招待システム

## 現在の問題点

- 招待コード入力が面倒
- リロード時にコードが消える
- スパム対策が不十分
- 管理者が参加者を事前把握できない

## 新システムのフロー

### 1. 招待URL生成（管理者側）

```
管理者がチーム詳細画面で「招待URL生成」
↓
一意なトークン付きURL生成: /join/{teamCustomUrl}?token={uniqueToken}
↓
URL表示・コピー・共有
```

### 2. 参加申請（招待された側）

```
招待URLにアクセス
↓
チーム情報表示 + 参加申請フォーム
↓
ユーザー情報入力（表示名など）
↓
「参加を申請する」送信
↓
申請完了メッセージ表示
```

### 3. 承認管理（管理者側）

```
管理者にリアルタイム通知
↓
承認待ちリストで申請者確認
↓
承認 or 拒否の判断
↓
承認時：チームメンバーに追加
拒否時：申請者に通知
```

## 必要なページ・コンポーネント

### A. 管理者側機能

1. **招待URL生成UI** (既存のteam-detail.tsxを改修)
   - 招待URL表示・コピー機能
   - URL有効期限設定（デフォルト3日）
   - URL無効化機能

2. **承認待ちリスト**
   - チーム詳細画面内に新タブ追加
   - 申請者一覧表示
   - 承認・拒否ボタン
   - 申請日時・ユーザー情報表示

### B. 招待される側機能

3. **参加申請ページ** (`/join/[teamCustomUrl]/page.tsx`)
   - トークン検証
   - チーム情報表示
   - 参加申請フォーム
   - ログイン誘導（未ログイン時）

### C. 共通機能

4. **通知システム**
   - 管理者への申請通知
   - 申請者への承認・拒否通知

## データベース設計

### 既存テーブル活用: `teamInvitations`

新しいテーブルを作成せず、既存の`teamInvitations`テーブルを拡張して活用。
後方互換性を保ちながら新機能に対応。

```sql
-- 既存テーブルに追加されたフィールド（任意）
ALTER TABLE team_invitations ADD COLUMN user_id TEXT; -- 申請者のClerk user ID
ALTER TABLE team_invitations ADD COLUMN display_name TEXT; -- 申請者の表示名
ALTER TABLE team_invitations ADD COLUMN message TEXT; -- 申請メッセージ
ALTER TABLE team_invitations ADD COLUMN processed_at INTEGER; -- 承認・拒否された日時
ALTER TABLE team_invitations ADD COLUMN processed_by TEXT; -- 処理した管理者のuser_id
```

### 使用方法:

- **招待URL生成時**: `email = "URL_INVITE"`, `status = "active"`
- **参加申請時**: `email = 申請者メール`, `status = "pending"`, `user_id`, `display_name`設定
- **承認時**: `status = "approved"`, `processed_at`, `processed_by`設定

## API設計

### 1. 招待URL生成・管理 ✅ **完成**

```
// URL生成
POST /api/teams/{teamCustomUrl}/invite-url
Body: { expiresInDays: 3 }
Response: {
  token: "abc123",
  url: "http://localhost:7593/join/teamname?token=abc123",
  expiresAt: "2025-01-10T12:00:00Z"
}

// 既存URL取得
GET /api/teams/{teamCustomUrl}/invite-url
Response: { token, url, expiresAt, createdAt } | null

// URL削除（即座削除）
DELETE /api/teams/{teamCustomUrl}/invite-url
Response: { message: "招待URLを削除しました" }
```

### 2. トークン検証・チーム情報取得

```
GET /api/teams/join/{teamCustomUrl}?token={token}
Response: { team: {name, description, memberCount}, isValid: true }
```

### 3. 参加申請送信

```
POST /api/teams/join/{teamCustomUrl}
Body: { token: "abc123", displayName: "田中太郎", message: "よろしくお願いします" }
Response: { requestId: 123, status: "pending" }
```

### 4. 承認待ちリスト取得

```
GET /api/teams/{teamCustomUrl}/join-requests
Response: { requests: [{id, displayName, requestedAt, message}] }
```

### 5. 承認・拒否処理

```
POST /api/teams/{teamCustomUrl}/join-requests/{requestId}/approve
POST /api/teams/{teamCustomUrl}/join-requests/{requestId}/reject
Body: { message: "承認理由" }
```

## 実装フェーズ

### Phase 1: 基盤構築 ✅ **完了**

- [x] ~~データベーステーブル作成~~ → 既存テーブル活用に変更
- [x] 招待URL生成API (`POST /teams/{customUrl}/invite-url`)
- [x] 既存招待URL取得API (`GET /teams/{customUrl}/invite-url`)
- [x] 招待URL削除API (`DELETE /teams/{customUrl}/invite-url`)
- [x] フロントエンド側API連携修正
- [x] React Query統合とキャッシュ管理
- [x] 完全URL形式での招待リンク生成
- [ ] トークン検証API（Phase 2で実装）

### Phase 2: 参加申請機能 ✅ **完了**

- [x] `/join/[teamCustomUrl]/page.tsx` 作成
- [x] トークン検証API実装 (`GET /teams/join/{customUrl}`)
- [x] 参加申請API実装 (`POST /teams/join/{customUrl}`)
- [x] 申請フォームUI実装（状態別UI切り替え）
- [x] 認証ヘッダー送信による申請状態検知
- [x] 申請更新方式（重複防止）と100人制限実装

### Phase 3: 承認管理機能 ✅ **完了**

- [x] 承認待ちリスト表示（概要ページに統合表示）
- [x] 承認・拒否API実装（PUT /teams/{customUrl}/join-requests/{requestId}/approve|reject）
- [x] 承認待ちリスト取得API実装（GET /teams/{customUrl}/join-requests）
- [x] チーム詳細画面UI改修（タブではなく概要ページ内に統合）
- [x] メンバー一覧表示機能（実際のデータベース連携）
- [x] カラフルアイコンシステム（30色パレット、ユーザーID基準）
- [x] 承認時display_name自動保存（usersテーブル更新）
- [x] React Query状態管理（承認・拒否・リスト取得）

### Phase 4: 管理者側UI改修 ✅ **完了**

- [x] ~~現在の招待コード機能を招待URL機能に変更~~
- [x] URL生成・表示・コピー機能
- [x] URL管理機能（更新・削除）
- [x] 既存URL優先表示（リフレッシュ時も同じURL表示）
- [x] ローディング状態とエラーハンドリング完備
- [x] ユーザーフレンドリーなUI/UX

### Phase 5: 通知・UX向上

- [ ] リアルタイム通知
- [ ] メール通知（optional）
- [ ] エラーハンドリング強化
- [ ] ローディング状態改善

## セキュリティ考慮事項

- トークンは暗号学的に安全な乱数生成
- トークン有効期限の厳格なチェック
- 同一ユーザーの重複申請防止
- レート制限（トークン生成・申請送信）
- 管理者権限の厳格な検証

## 将来拡張可能性

- ~~招待時の権限指定（admin/member）~~ → 完了：シンプル化により不要
- 一括承認機能
- 申請理由のテンプレート
- チーム参加ガイドライン設定
- 自動承認条件設定（ドメイン制限など）
- 招待URL使用状況分析（アクセス数・参加数）
- 複数招待URL管理（用途別・期間別）

---

## 📊 進捗状況（2025年9月7日時点）

### ✅ **完了済み**

- **Phase 1**: 基盤構築 - 招待URL生成・取得・削除API完成、React Query統合完了
- **Phase 2**: 参加申請機能 - 招待URL検証・申請フォーム・状態管理UI完成
- **Phase 3**: 承認管理機能 - 承認・拒否・メンバー一覧表示、カラフルアイコン完成
- **Phase 4**: 管理者側UI改修 - 完全なURL管理機能、UX最適化完成

### 🚀 **追加実装完了（設計外の最適化）**

- **データベースシンプル化**: `teamInvitations.role`カラム完全削除
- **即座削除システム**: expired状態のレコード物理削除でDB効率化
- **権限管理統一**: 招待経由は常にmember権限、後でメンバー一覧で調整
- **LINEのQRコード方式**: ワンクリック招待URL生成の究極シンプル化
- **申請更新方式**: 重複申請防止で既存申請の表示名・メール更新
- **100人制限**: URL単位での使用回数制限（`usageCount`/`maxUsage`管理）
- **認証状態連携**: フロントエンドでの認証ヘッダー送信による申請状況検知
- **承認管理統合UI**: 承認待ちリストを概要ページに統合、タブ分けしない直感的な設計
- **メンバー一覧表示**: 実際のデータベース連携でのメンバー情報表示（名前・参加日・役職）
- **カラフルアイコンシステム**: ユーザーIDベースの30色パレット自動生成
- **自動名前保存**: 承認時に申請者の表示名をusersテーブルに自動保存

### 🔄 **次回実装予定**

- **Phase 5**: 通知・UX向上
  - リアルタイム通知システム
  - メール通知（optional）
  - エラーハンドリング強化
  - ローディング状態改善

### 📋 **実装メモ**

- データベースリセット禁止（`npm run db:reset:local`は絶対禁止）
- 既存の`teamInvitations`テーブル活用、role管理をteamMembersに集約
- 完全URL形式（`http://localhost:7593/join/...`）で招待リンク生成
- マイグレーション完了：ローカル・本番両環境でroleカラム削除済み

**実績: ~~Phase 1~~ ✅ → ~~Phase 2~~ ✅ → ~~Phase 4~~ ✅ → ~~Phase 3~~ ✅ → Phase 5**

### 🎯 **設計思想の進化**

当初の「招待時role指定 + 承認制」から「常にmember参加 + 後で権限調整」へとシンプル化。
LINEのQRコードのような直感的な招待体験を実現し、管理者の負担も大幅軽減。
