# Slacké€šçŸ¥æ©Ÿèƒ½ å®Ÿè£…è¨ˆç”»æ›¸

## ğŸ“‹ æ¦‚è¦

ãƒãƒ¼ãƒ ã”ã¨ã«Slack Webhook URLã‚’ä¿å­˜ãƒ»ç®¡ç†ã—ã€ãƒãƒ¼ãƒ æ´»å‹•ã®é€šçŸ¥ã‚’Slackã«é€ä¿¡ã™ã‚‹æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹ã€‚

## ğŸ¯ è¦ä»¶

### ãƒ•ã‚§ãƒ¼ã‚º1: åŸºæœ¬æ©Ÿèƒ½ï¼ˆMVPï¼‰

- ãƒãƒ¼ãƒ ã”ã¨ã«Slack Webhook URLã‚’ä¿å­˜ï¼ˆå¹³æ–‡ï¼‰
- Webhook URLã®ç™»éŒ²ãƒ»æ›´æ–°ãƒ»å‰Šé™¤API
- ãƒ†ã‚¹ãƒˆé€šçŸ¥é€ä¿¡æ©Ÿèƒ½

### ãƒ•ã‚§ãƒ¼ã‚º2: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ï¼ˆå¾Œæ—¥ï¼‰

- Webhook URLã®æš—å·åŒ–ä¿å­˜
- æš—å·åŒ–ã‚­ãƒ¼ã‚’Workers Secretsã§ç®¡ç†

## ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«: `team_slack_configs`

```sql
CREATE TABLE team_slack_configs (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  teamId INTEGER NOT NULL UNIQUE,
  webhookUrl TEXT NOT NULL,
  isEnabled INTEGER DEFAULT 1,
  createdAt TEXT NOT NULL,
  updatedAt TEXT NOT NULL,
  FOREIGN KEY (teamId) REFERENCES teams(id) ON DELETE CASCADE
);
```

**ã‚«ãƒ©ãƒ èª¬æ˜:**

- `teamId`: ãƒãƒ¼ãƒ IDï¼ˆUNIQUEåˆ¶ç´„ã§1ãƒãƒ¼ãƒ 1è¨­å®šã®ã¿ï¼‰
- `webhookUrl`: Slack Webhook URLï¼ˆãƒ•ã‚§ãƒ¼ã‚º1ã¯å¹³æ–‡ã€ãƒ•ã‚§ãƒ¼ã‚º2ã§æš—å·åŒ–ï¼‰
- `isEnabled`: é€šçŸ¥ON/OFFï¼ˆ0=ç„¡åŠ¹, 1=æœ‰åŠ¹ï¼‰
- `createdAt/updatedAt`: ä½œæˆãƒ»æ›´æ–°æ—¥æ™‚

## ğŸ”Œ APIè¨­è¨ˆ

### 1. Webhook URLç™»éŒ²ãƒ»æ›´æ–°

```
PUT /teams/{teamId}/slack-config
Authorization: Bearer {token}

Request:
{
  "webhookUrl": "https://hooks.slack.com/services/XXX/YYY/ZZZ",
  "isEnabled": true
}

Response: 200 OK
{
  "id": 1,
  "teamId": 5,
  "webhookUrl": "https://hooks.slack.com/services/XXX/YYY/ZZZ",
  "isEnabled": true,
  "createdAt": "2025-10-13T10:00:00Z",
  "updatedAt": "2025-10-13T10:00:00Z"
}
```

### 2. Webhook URLå–å¾—

```
GET /teams/{teamId}/slack-config
Authorization: Bearer {token}

Response: 200 OK
{
  "id": 1,
  "teamId": 5,
  "webhookUrl": "https://hooks.slack.com/services/XXX/YYY/ZZZ",
  "isEnabled": true,
  "createdAt": "2025-10-13T10:00:00Z",
  "updatedAt": "2025-10-13T10:00:00Z"
}

Response: 404 Not Foundï¼ˆæœªè¨­å®šã®å ´åˆï¼‰
{
  "error": "Slack configuration not found"
}
```

### 3. Webhook URLå‰Šé™¤

```
DELETE /teams/{teamId}/slack-config
Authorization: Bearer {token}

Response: 204 No Content
```

### 4. ãƒ†ã‚¹ãƒˆé€šçŸ¥é€ä¿¡

```
POST /teams/{teamId}/slack-config/test
Authorization: Bearer {token}

Response: 200 OK
{
  "success": true,
  "message": "Test notification sent successfully"
}

Response: 400 Bad Requestï¼ˆé€ä¿¡å¤±æ•—æ™‚ï¼‰
{
  "success": false,
  "error": "Failed to send notification: invalid_webhook_url"
}
```

## ğŸ› ï¸ å®Ÿè£…æ‰‹é †

### ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒè¿½åŠ 

- [ ] `apps/api/src/db/schema.ts` ã« `teamSlackConfigs` ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©è¿½åŠ 
- [ ] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ: `npm run db:generate`
- [ ] ãƒ­ãƒ¼ã‚«ãƒ«ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ: `npm run db:migration:local`

### ã‚¹ãƒ†ãƒƒãƒ—2: APIå®Ÿè£…

- [ ] `apps/api/src/routes/teams/slack-config/route.ts` ä½œæˆ
- [ ] `apps/api/src/routes/teams/slack-config/api.ts` å®Ÿè£…
  - PUT `/teams/{teamId}/slack-config` - ç™»éŒ²ãƒ»æ›´æ–°
  - GET `/teams/{teamId}/slack-config` - å–å¾—
  - DELETE `/teams/{teamId}/slack-config` - å‰Šé™¤
  - POST `/teams/{teamId}/slack-config/test` - ãƒ†ã‚¹ãƒˆé€ä¿¡
- [ ] `apps/api/worker-d1.ts` ã«ãƒ«ãƒ¼ãƒˆç™»éŒ²ï¼ˆé‡è¦ï¼ï¼‰

### ã‚¹ãƒ†ãƒƒãƒ—3: æ¨©é™ãƒã‚§ãƒƒã‚¯å®Ÿè£…

- [ ] ãƒãƒ¼ãƒ ç®¡ç†è€…ï¼ˆowner/adminï¼‰ã®ã¿ãŒWebhook URLè¨­å®šå¯èƒ½
- [ ] ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼å…¨å“¡ãŒè¨­å®šå†…å®¹ã‚’é–²è¦§å¯èƒ½

### ã‚¹ãƒ†ãƒƒãƒ—4: Slacké€šçŸ¥ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ä½œæˆ

- [ ] `apps/api/src/utils/slack-notifier.ts` ä½œæˆ
- [ ] é€šçŸ¥é€ä¿¡å…±é€šé–¢æ•°å®Ÿè£…

```typescript
// apps/api/src/utils/slack-notifier.ts
export async function sendSlackNotification(
  webhookUrl: string,
  message: string,
): Promise<boolean> {
  try {
    const response = await fetch(webhookUrl, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ text: message }),
    });
    return response.ok;
  } catch (error) {
    console.error("Slack notification error:", error);
    return false;
  }
}
```

### ã‚¹ãƒ†ãƒƒãƒ—5: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…

- [ ] ãƒãƒ¼ãƒ è¨­å®šç”»é¢ã«Slacké€£æºã‚»ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ 
- [ ] Webhook URLå…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆ
- [ ] ON/OFFãƒˆã‚°ãƒ«å®Ÿè£…
- [ ] ãƒ†ã‚¹ãƒˆé€ä¿¡ãƒœã‚¿ãƒ³å®Ÿè£…

## ğŸ§ª ãƒ†ã‚¹ãƒˆè¨ˆç”»

### APIãƒ†ã‚¹ãƒˆ

```bash
# 1. Webhook URLç™»éŒ²
apitest "/teams/1/slack-config" "PUT" '{"webhookUrl":"https://hooks.slack.com/services/TEST","isEnabled":true}'

# 2. Webhook URLå–å¾—
apitest "/teams/1/slack-config" "GET"

# 3. ãƒ†ã‚¹ãƒˆé€šçŸ¥é€ä¿¡
apitest "/teams/1/slack-config/test" "POST"

# 4. Webhook URLå‰Šé™¤
apitest "/teams/1/slack-config" "DELETE"
```

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç¢ºèª

```bash
npx wrangler d1 execute DB --local --command "SELECT * FROM team_slack_configs;"
```

## ğŸ“ é€šçŸ¥ã‚¤ãƒ™ãƒ³ãƒˆè¨­è¨ˆ

### ãƒ•ã‚§ãƒ¼ã‚º1: ã‚³ãƒ¡ãƒ³ãƒˆãƒ»ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³é€šçŸ¥ï¼ˆå„ªå…ˆå®Ÿè£…ï¼‰

æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆæ©Ÿèƒ½ï¼ˆ`team_comments`ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰ã¨çµ±åˆã—ã€ä»¥ä¸‹ã®é€šçŸ¥ã‚’å®Ÿè£…ï¼š

#### æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆæ©Ÿèƒ½

- **ãƒ†ãƒ¼ãƒ–ãƒ«**: `team_comments`
- **API**: `POST /comments?teamId=X` - ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ï¼ˆãƒ¡ãƒ³ã‚·ãƒ§ãƒ³è‡ªå‹•è§£æï¼‰
- **ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³**: `@displayName` å½¢å¼ã§è‡ªå‹•æ¤œå‡ºã€`mentions`ã‚«ãƒ©ãƒ ã«JSONé…åˆ—ä¿å­˜

#### 1. ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³é€šçŸ¥

**ãƒˆãƒªã‚¬ãƒ¼**: ã‚³ãƒ¡ãƒ³ãƒˆã« `@displayName` ãŒå«ã¾ã‚Œã‚‹å ´åˆ
**é€šçŸ¥æ–¹å¼**: ãƒãƒ¼ãƒ ã®Slackãƒãƒ£ãƒ³ãƒãƒ«ã«æŠ•ç¨¿ï¼ˆWebhook URLä½¿ç”¨ï¼‰
**é€šçŸ¥å†…å®¹**:

```
ğŸ”” @{displayName} ã•ã‚“ãŒãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã•ã‚Œã¾ã—ãŸ

ğŸ“ {targetType}: {targetTitle}
ğŸ’¬ {commenterDisplayName}: {commentContent}

ğŸ”— {ãƒªãƒ³ã‚¯}
```

**å®Ÿè£…ç®‡æ‰€**: `POST /comments` APIå†…ï¼ˆL234-277ï¼‰ã§ã‚³ãƒ¡ãƒ³ãƒˆä½œæˆå¾Œã«Slacké€šçŸ¥é€ä¿¡

**å®Ÿè£…è©³ç´°**:

```typescript
// 1. ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³è§£ææ¸ˆã¿ï¼ˆL256ï¼‰
const mentionedUserIds = await extractMentions(content, teamId, db);

// 2. ã‚³ãƒ¡ãƒ³ãƒˆä½œæˆï¼ˆL262-274ï¼‰
const result = await db.insert(teamComments).values({...}).returning();

// 3. Slacké€šçŸ¥é€ä¿¡ï¼ˆè¿½åŠ å®Ÿè£…ï¼‰
if (mentionedUserIds.length > 0) {
  // mentionedUserIdsã‹ã‚‰displayNameå–å¾—
  const mentionedUsers = await getMentionedUsersDisplayNames(mentionedUserIds, teamId, db);

  // Slackè¨­å®šå–å¾—
  const slackConfig = await getTeamSlackConfig(teamId, db);

  if (slackConfig?.isEnabled) {
    const message = formatMentionNotification(mentionedUsers, result[0], commenter);
    await sendSlackNotification(slackConfig.webhookUrl, message);
  }
}
```

**é‡è¦**: Webhook URLã§ã¯å€‹åˆ¥DMé€ä¿¡ä¸å¯ã€‚ãƒãƒ¼ãƒ å…¨å“¡ãŒè¦‹ãˆã‚‹ãƒãƒ£ãƒ³ãƒãƒ«ã«æŠ•ç¨¿ã•ã‚Œã‚‹ã€‚

#### 2. ã‚³ãƒ¡ãƒ³ãƒˆé€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

**ãƒˆãƒªã‚¬ãƒ¼**: ãƒ¡ãƒ¢ãƒ»ã‚¿ã‚¹ã‚¯ãƒ»ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ¡ãƒ³ãƒˆãŒæŠ•ç¨¿ã•ã‚ŒãŸå ´åˆ
**é€šçŸ¥å¯¾è±¡**: å¯¾è±¡ã®ä½œæˆè€… or ãƒãƒ¼ãƒ å…¨ä½“ï¼ˆè¨­å®šã«ã‚ˆã‚‹ï¼‰
**é€šçŸ¥å†…å®¹**:

```
ğŸ’¬ æ–°ã—ã„ã‚³ãƒ¡ãƒ³ãƒˆãŒæŠ•ç¨¿ã•ã‚Œã¾ã—ãŸ

ğŸ“ {targetType}: {targetTitle}
ğŸ‘¤ {commenterDisplayName}: {commentContent}

ğŸ”— {ãƒªãƒ³ã‚¯}
```

### ãƒ•ã‚§ãƒ¼ã‚º2: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–

- Webhook URLã®æš—å·åŒ–ä¿å­˜
- Workers Secretsã§æš—å·åŒ–ã‚­ãƒ¼ç®¡ç†

### ãƒ•ã‚§ãƒ¼ã‚º3: ãã®ä»–ã®é€šçŸ¥ã‚¤ãƒ™ãƒ³ãƒˆ

- ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼æ‹›å¾…ãƒ»æ‰¿èªé€šçŸ¥
- ã‚¿ã‚¹ã‚¯å‰²ã‚Šå½“ã¦é€šçŸ¥
- å®šæœŸã‚µãƒãƒªãƒ¼é€šçŸ¥

### é€šçŸ¥è¨­å®šã®è©³ç´°åŒ–ï¼ˆå°†æ¥ï¼‰

- é€šçŸ¥ç¨®åˆ¥ã”ã¨ã®ON/OFF
- é€šçŸ¥æ™‚é–“å¸¯è¨­å®š
- é€šçŸ¥ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

## ğŸš¨ æ³¨æ„äº‹é …

- **ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç™»éŒ²å¿…é ˆ**: `worker-d1.ts` ã¸ã®ç™»éŒ²ã‚’å¿˜ã‚Œãªã„ã“ã¨
- **æ¨©é™ãƒã‚§ãƒƒã‚¯**: ãƒãƒ¼ãƒ ç®¡ç†è€…ã®ã¿ãŒè¨­å®šå¤‰æ›´å¯èƒ½
- **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: Webhook URLç„¡åŠ¹æ™‚ã®é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
- **ãƒ¬ãƒ¼ãƒˆåˆ¶é™**: Slack APIã®åˆ¶é™ã«æ³¨æ„ï¼ˆ1ãƒãƒ£ãƒ³ãƒãƒ«ã‚ãŸã‚Š1ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸/ç§’ï¼‰
