# モバイルスクロール問題調査メモ

## 問題の発生箇所

- メモ一覧・タスク一覧のモバイル版
- ヘッダー（固定）とフッター（固定）の間でコンテンツをスクロールさせたい

## 試したアプローチと結果

### 1. 空div方式（最初の実装）

**実装方法:**

```tsx
<ItemGrid>
  <div className="h-[70px] md:h-0" /> // 上部余白
  {items}
  <div className="h-[80px] md:h-0" /> // 下部余白
</ItemGrid>
```

**結果:**

- ❌ スクロールが最後まで届かない
- ❌ 上部がヘッダーと被る

**コミット:** `0d0105ac` で問題として記録

---

### 2. 透明カード方式

**実装方法:**

```tsx
// ItemStatusDisplay でダミーアイテムを生成
const spacerTop = createSpacerItem(-1);
const spacerBottom = createSpacerItem(-2);

<ItemDisplay isSpacer spacerHeight="70px" />;
{
  items;
}
<ItemDisplay isSpacer spacerHeight="80px" />;
```

**結果:**

- ❌ モバイルでカードが完全に消える
- デバッグ用に `bg-red-200` を追加しても表示されない

**コミット:** `c34f4c20` → `6ffae41b` (デバッグ) → `79f548cb` (削除)

---

### 3. padding + overflow-y-auto 方式

**実装方法:**

```tsx
// ItemGrid
<div className="flex-1 overflow-y-auto">
  <div className="pt-[70px] pb-[80px] md:pt-0 md:pb-0">{items}</div>
</div>
```

**結果:**

- ❓ ユーザー未確認（コミット直後に別アプローチへ）

**コミット:** `79f548cb`

---

### 4. position: sticky 方式

**実装方法:**

```tsx
// Header
<header className="sticky top-0 z-50">

// Sidebar (モバイルフッター)
<div className="sticky bottom-0 z-50">

// ItemGrid
<div className="pt-[70px] pb-[80px]">  // overflow削除
```

**結果:**

- ❌ `/test-scroll` でも sticky が全く効かない
- ヘッダーもフッターも画面に固定されない

**原因:**

- stickyは親要素がスクロールコンテナである必要がある
- `min-h-screen` だけではスクロールコンテナにならない

**コミット:** `90701d77`

---

### 5. position: fixed 方式（現在）

**実装方法:**

```tsx
// Header
<header className="fixed top-0 left-0 right-0 z-50">

// Sidebar (モバイルフッター)
<div className="fixed bottom-0 left-0 right-0 z-50">

// MemoScreen/TaskScreen (モバイル版)
<div className="pt-[48px] pb-[56px]">
  {leftPanelContent}
</div>

// ItemGrid
<div className="pr-2 mb-2">  // padding削除
  {items}
</div>
```

**結果:**

- ❓ ユーザーが実機確認中

**コミット:** `f723e92d`

---

## 未確認事項

### 1. デバイス・ブラウザ情報

- iOS Safari? Android Chrome?
- バージョンは？

### 2. `/test-scroll` の挙動

- テストページでも同じ問題が起きるか？
- 起きる場合、sticky方式でも fixed方式でも同じ？

### 3. PC版の挙動

- PC版（md:以上）は正常に動作しているか？
- 問題はモバイル版のみ？

### 4. 具体的な症状

- [ ] スクロール自体ができない
- [ ] スクロールはできるが、最後まで届かない
- [ ] ヘッダー・フッターが固定されない
- [ ] コンテンツが上下で切れる
- [ ] フッターが伸びる（以前の症状）
- [ ] その他:

---

## 現在の問題（仮説）

**症状:**

- ヘッダー（48px）とフッター（56px）を固定して、間のコンテンツをスクロールさせたい
- しかし、何らかの理由でスクロールが正常に動作しない

**考えられる原因:**

1. 親要素の高さ制約（`h-full`, `min-h-0`）がスクロールを妨げている
2. `flex flex-col` の子要素の height 計算が正しくない
3. iOS Safari 特有のスクロール問題
4. padding が効いていない（重なっている）

---

## 次の検証アプローチ（順番に試す）

### ✅ アプローチ1: position: fixed（検証完了）

**方針:** ページ全体を普通にスクロール、ヘッダー・フッターを固定

**実装状況:** 完了（`f723e92d`）

**確認項目:**

- [x] `/test-scroll` で動作するか？ → ✅ 動作OK
- [x] 本番環境（メモ一覧）で動作するか？ → ❌ 動作しない
- [x] 症状は何？ → 構造の違いが原因

**結果:**

- `/test-scroll`（シンプルな構造）は動作
- メモ・タスク一覧（複雑な構造）は動作しない
- 原因: `h-full flex flex-col` などの複雑な高さ制約

**判明した事実:**

構造の違いが問題。メモ・タスク一覧を `/test-scroll` の構造に合わせる必要がある。

---

### ✅ アプローチ6: モバイル版を /test-scroll 構造に統一（現在）

**方針:** メモ・タスク一覧のモバイル版を `/test-scroll` と同じシンプルな構造に変更

**実装状況:** 完了（`0051d42a`）

**変更内容:**

```tsx
// Before（動かない）
<div className="md:hidden h-full flex flex-col pt-[48px] pb-[56px]">
  <div className="flex-1 min-h-0 flex flex-col">{content}</div>
</div>

// After（動く）
<div className="md:hidden bg-white">
  <div className="pt-[48px] pb-[56px]">{content}</div>
</div>
```

**変更ファイル:**

- `apps/web/components/screens/memo-screen.tsx` (1027行目)
- `apps/web/components/screens/task-screen.tsx` (966行目)

**ポイント:**

- `h-full`, `flex flex-col`, `flex-1`, `min-h-0` を全て削除
- シンプルな padding のみの構造に変更
- PC版（`md:block`）は既存のまま維持（壊さない）

**確認項目:**

- [ ] メモ一覧でスクロール動作するか？
- [ ] タスク一覧でスクロール動作するか？
- [ ] PC版の表示は壊れていないか？
- [ ] メモ・タスク編集画面も正常に動作するか？

**結果:** （ユーザー確認待ち）

---

### 🔲 アプローチ2: h-dvh overflow-hidden flex-col 方式

**方針:** 親を `h-dvh overflow-hidden flex-col` にして、中央を `flex-1 overflow-y-auto` にする

**実装方法:**

```tsx
<div className="h-dvh overflow-hidden flex flex-col">
  <header className="h-12 shrink-0">固定ヘッダー</header>
  <div className="flex-1 overflow-y-auto">
    <ItemGrid>{items}</ItemGrid>
  </div>
  <footer className="h-14 shrink-0 md:hidden">固定フッター</footer>
</div>
```

**期待される効果:**

- 親が viewport 高さで固定される
- 中央だけがスクロール可能になる

**懸念点:**

- 「フッターが伸びる」問題が再発する可能性
- `h-dvh` がモバイルで不安定

**試す条件:** アプローチ1が動かない場合

---

### 🔲 アプローチ3: 100vh 固定 + calc() 方式

**方針:** JavaScript を使わず、CSS だけで高さを計算

**実装方法:**

```tsx
<div className="h-screen overflow-hidden flex flex-col">
  <header className="h-12 shrink-0">固定ヘッダー</header>
  <div
    className="overflow-y-auto"
    style={{ height: "calc(100vh - 48px - 56px)" }}
  >
    <ItemGrid>{items}</ItemGrid>
  </div>
  <footer className="h-14 shrink-0 md:hidden">固定フッター</footer>
</div>
```

**期待される効果:**

- 明示的な高さ指定でスクロール領域を確保
- `flex-1` の計算問題を回避

**懸念点:**

- モバイルブラウザのアドレスバー表示/非表示で高さが変わる

**試す条件:** アプローチ2が動かない場合

---

### 🔲 アプローチ4: JavaScript でスクロール強制

**方針:** CSS で解決できない場合、JS でスクロール領域を強制設定

**実装方法:**

```tsx
useEffect(() => {
  const header = document.querySelector("header");
  const footer = document.querySelector("footer");
  const content = document.querySelector("[data-scroll-content]");

  if (header && footer && content) {
    const headerHeight = header.offsetHeight;
    const footerHeight = footer.offsetHeight;
    const windowHeight = window.innerHeight;

    content.style.height = `${windowHeight - headerHeight - footerHeight}px`;
    content.style.overflowY = "auto";
  }
}, []);
```

**期待される効果:**

- 確実にスクロール領域を確保

**懸念点:**

- リサイズ・画面回転時の対応が必要
- パフォーマンス

**試す条件:** アプローチ3が動かない場合

---

### 🔲 アプローチ5: ネイティブスクロール + IntersectionObserver

**方針:** 固定を諦めて、スクロールに応じてヘッダー・フッターを表示/非表示

**実装方法:**

- ヘッダー・フッターを fixed ではなく通常配置
- スクロール時に `transform: translateY()` で隠す
- iOS Safari のネイティブスクロール挙動に従う

**期待される効果:**

- ブラウザのネイティブ挙動に従うため安定

**懸念点:**

- UX が変わる（ヘッダー・フッターが常に見えるわけではない）

**試す条件:** 他の全てのアプローチが失敗した場合

---

## 参考情報

### Tailwind クラス対応表

- ヘッダー高さ: `h-12` (48px) モバイル / `h-16` (64px) PC
- フッター高さ: `h-14` (56px) モバイル
- テスト用ヘッダー: `h-[70px]`
- テスト用フッター: `h-[60px]`

### 関連ファイル

- `/apps/web/app/test-scroll/page.tsx` - テストページ
- `/apps/web/components/layout/header.tsx` - ヘッダー
- `/apps/web/components/layout/sidebar.tsx` - サイドバー・モバイルフッター
- `/apps/web/components/screens/memo-screen.tsx` - メモ画面
- `/apps/web/components/screens/task-screen.tsx` - タスク画面
- `/apps/web/components/ui/layout/item-grid.tsx` - アイテム表示グリッド
