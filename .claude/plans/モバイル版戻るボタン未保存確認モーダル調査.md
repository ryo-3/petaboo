# モバイル版戻るボタン未保存確認モーダル調査Plan

> ⚠️ Codexに実装依頼する際は、以下を厳守すること：
>
> - **既存ファイルを丸ごと再生成させないこと** → Codexへの依頼は必ず **差分（patch形式）** で行う
> - **日本語コメント・文字列を扱う場合はUTF-8前提で依頼すること** → 文字化け防止のため明記する
> - **Codexに git add / git commit を実行させないこと**
> - **完了した場合ファイルを`.claude/fixed-plans` に移動する**

## 目的

個人・チーム両方のメモ一覧・タスク一覧で、PC版では未保存の変更がある時に閉じようとすると確認モーダルが出るのに、**モバイル版では出ない**問題を調査・修正する。

## 現状の理解

### 既存の仕組み（正常に動作しているはず）

1. **MemoEditor / TaskEditor**
   - `memo-editor-mobile-back-requested` / `task-editor-mobile-back-requested` イベントをリッスン
   - イベント受信時に未保存変更をチェック
   - 未保存変更があれば確認モーダル表示
   - なければ `onClose()` を実行

2. **Sidebar (個人モード)**
   - `ItemEditorFooter` の「戻る」ボタンで `memo-editor-mobile-back-requested` を発火
   - イベント発火場所: `apps/web/components/layout/sidebar.tsx:242`

3. **確認モーダルの実装**
   - MemoEditor: `apps/web/components/features/memo/memo-editor.tsx:1118-1152`
   - 個人モード: `hasUnsavedChanges` をチェック → `setIsCloseConfirmModalOpen(true)`
   - チームモード: `teamDetailContext.memoEditorHasUnsavedChangesRef` をチェック

## 問題の可能性

### 仮説1: イベントが発火していない

- Sidebarが表示されていない
- イベント名が間違っている
- タイミングの問題

### 仮説2: イベントは発火しているが、hasUnsavedChangesがfalse

- 未保存状態の検出が動作していない
- refの更新が反映されていない

### 仮説3: モーダルが表示されているが見えない

- z-indexの問題
- モーダルが画面外に表示されている

### 仮説4: 特定の画面・状態でのみ問題が発生

- メモ一覧 vs タスク一覧
- 新規作成 vs 編集
- 個人モード vs チームモード
- ボード詳細内 vs 通常画面

## 調査手順

### 1. 問題の再現条件を特定

- [ ] 個人のメモ一覧でメモ編集時
- [ ] 個人のタスク一覧でタスク編集時
- [ ] チームのメモ一覧でメモ編集時
- [ ] チームのタスク一覧でタスク編集時
- [ ] ボード詳細内でのメモ/タスク編集時
- [ ] 新規作成時 vs 既存アイテム編集時

### 2. デバッグログ追加

- [ ] Sidebar の onBack にログ追加（イベント発火確認）
- [ ] MemoEditor / TaskEditor のイベントリスナーにログ追加（イベント受信確認）
- [ ] hasUnsavedChanges の値をログ出力
- [ ] モーダル表示フラグをログ出力

### 3. 問題箇所の特定

- [ ] イベントが発火しているか確認
- [ ] イベントが受信されているか確認
- [ ] hasUnsavedChanges が正しく設定されているか確認
- [ ] モーダルが実際に表示されているか確認（DOM確認）

### 4. 修正案の検討

問題箇所に応じて以下のいずれかを実施：

**A. イベントが発火していない場合**

- Sidebar の条件分岐を修正
- イベント名を修正
- Sidebar の表示条件を修正

**B. hasUnsavedChanges が false の場合**

- ref の更新タイミングを修正
- エディターの変更検出ロジックを修正

**C. モーダルが表示されない場合**

- モーダルコンポーネントの z-index を修正
- モーダルの表示条件を修正

## 影響範囲

### 調査対象ファイル

- `apps/web/components/layout/sidebar.tsx` - モバイルフッター「戻る」ボタン
- `apps/web/components/features/memo/memo-editor.tsx` - メモエディターのイベントリスナー
- `apps/web/components/features/task/task-editor.tsx` - タスクエディターのイベントリスナー
- `apps/web/components/screens/memo-screen.tsx` - メモ画面の状態管理
- `apps/web/components/screens/task-screen.tsx` - タスク画面の状態管理

### テスト対象

- 個人のメモ一覧（モバイル表示）
- 個人のタスク一覧（モバイル表示）
- チームのメモ一覧（モバイル表示）
- チームのタスク一覧（モバイル表示）
- ボード詳細内のメモ/タスク編集（モバイル表示）

## 優先度

**高** - モバイル版での重要なUX問題

## 備考

- PC版では正常に動作しているため、PC版の実装を参考にする
- チーム側と個人側で同じ問題があるため、共通の原因の可能性が高い
- まずはデバッグログで問題箇所を特定してから修正を行う
