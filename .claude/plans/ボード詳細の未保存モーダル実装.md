# ãƒœãƒ¼ãƒ‰è©³ç´°ã®æœªä¿å­˜ãƒ¢ãƒ¼ãƒ€ãƒ«å®Ÿè£… Plan

> âš ï¸ Codexã«å®Ÿè£…ä¾é ¼ã™ã‚‹éš›ã¯ã€ä»¥ä¸‹ã‚’å³å®ˆã™ã‚‹ã“ã¨ï¼š
>
> - **æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸¸ã”ã¨å†ç”Ÿæˆã•ã›ãªã„ã“ã¨** â†’ Codexã¸ã®ä¾é ¼ã¯å¿…ãš **å·®åˆ†ï¼ˆpatchå½¢å¼ï¼‰** ã§è¡Œã†
> - **æ—¥æœ¬èªã‚³ãƒ¡ãƒ³ãƒˆãƒ»æ–‡å­—åˆ—ã‚’æ‰±ã†å ´åˆã¯UTF-8å‰æã§ä¾é ¼ã™ã‚‹ã“ã¨** â†’ æ–‡å­—åŒ–ã‘é˜²æ­¢ã®ãŸã‚æ˜è¨˜ã™ã‚‹
> - **Codexã« git add / git commit ã‚’å®Ÿè¡Œã•ã›ãªã„ã“ã¨**
> - **å®Œäº†ã—ãŸå ´åˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’`.claude/fixed-plans` ã«ç§»å‹•ã™ã‚‹**

---

## ğŸ“‹ ç›®çš„

ãƒœãƒ¼ãƒ‰è©³ç´°ç”»é¢ã§ãƒ¡ãƒ¢ãƒ»ã‚¿ã‚¹ã‚¯ã‚’ç·¨é›†ä¸­ã«ã€åˆ¥ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’é¸æŠã—ãŸæ™‚ã«æœªä¿å­˜å¤‰æ›´ã®ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹ã€‚

å€‹äººå´ãƒ¡ãƒ¢ãƒ»ã‚¿ã‚¹ã‚¯ç”»é¢ã§ã¯æ—¢ã«å®Ÿè£…æ¸ˆã¿ã®`use-unsaved-changes-guard`ãƒ•ãƒƒã‚¯ã‚’åˆ©ç”¨ã™ã‚‹ã€‚

---

## ğŸ” ç¾çŠ¶ã®å•é¡Œ

### ãƒœãƒ¼ãƒ‰è©³ç´°ã§ã¯æœªä¿å­˜ãƒã‚§ãƒƒã‚¯ãŒå‹•ä½œã—ãªã„

**å•é¡Œã®æµã‚Œï¼š**

1. ãƒœãƒ¼ãƒ‰è©³ç´°ã§ãƒ¡ãƒ¢Aã‚’ç·¨é›†ä¸­
2. ã‚¿ã‚¤ãƒˆãƒ«ã‚„å†…å®¹ã‚’å¤‰æ›´ï¼ˆæœªä¿å­˜ï¼‰
3. åˆ¥ã®ãƒ¡ãƒ¢Bã‚’ã‚¯ãƒªãƒƒã‚¯
4. **âŒ ç¢ºèªãªã—ã§ãƒ¡ãƒ¢Bã«åˆ‡ã‚Šæ›¿ã‚ã‚‹ â†’ ãƒ¡ãƒ¢Aã®å¤‰æ›´ãŒå¤±ã‚ã‚Œã‚‹**

**æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œï¼š**

1. ãƒœãƒ¼ãƒ‰è©³ç´°ã§ãƒ¡ãƒ¢Aã‚’ç·¨é›†ä¸­
2. ã‚¿ã‚¤ãƒˆãƒ«ã‚„å†…å®¹ã‚’å¤‰æ›´ï¼ˆæœªä¿å­˜ï¼‰
3. åˆ¥ã®ãƒ¡ãƒ¢Bã‚’ã‚¯ãƒªãƒƒã‚¯
4. **âœ… ã€Œæœªä¿å­˜ã®å¤‰æ›´ãŒã‚ã‚Šã¾ã™ã€ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã‚‹**
5. ã€Œç ´æ£„ã€â†’ ãƒ¡ãƒ¢Bã«åˆ‡ã‚Šæ›¿ã‚ã‚‹ / ã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€â†’ ãƒ¡ãƒ¢Aã®ç·¨é›†ç¶™ç¶š

---

## ğŸ¯ å®Ÿè£…æ–¹é‡

### æ—¢å­˜ã®å…±é€šãƒ•ãƒƒã‚¯ã‚’æ´»ç”¨

å€‹äººå´ãƒ¡ãƒ¢ãƒ»ã‚¿ã‚¹ã‚¯ç”»é¢ã§æ—¢ã«å‹•ä½œã—ã¦ã„ã‚‹`use-unsaved-changes-guard`ãƒ•ãƒƒã‚¯ã‚’ãƒœãƒ¼ãƒ‰è©³ç´°ã§ã‚‚ä½¿ç”¨ã™ã‚‹ã€‚

**è©²å½“ãƒ•ã‚¡ã‚¤ãƒ«ï¼š**

- `apps/web/src/hooks/use-unsaved-changes-guard.ts` - æ—¢ã«å®Ÿè£…æ¸ˆã¿
- `apps/web/src/types/unsaved-changes.ts` - å‹å®šç¾©æ¸ˆã¿

---

## ğŸ“ å®Ÿè£…æ‰‹é †

### Step 1: `use-board-operations.ts` ã«æœªä¿å­˜ã‚¬ãƒ¼ãƒ‰æ©Ÿèƒ½ã‚’è¿½åŠ 

**ãƒ•ã‚¡ã‚¤ãƒ«ï¼š** `apps/web/src/hooks/use-board-operations.ts`

#### 1.1 importè¿½åŠ 

```typescript
import { useUnsavedChangesGuard } from "@/src/hooks/use-unsaved-changes-guard";
```

#### 1.2 æœªä¿å­˜ã‚¬ãƒ¼ãƒ‰ãƒ•ãƒƒã‚¯ã®è¿½åŠ 

`useBoardOperations`ãƒ•ãƒƒã‚¯å†…ã«ä»¥ä¸‹ã‚’è¿½åŠ ï¼š

```typescript
// ãƒ¡ãƒ¢ç”¨ã®æœªä¿å­˜ã‚¬ãƒ¼ãƒ‰
const {
  personalHasUnsavedChangesRef: memoHasUnsavedChangesRef,
  personalShowConfirmModalRef: memoShowConfirmModalRef,
  handleSelectWithGuard: handleSelectMemoWithGuard,
} = useUnsavedChangesGuard({
  itemType: "memo",
  teamMode: !!teamId,
  teamDetailContext: undefined, // ãƒœãƒ¼ãƒ‰è©³ç´°ã§ã¯å€‹äººãƒ¢ãƒ¼ãƒ‰ã®ã¿å¯¾å¿œ
  onSelectItem: onSelectMemo,
  setScreenMode: (mode) => {
    if (mode === "view") {
      setRightPanelMode(null);
    }
  },
});

// ã‚¿ã‚¹ã‚¯ç”¨ã®æœªä¿å­˜ã‚¬ãƒ¼ãƒ‰
const {
  personalHasUnsavedChangesRef: taskHasUnsavedChangesRef,
  personalShowConfirmModalRef: taskShowConfirmModalRef,
  handleSelectWithGuard: handleSelectTaskWithGuard,
} = useUnsavedChangesGuard({
  itemType: "task",
  teamMode: !!teamId,
  teamDetailContext: undefined,
  onSelectItem: onSelectTask,
  setScreenMode: (mode) => {
    if (mode === "view") {
      setRightPanelMode(null);
    }
  },
});
```

#### 1.3 handleSelectMemo/Task ã‚’ç½®ãæ›ãˆ

**å¤‰æ›´å‰ï¼š**

```typescript
const handleSelectMemo = useCallback(
  (memo: Memo | DeletedMemo) => {
    console.log("[BoardOperations] handleSelectMemo", {
      memoId: "id" in memo ? memo.id : undefined,
      title: memo?.title,
    });
    setRightPanelMode(null);
    onSelectMemo?.(memo);
  },
  [onSelectMemo, setRightPanelMode],
);

const handleSelectTask = useCallback(
  (task: Task | DeletedTask) => {
    setRightPanelMode(null);
    onSelectTask?.(task);
  },
  [onSelectTask, setRightPanelMode],
);
```

**å¤‰æ›´å¾Œï¼š**

```typescript
// æœªä¿å­˜ã‚¬ãƒ¼ãƒ‰ä»˜ãã®é¸æŠãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’ä½¿ç”¨
const handleSelectMemo = handleSelectMemoWithGuard;
const handleSelectTask = handleSelectTaskWithGuard;
```

#### 1.4 æˆ»ã‚Šå€¤ã«refã‚’è¿½åŠ 

```typescript
return {
  // ... æ—¢å­˜ã®æˆ»ã‚Šå€¤
  memoHasUnsavedChangesRef, // â† è¿½åŠ 
  memoShowConfirmModalRef, // â† è¿½åŠ 
  taskHasUnsavedChangesRef, // â† è¿½åŠ 
  taskShowConfirmModalRef, // â† è¿½åŠ 
};
```

---

### Step 2: `board-detail-screen.tsx` ã§refã‚’å—ã‘å–ã‚‹

**ãƒ•ã‚¡ã‚¤ãƒ«ï¼š** `apps/web/components/screens/board-detail-screen.tsx`

#### 2.1 `useBoardOperations`ã‹ã‚‰è¿½åŠ ã®refã‚’å—ã‘å–ã‚‹

```typescript
const {
  // ... æ—¢å­˜ã®æˆ»ã‚Šå€¤
  memoHasUnsavedChangesRef, // â† è¿½åŠ 
  memoShowConfirmModalRef, // â† è¿½åŠ 
  taskHasUnsavedChangesRef, // â† è¿½åŠ 
  taskShowConfirmModalRef, // â† è¿½åŠ 
} = useBoardOperations({
  // ...
});
```

---

### Step 3: `board-right-panel.tsx` ã§editorã«refã‚’æ¸¡ã™

**ãƒ•ã‚¡ã‚¤ãƒ«ï¼š** `apps/web/components/features/board/board-right-panel.tsx`

#### 3.1 Propsã«è¿½åŠ 

```typescript
interface BoardRightPanelProps {
  // ... æ—¢å­˜ã®props
  memoEditorHasUnsavedChangesRef?: React.MutableRefObject<boolean>; // â† è¿½åŠ 
  memoEditorShowConfirmModalRef?: React.MutableRefObject<(() => void) | null>; // â† è¿½åŠ 
  taskEditorHasUnsavedChangesRef?: React.MutableRefObject<boolean>; // â† è¿½åŠ 
  taskEditorShowConfirmModalRef?: React.MutableRefObject<(() => void) | null>; // â† è¿½åŠ 
}
```

#### 3.2 propsã‹ã‚‰å—ã‘å–ã‚‹

```typescript
export default function BoardRightPanel({
  // ... æ—¢å­˜ã®props
  memoEditorHasUnsavedChangesRef,  // â† è¿½åŠ 
  memoEditorShowConfirmModalRef,   // â† è¿½åŠ 
  taskEditorHasUnsavedChangesRef,  // â† è¿½åŠ 
  taskEditorShowConfirmModalRef,   // â† è¿½åŠ 
}: BoardRightPanelProps) {
```

#### 3.3 MemoEditorã«refã‚’æ¸¡ã™ï¼ˆ4ç®‡æ‰€ï¼‰

`<MemoEditor>` ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå‘¼ã³å‡ºã—ç®‡æ‰€ï¼ˆå‰Šé™¤æ¸ˆã¿ãƒ»é€šå¸¸ã®2ç®‡æ‰€ï¼‰ã«ä»¥ä¸‹ã‚’è¿½åŠ ï¼š

```typescript
<MemoEditor
  // ... æ—¢å­˜ã®props
  memoEditorHasUnsavedChangesRef={memoEditorHasUnsavedChangesRef}  // â† è¿½åŠ 
  memoEditorShowConfirmModalRef={memoEditorShowConfirmModalRef}    // â† è¿½åŠ 
/>
```

#### 3.4 TaskEditorã«refã‚’æ¸¡ã™ï¼ˆ4ç®‡æ‰€ï¼‰

`<TaskEditor>` ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå‘¼ã³å‡ºã—ç®‡æ‰€ï¼ˆå‰Šé™¤æ¸ˆã¿ãƒ»é€šå¸¸ã®2ç®‡æ‰€ï¼‰ã«ä»¥ä¸‹ã‚’è¿½åŠ ï¼š

```typescript
<TaskEditor
  // ... æ—¢å­˜ã®props
  taskEditorHasUnsavedChangesRef={taskEditorHasUnsavedChangesRef}  // â† è¿½åŠ 
  taskEditorShowConfirmModalRef={taskEditorShowConfirmModalRef}    // â† è¿½åŠ 
/>
```

---

### Step 4: `board-detail-screen.tsx` ã‹ã‚‰refã‚’BoardRightPanelã«æ¸¡ã™

**ãƒ•ã‚¡ã‚¤ãƒ«ï¼š** `apps/web/components/screens/board-detail-screen.tsx`

`<BoardRightPanel>` å‘¼ã³å‡ºã—ç®‡æ‰€ã«ä»¥ä¸‹ã‚’è¿½åŠ ï¼š

```typescript
<BoardRightPanel
  // ... æ—¢å­˜ã®props
  memoEditorHasUnsavedChangesRef={memoHasUnsavedChangesRef}  // â† è¿½åŠ 
  memoEditorShowConfirmModalRef={memoShowConfirmModalRef}    // â† è¿½åŠ 
  taskEditorHasUnsavedChangesRef={taskHasUnsavedChangesRef}  // â† è¿½åŠ 
  taskEditorShowConfirmModalRef={taskShowConfirmModalRef}    // â† è¿½åŠ 
/>
```

---

## âœ… å®Œäº†æ¡ä»¶

### å‹•ä½œç¢ºèªé …ç›®

- [ ] ãƒœãƒ¼ãƒ‰è©³ç´°ã§ãƒ¡ãƒ¢ã‚’ç·¨é›†ä¸­ã«åˆ¥ã®ãƒ¡ãƒ¢ã‚’é¸æŠ â†’ ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
- [ ] ãƒœãƒ¼ãƒ‰è©³ç´°ã§ã‚¿ã‚¹ã‚¯ã‚’ç·¨é›†ä¸­ã«åˆ¥ã®ã‚¿ã‚¹ã‚¯ã‚’é¸æŠ â†’ ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
- [ ] ãƒœãƒ¼ãƒ‰è©³ç´°ã§ãƒ¡ãƒ¢ã‚’ç·¨é›†ä¸­ã«åˆ¥ã®ã‚¿ã‚¹ã‚¯ã‚’é¸æŠ â†’ ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
- [ ] ãƒœãƒ¼ãƒ‰è©³ç´°ã§ã‚¿ã‚¹ã‚¯ã‚’ç·¨é›†ä¸­ã«åˆ¥ã®ãƒ¡ãƒ¢ã‚’é¸æŠ â†’ ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
- [ ] ã€Œç ´æ£„ã€é¸æŠæ™‚ã«é¸æŠãŒåˆ‡ã‚Šæ›¿ã‚ã‚‹
- [ ] ã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€é¸æŠæ™‚ã«ç·¨é›†ãŒç¶™ç¶šã•ã‚Œã‚‹
- [ ] æ–°è¦ä½œæˆã§ä½•ã‚‚å…¥åŠ›ã—ã¦ã„ãªã„å ´åˆã¯ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºã•ã‚Œãªã„
- [ ] ã‚¿ã‚¤ãƒˆãƒ«ã¾ãŸã¯ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å…¥åŠ›å¾Œã¯ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºã•ã‚Œã‚‹

### ã‚³ãƒ¼ãƒ‰å“è³ª

- [ ] TypeScriptã‚¨ãƒ©ãƒ¼ãªã—
- [ ] Lintã‚¨ãƒ©ãƒ¼ãªã—
- [ ] å€‹äººå´ãƒ¡ãƒ¢ãƒ»ã‚¿ã‚¹ã‚¯ç”»é¢ã®å‹•ä½œã«å½±éŸ¿ãŒãªã„ã“ã¨

---

## ğŸ¯ æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã®å‘ä¸Š

- æœªä¿å­˜ã®å¤‰æ›´ãŒå¤±ã‚ã‚Œãªããªã‚‹
- ãƒ¡ãƒ¢ãƒ»ã‚¿ã‚¹ã‚¯ç”»é¢ã¨åŒã˜å‹•ä½œã§çµ±ä¸€æ„ŸãŒã‚ã‚‹

### ã‚³ãƒ¼ãƒ‰ã®çµ±ä¸€æ€§

- æ—¢å­˜ã®å…±é€šãƒ•ãƒƒã‚¯ã‚’å†åˆ©ç”¨
- ãƒœãƒ¼ãƒ‰è©³ç´°ã§ã‚‚åŒã˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã§å®Ÿè£…

---

## âš ï¸ æ³¨æ„ç‚¹

### ãƒãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã¯æœªå¯¾å¿œ

ç¾åœ¨ã®å®Ÿè£…ã§ã¯å€‹äººå´ãƒœãƒ¼ãƒ‰è©³ç´°ã®ã¿å¯¾å¿œã€‚ãƒãƒ¼ãƒ å´ã¯å°†æ¥å®Ÿè£…ã€‚

### ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã¨ã®é–¢ä¿‚

ã“ã®å®Ÿè£…ã¯æ—¢å­˜ã®`use-unsaved-changes-guard`ãƒ•ãƒƒã‚¯ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€
å°†æ¥çš„ãªå…±é€šåŒ–ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã®æ©æµã‚’è‡ªå‹•çš„ã«å—ã‘ã‚‰ã‚Œã‚‹ã€‚

---

## ğŸ“š é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

### å®Ÿè£…å¯¾è±¡

- `apps/web/src/hooks/use-board-operations.ts`
- `apps/web/components/screens/board-detail-screen.tsx`
- `apps/web/components/features/board/board-right-panel.tsx`

### å‚è€ƒï¼ˆæ—¢ã«å®Ÿè£…æ¸ˆã¿ï¼‰

- `apps/web/src/hooks/use-unsaved-changes-guard.ts`
- `apps/web/src/types/unsaved-changes.ts`
- `apps/web/components/screens/memo-screen.tsx`
- `apps/web/components/screens/task-screen.tsx`
