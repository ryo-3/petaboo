# ãƒãƒ¼ãƒ å´ãƒœãƒ¼ãƒ‰è©³ç´° - æœªä¿å­˜ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«å®Ÿè£…èª¿æŸ»

**æœ€çµ‚æ›´æ–°æ—¥**: 2025-11-20ï¼ˆå‰Šé™¤ä½œæ¥­è¿½è¨˜ï¼‰

## ğŸ“‹ èª¿æŸ»æ¦‚è¦

ãƒãƒ¼ãƒ å´ã®PCç‰ˆãƒœãƒ¼ãƒ‰è©³ç´°ç”»é¢ã«ãŠã‘ã‚‹ã€ãƒ¡ãƒ¢/ã‚¿ã‚¹ã‚¯ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã®æœªä¿å­˜ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã®å®Ÿè£…çŠ¶æ³ã‚’èª¿æŸ»ã€‚

**çµè«–**: PCç‰ˆã§ã¯æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã‚‹ âœ…

---

## ğŸ” å®Ÿè£…æ§‹é€ 

### 1. æœªä¿å­˜ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã®é…ç½®

**å ´æ‰€**: `apps/web/components/features/memo/memo-editor.tsx:1629-1642`

```typescript
{/* æœªä¿å­˜å¤‰æ›´ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« */}
<ConfirmationModal
  isOpen={isCloseConfirmModalOpen}
  onClose={() => setIsCloseConfirmModalOpen(false)}
  onConfirm={handleConfirmClose}
  title="æœªä¿å­˜ã®å¤‰æ›´ãŒã‚ã‚Šã¾ã™"
  message="ä¿å­˜ã›ãšã«é–‰ã˜ã‚‹ã¨ã€å¤‰æ›´å†…å®¹ãŒå¤±ã‚ã‚Œã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ"
  confirmText="é–‰ã˜ã‚‹"
  cancelText="ã‚­ãƒ£ãƒ³ã‚»ãƒ«"
  variant="warning"
/>
```

### 2. ãƒˆãƒªã‚¬ãƒ¼å‡¦ç†

**å ´æ‰€**: `apps/web/components/features/memo/memo-editor.tsx:1140-1146`

```typescript
// æˆ»ã‚‹ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼ˆæœªä¿å­˜å¤‰æ›´ãƒã‚§ãƒƒã‚¯ï¼‰
const handleCloseClick = useCallback(() => {
  if (hasUnsavedChanges) {
    setIsCloseConfirmModalOpen(true); // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
  } else {
    onClose(); // ç›´æ¥é–‰ã˜ã‚‹
  }
}, [hasUnsavedChanges, onClose]);
```

### 3. ç¢ºèªå¾Œã®å‡¦ç†

**å ´æ‰€**: `apps/web/components/features/memo/memo-editor.tsx:1149-1158`

```typescript
// ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã§ã€Œé–‰ã˜ã‚‹ã€ã‚’é¸æŠ
const handleConfirmClose = useCallback(() => {
  setIsCloseConfirmModalOpen(false);
  // ç ´æ£„ãŒé¸æŠã•ã‚ŒãŸã“ã¨ã‚’é€šçŸ¥ï¼ˆä¿ç•™ä¸­ã®é¸æŠã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ï¼‰
  dispatchDiscardEvent("memo");
  // ä¿ç•™ä¸­ã®é¸æŠãŒãªã„å ´åˆï¼ˆæˆ»ã‚‹ãƒœã‚¿ãƒ³ã®å ´åˆï¼‰ã¯onCloseã‚’å‘¼ã¶
  // å°‘ã—é…å»¶ã•ã›ã¦dispatchDiscardEventãŒå‡¦ç†ã•ã‚Œã‚‹ã®ã‚’å¾…ã¤
  setTimeout(() => {
    onClose();
  }, 50);
}, [onClose]);
```

---

## ğŸ“‚ é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

### ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

- **MemoEditor**: `apps/web/components/features/memo/memo-editor.tsx`
- **TaskEditor**: `apps/web/components/features/task/task-editor.tsx`

### ç”»é¢ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

- **BoardDetailScreen3Panel**: `apps/web/components/screens/board-detail-screen-3panel.tsx`
- **TeamBoardDetailWrapper**: `apps/web/components/features/team/team-board-detail-wrapper.tsx`

### å…±é€šãƒ­ã‚¸ãƒƒã‚¯

- **useUnsavedChangesGuard**: `apps/web/src/hooks/use-unsaved-changes-guard.ts`
- **useBoardOperations**: `apps/web/src/hooks/use-board-operations.ts`
- **TeamDetailContext**: `apps/web/src/contexts/team-detail-context.tsx`

### ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

- **ConfirmationModal**: `apps/web/components/ui/modals/confirmation-modal.tsx`

### å‹å®šç¾©

- **unsaved-changes**: `apps/web/src/types/unsaved-changes.ts`

---

## ğŸ”„ å‹•ä½œãƒ•ãƒ­ãƒ¼ï¼ˆPCç‰ˆï¼‰

### A. ã€Œé–‰ã˜ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆ

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã®ã€Œé–‰ã˜ã‚‹ã€ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
  â†“
handleCloseClick å®Ÿè¡Œ
  â†“
hasUnsavedChanges ã‚’ãƒã‚§ãƒƒã‚¯
  â”œâ”€ true ã®å ´åˆ
  â”‚   â†“
  â”‚  setIsCloseConfirmModalOpen(true)
  â”‚   â†“
  â”‚  ConfirmationModal è¡¨ç¤º
  â”‚   â”œâ”€ã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€â†’ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
  â”‚   â””â”€ã€Œé–‰ã˜ã‚‹ã€
  â”‚       â†“
  â”‚      handleConfirmClose å®Ÿè¡Œ
  â”‚       â†“
  â”‚      dispatchDiscardEvent("memo") ç™ºç«
  â”‚       â†“
  â”‚      setTimeout(() => onClose(), 50)
  â”‚       â†“
  â”‚      onClearSelection() å®Ÿè¡Œï¼ˆè¦ªã‹ã‚‰æ¸¡ã•ã‚ŒãŸï¼‰
  â”‚       â†“
  â”‚      é¸æŠè§£é™¤ãƒ»URLæ›´æ–°
  â”‚
  â””â”€ false ã®å ´åˆ
      â†“
     onClose() ã‚’ç›´æ¥å®Ÿè¡Œ
```

### B. åˆ¥ã®ãƒ¡ãƒ¢/ã‚¿ã‚¹ã‚¯ã‚’é¸æŠã—ãŸå ´åˆ

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåˆ¥ã®ãƒ¡ãƒ¢ã‚’ã‚¯ãƒªãƒƒã‚¯
  â†“
handleSelectMemo (use-board-operations.ts:266)
  â†“
handleSelectMemoWithGuard (use-unsaved-changes-guard.ts)
  â†“
getRefs() ã§ TeamDetailContext ã‹ã‚‰ ref ã‚’å–å¾—
  â†“
memoEditorHasUnsavedChangesRef.current ã‚’ãƒã‚§ãƒƒã‚¯
  â”œâ”€ true ã®å ´åˆ
  â”‚   â†“
  â”‚  pendingSelectionRef.current = æ–°ã—ã„ãƒ¡ãƒ¢ï¼ˆä¿ç•™ï¼‰
  â”‚   â†“
  â”‚  memoEditorShowConfirmModalRef.current() å®Ÿè¡Œ
  â”‚   â†“
  â”‚  setIsCloseConfirmModalOpen(true)
  â”‚   â†“
  â”‚  ConfirmationModal è¡¨ç¤º
  â”‚   â””â”€ã€Œé–‰ã˜ã‚‹ã€
  â”‚       â†“
  â”‚      handleConfirmClose å®Ÿè¡Œ
  â”‚       â†“
  â”‚      dispatchDiscardEvent("memo") ç™ºç«
  â”‚       â†“
  â”‚      useUnsavedChangesGuard ã® useEffect ãŒã‚­ãƒ£ãƒƒãƒ
  â”‚       â†“
  â”‚      pendingSelectionRef ã®å€¤ã§ onSelectItem(æ–°ã—ã„ãƒ¡ãƒ¢) å®Ÿè¡Œ
  â”‚       â†“
  â”‚      æ–°ã—ã„ãƒ¡ãƒ¢ãŒé¸æŠã•ã‚Œã‚‹
  â”‚
  â””â”€ false ã®å ´åˆ
      â†“
     onSelectItem(æ–°ã—ã„ãƒ¡ãƒ¢) ã‚’ç›´æ¥å®Ÿè¡Œ
```

---

## ğŸ§© æœªä¿å­˜å¤‰æ›´ã‚¬ãƒ¼ãƒ‰ã‚·ã‚¹ãƒ†ãƒ 

### use-unsaved-changes-guard.ts ã®å½¹å‰²

**ç›®çš„**: ãƒãƒ¼ãƒ /å€‹äººãƒ¢ãƒ¼ãƒ‰ã®ä¸¡æ–¹ã§ã€æœªä¿å­˜å¤‰æ›´ãŒã‚ã‚‹å ´åˆã«ã‚¢ã‚¤ãƒ†ãƒ é¸æŠã‚’ã‚¬ãƒ¼ãƒ‰ã™ã‚‹

**ä¸»è¦æ©Ÿèƒ½**:

1. **Refç®¡ç†**: ãƒãƒ¼ãƒ /å€‹äººãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ã¦é©åˆ‡ãª ref ã‚’è¿”ã™
2. **é¸æŠã‚¬ãƒ¼ãƒ‰**: æœªä¿å­˜å¤‰æ›´ãŒã‚ã‚‹å ´åˆã€é¸æŠã‚’ä¿ç•™ã—ã¦ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
3. **ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼**: `dispatchDiscardEvent` ã‚’ã‚­ãƒ£ãƒƒãƒã—ã¦ä¿ç•™ä¸­ã®é¸æŠã‚’å®Ÿè¡Œ

### TeamDetailContext ã«ã‚ˆã‚‹çŠ¶æ…‹å…±æœ‰

**å ´æ‰€**: `apps/web/src/contexts/team-detail-context.tsx:23-27`

```typescript
// ãƒ¡ãƒ¢ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã®æœªä¿å­˜å¤‰æ›´çŠ¶æ…‹ã¨ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºé–¢æ•°
memoEditorHasUnsavedChangesRef: React.MutableRefObject<boolean>;
memoEditorShowConfirmModalRef: React.MutableRefObject<(() => void) | null>;
// ã‚¿ã‚¹ã‚¯ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã®æœªä¿å­˜å¤‰æ›´çŠ¶æ…‹ã¨ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºé–¢æ•°
taskEditorHasUnsavedChangesRef: React.MutableRefObject<boolean>;
taskEditorShowConfirmModalRef: React.MutableRefObject<(() => void) | null>;
```

**ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼å´ã§ã®è¨­å®š** (`memo-editor.tsx:1088-1096`):

```typescript
// ãƒãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€Contextã«æœ€æ–°ã®çŠ¶æ…‹ã‚’åæ˜ 
useEffect(() => {
  if (teamMode && teamDetailContext) {
    teamDetailContext.memoEditorHasUnsavedChangesRef.current =
      hasUnsavedChanges;
    teamDetailContext.memoEditorShowConfirmModalRef.current = () => {
      setIsCloseConfirmModalOpen(true);
    };
  }
}, [hasUnsavedChanges, teamMode, teamDetailContext]);
```

---

## ğŸ¯ use-board-operations.ts ã§ã®æ´»ç”¨

**å ´æ‰€**: `apps/web/src/hooks/use-board-operations.ts:231-267`

```typescript
// æœªä¿å­˜å¤‰æ›´ã‚¬ãƒ¼ãƒ‰ï¼ˆãƒ¡ãƒ¢ç”¨ï¼‰
const {
  personalHasUnsavedChangesRef: memoHasUnsavedChangesRef,
  personalShowConfirmModalRef: memoShowConfirmModalRef,
  handleSelectWithGuard: handleSelectMemoWithGuard,
} = useUnsavedChangesGuard<Memo | DeletedMemo>({
  itemType: "memo",
  teamMode: isTeamMode,
  teamDetailContext: teamDetailContext,
  onSelectItem: onSelectMemo || (() => {}),
  setScreenMode: (mode) => {
    if (mode === "view") {
      setRightPanelMode(null);
    }
  },
});

// é¸æŠãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼ˆæœªä¿å­˜ã‚¬ãƒ¼ãƒ‰ä»˜ãï¼‰
const handleSelectMemo = handleSelectMemoWithGuard;

// é–‰ã˜ã‚‹å‡¦ç†ï¼ˆã‚¬ãƒ¼ãƒ‰ç„¡ã—ï¼‰
const handleCloseDetail = useCallback(() => {
  onClearSelection?.();
}, [onClearSelection]);
```

**é‡è¦**: `handleCloseDetail` ã¯æœªä¿å­˜ã‚¬ãƒ¼ãƒ‰ã‚’é€šã•ãªã„ãŒã€ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼è‡ªèº«ã® `handleCloseClick` ã§æœªä¿å­˜ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã£ã¦ã„ã‚‹ãŸã‚å•é¡Œãªã—ã€‚

---

## âœ… PCç‰ˆã®å‹•ä½œçŠ¶æ³

### æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã‚‹ã‚±ãƒ¼ã‚¹

1. âœ… **ã€Œé–‰ã˜ã‚‹ã€ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚**
   - æœªä¿å­˜å¤‰æ›´ãŒã‚ã‚‹å ´åˆã€ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã‚‹
   - ã€Œé–‰ã˜ã‚‹ã€é¸æŠã§ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ãŒé–‰ã˜ã‚‹

2. âœ… **åˆ¥ã®ãƒ¡ãƒ¢/ã‚¿ã‚¹ã‚¯ã‚’é¸æŠã—ãŸæ™‚**
   - æœªä¿å­˜å¤‰æ›´ãŒã‚ã‚‹å ´åˆã€ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã‚‹
   - ã€Œé–‰ã˜ã‚‹ã€é¸æŠã§æ–°ã—ã„ã‚¢ã‚¤ãƒ†ãƒ ãŒé¸æŠã•ã‚Œã‚‹

3. âœ… **æ–°è¦ä½œæˆä¸­ã®åˆ‡ã‚Šæ›¿ãˆ**
   - æ–°è¦ãƒ¡ãƒ¢ä½œæˆä¸­ã«åˆ¥ã®ãƒ¡ãƒ¢ã‚’é¸æŠã—ã‚ˆã†ã¨ã—ãŸå ´åˆã‚‚é©åˆ‡ã«ã‚¬ãƒ¼ãƒ‰

### æœªä¿å­˜å¤‰æ›´ã®åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯

**å ´æ‰€**: `memo-editor.tsx` å†…

```typescript
// æœªä¿å­˜å¤‰æ›´ã®åˆ¤å®š
const hasUnsavedChanges =
  hasChanges || // ã‚¿ã‚¤ãƒˆãƒ«ãƒ»å†…å®¹ã®å¤‰æ›´
  pendingBoardChanges; // ãƒœãƒ¼ãƒ‰é¸æŠã®å¤‰æ›´
```

---

## ğŸ“ ã¾ã¨ã‚

### å®Ÿè£…ã®ç‰¹å¾´

1. **äºŒæ®µæ§‹ãˆ**:
   - ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼è‡ªèº«ãŒã€Œé–‰ã˜ã‚‹ã€ãƒœã‚¿ãƒ³ç”¨ã®ç¢ºèªæ©Ÿèƒ½ã‚’æŒã¤
   - `useUnsavedChangesGuard` ãŒã‚¢ã‚¤ãƒ†ãƒ é¸æŠæ™‚ã®ç¢ºèªã‚’æä¾›

2. **Context ã«ã‚ˆã‚‹çŠ¶æ…‹å…±æœ‰**:
   - TeamDetailContext ã§æœªä¿å­˜çŠ¶æ…‹ã‚’å…±æœ‰
   - è¤‡æ•°ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‹ã‚‰å‚ç…§å¯èƒ½

3. **ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•**:
   - `dispatchDiscardEvent` ã§ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆé–“é€šä¿¡
   - ä¿ç•™ä¸­ã®é¸æŠã‚’éåŒæœŸã§å®Ÿè¡Œ

4. **ãƒãƒ¼ãƒ /å€‹äººãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ**:
   - `useUnsavedChangesGuard` ãŒä¸¡ãƒ¢ãƒ¼ãƒ‰ã«å¯¾å¿œ
   - åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ã‚’å…±æœ‰

### PCç‰ˆã®å®Œæˆåº¦

**ç¾çŠ¶**: âœ… å®Œå…¨ã«å‹•ä½œã—ã¦ã„ã‚‹

- æœªä¿å­˜ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé©åˆ‡ã«è¡¨ç¤ºã•ã‚Œã‚‹
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é¸æŠï¼ˆã€Œé–‰ã˜ã‚‹ã€/ã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ï¼‰ãŒæ­£ã—ãå‡¦ç†ã•ã‚Œã‚‹
- çŠ¶æ…‹ç®¡ç†ãŒé©åˆ‡ã«è¡Œã‚ã‚Œã¦ã„ã‚‹

---

---

## ğŸ—‘ï¸ ãƒ¢ãƒã‚¤ãƒ«ç‰ˆæœªå®Ÿè£…ã‚³ãƒ¼ãƒ‰ã®å‰Šé™¤ä½œæ¥­

**å®Ÿæ–½æ—¥**: 2025-11-20

### å•é¡Œã®èƒŒæ™¯

ãƒ¢ãƒã‚¤ãƒ«ç‰ˆã§ã¯ã€ã‚µã‚¤ãƒ‰ãƒãƒ¼ãŒãƒ•ãƒƒã‚¿ãƒ¼ã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã€æˆ»ã‚‹ãƒœã‚¿ãƒ³ã‚‚ãã“ã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã€‚PCç‰ˆã§ã¯ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼å†…ã«é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ãŒã‚ã‚‹ãŸã‚ã‚¹ãƒ ãƒ¼ã‚ºã«æœªä¿å­˜ç¢ºèªãŒã§ãã‚‹ãŒã€ãƒ¢ãƒã‚¤ãƒ«ã§ã¯ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®éšå±¤ãŒé•ã„ã™ãã¦ã€ä»¥ä¸‹ã®å•é¡ŒãŒç™ºç”Ÿã—ã¦ã„ãŸï¼š

- å¤‰æ›´ã®æ¤œçŸ¥ãŒã†ã¾ãã„ã‹ãªã„
- Propsã®å—ã‘æ¸¡ã—ãŒè¤‡é›‘
- Contextã®ç®¡ç†ã‚‚å›°é›£
- **ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å‡ºã™å‰ã«é–‰ã˜ã¦ã—ã¾ã†**

ãã®è©¦è¡ŒéŒ¯èª¤ã®ç—•è·¡ãŒæ®‹ã£ã¦ã„ãŸãŸã‚ã€ä¸€æ—¦å…¨ã¦å‰Šé™¤ã™ã‚‹ã“ã¨ã«ã—ãŸã€‚

### å‰Šé™¤ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã¨å†…å®¹

#### 1. board-detail-screen.tsx (684-717è¡Œç›®)

```typescript
// âŒ å‰Šé™¤ã—ãŸã‚³ãƒ¼ãƒ‰
const [isMobileCloseConfirmOpen, setIsMobileCloseConfirmOpen] = useState(false);
const memoEditorHasUnsavedChangesRef = useRef(false);
const { mobileBackHandlerRef } = useNavigation();

const handleCloseDetailRef = useRef(handleCloseDetail);
useEffect(() => {
  handleCloseDetailRef.current = handleCloseDetail;
}, [handleCloseDetail]);

// ãƒ¢ãƒã‚¤ãƒ«æˆ»ã‚‹ãƒœã‚¿ãƒ³ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼ˆBoardDetailScreenå´ã§ç™»éŒ²ï¼‰
useEffect(() => {
  if (!isMobile || !selectedMemo) {
    mobileBackHandlerRef.current = null;
    return;
  }

  const handleMobileBack = () => {
    if (memoEditorHasUnsavedChangesRef.current) {
      setIsMobileCloseConfirmOpen(true);
    } else {
      handleCloseDetailRef.current();
    }
  };

  mobileBackHandlerRef.current = handleMobileBack;

  return () => {
    mobileBackHandlerRef.current = null;
  };
}, [isMobile, selectedMemo, mobileBackHandlerRef]);
```

```typescript
// âŒ å‰Šé™¤ã—ãŸãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã¦ã„ãªã‹ã£ãŸï¼‰
<ConfirmationModal
  isOpen={isMobileCloseConfirmOpen}
  onClose={() => setIsMobileCloseConfirmOpen(false)}
  onConfirm={() => {
    setIsMobileCloseConfirmOpen(false);
    handleCloseDetailRef.current();
  }}
  title="æœªä¿å­˜ã®å¤‰æ›´ãŒã‚ã‚Šã¾ã™"
  message="ç·¨é›†ä¸­ã®å†…å®¹ãŒä¿å­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç ´æ£„ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ"
  confirmText="ç ´æ£„ã—ã¦é–‰ã˜ã‚‹"
  cancelText="ç·¨é›†ã«æˆ»ã‚‹"
  variant="warning"
  icon="warning"
/>
```

- âŒ `ConfirmationModal` ã®importå‰Šé™¤
- âŒ `useNavigation` ã®importå‰Šé™¤
- âŒ MemoScreenã¸ã®æœªä½¿ç”¨refã®propså‰Šé™¤

**å•é¡Œç‚¹**: ãƒ¢ãƒ¼ãƒ€ãƒ«è‡ªä½“ãŒãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã¦ãŠã‚‰ãšã€`memoEditorHasUnsavedChangesRef`ãŒMemoEditorã«æ¸¡ã•ã‚Œã¦ã„ãªã„ãŸã‚ã€å®Œå…¨ã«å‹•ä½œã—ã¦ã„ãªã‹ã£ãŸã€‚

#### 2. team-detail.tsx (514-522è¡Œç›®)

```typescript
// âŒ å‰Šé™¤ã—ãŸã‚³ãƒ¼ãƒ‰
const handleBackToTaskList = (_event: CustomEvent) => {
  // æœªä¿å­˜å¤‰æ›´ãŒã‚ã‚‹å ´åˆã¯ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
  if (
    taskEditorHasUnsavedChangesRef.current &&
    taskEditorShowConfirmModalRef.current
  ) {
    taskEditorShowConfirmModalRef.current();
    return;
  }

  // ã‚¿ã‚¹ã‚¯ã®é¸æŠã‚’è§£é™¤ã—ã¦ã‚¿ã‚¹ã‚¯ä¸€è¦§ã«æˆ»ã‚‹
  // ...
};
```

**å•é¡Œç‚¹**: TaskEditorãŒ`mobileBackHandlerRef`ã‚’ä½¿ã£ã¦ã„ãªã„ãŸã‚å‹•ä½œã›ãšã€`handleBackToMemoList`ã«ã¯æœªä¿å­˜ç¢ºèªãŒç„¡ãä¸æ•´åˆã ã£ãŸã€‚

#### 3. memo-editor.tsx (1108-1131è¡Œç›®)

```typescript
// âŒ å‰Šé™¤ã—ãŸã‚³ãƒ¼ãƒ‰
// ãƒ¢ãƒã‚¤ãƒ«ãƒ•ãƒƒã‚¿ãƒ¼æˆ»ã‚‹ãƒœã‚¿ãƒ³ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼ˆrefçµŒç”±ãƒ»è¶…ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰
// æ³¨æ„: memoEditorHasUnsavedChangesRefãŒæ¸¡ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯è¦ªãŒç®¡ç†ã™ã‚‹ãŸã‚ç™»éŒ²ã—ãªã„
useEffect(() => {
  // è¦ªãŒç®¡ç†ã™ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
  if (memoEditorHasUnsavedChangesRef) {
    return;
  }

  const handleMobileBack = () => {
    const currentHasUnsavedChanges = hasUnsavedChangesRef.current;

    if (currentHasUnsavedChanges) {
      setIsCloseConfirmModalOpen(true);
    } else {
      onCloseRef.current();
    }
  };

  mobileBackHandlerRef.current = handleMobileBack;

  return () => {
    mobileBackHandlerRef.current = null;
  };
}, [memoEditorHasUnsavedChangesRef]);
```

- âŒ `mobileBackHandlerRef` ã®å–å¾—å‰Šé™¤
- âŒ `showingBoardDetail` ã®å–å¾—å‰Šé™¤ï¼ˆæœªä½¿ç”¨ï¼‰
- âŒ `useNavigation` ã®importå‰Šé™¤

**å•é¡Œç‚¹**: å€‹äººå´å°‚ç”¨ã®å®Ÿè£…ã ã£ãŸãŒå‹•ä½œã—ã¦ãŠã‚‰ãšã€ãƒãƒ¼ãƒ å´ã§ã¯åˆ¥ã®ä»•çµ„ã¿ï¼ˆTeamDetailContextï¼‰ã‚’ä½¿ç”¨ã—ã¦ã„ãŸã€‚

#### 4. navigation-context.tsx

```typescript
// âŒ å‰Šé™¤ã—ãŸå‹å®šç¾©
interface NavigationContextType {
  // ...
  mobileBackHandlerRef: React.MutableRefObject<(() => void) | null>; // âŒ å‰Šé™¤
}
```

```typescript
// âŒ å‰Šé™¤ã—ãŸrefä½œæˆ
const mobileBackHandlerRef = useRef<(() => void) | null>(null);
```

```typescript
// âŒ å‰Šé™¤ã—ãŸProviderå€¤
<NavigationContext.Provider
  value={{
    // ...
    mobileBackHandlerRef, // âŒ å‰Šé™¤
  }}
>
```

- âŒ ä¸è¦ãª `useRef` ã®importå‰Šé™¤

#### 5. sidebar.tsx (240-252è¡Œç›®)

```typescript
// âŒ å‰Šé™¤ã—ãŸã‚³ãƒ¼ãƒ‰
onBack={() => {
  // ãƒãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯ãƒ¡ãƒ¢ä¸€è¦§ã«æˆ»ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«
  if (isTeamMode) {
    window.dispatchEvent(new CustomEvent("team-back-to-memo-list"));
  } else {
    // å€‹äººãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯refã‹ã‚‰ç›´æ¥ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’å‘¼ã¶
    if (mobileBackHandlerRef.current) {
      mobileBackHandlerRef.current();
    }
  }
}}
```

```typescript
// âœ… ä¿®æ­£å¾Œï¼ˆTODOã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ ï¼‰
onBack={() => {
  // ãƒãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯ãƒ¡ãƒ¢ä¸€è¦§ã«æˆ»ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«
  if (isTeamMode) {
    window.dispatchEvent(new CustomEvent("team-back-to-memo-list"));
  }
  // TODO: å€‹äººãƒ¢ãƒ¼ãƒ‰ã®æˆ»ã‚‹ãƒœã‚¿ãƒ³å‡¦ç†ï¼ˆæœªå®Ÿè£…ï¼‰
}}
```

- âŒ `mobileBackHandlerRef` ã®å–å¾—å‰Šé™¤

### å‰Šé™¤çµæœ

- TypeScriptã‚¨ãƒ©ãƒ¼: **0ä»¶** âœ…
- Lintã‚¨ãƒ©ãƒ¼: **0ä»¶** âœ…
- ãƒ¢ãƒã‚¤ãƒ«é–¢é€£ã®æœªä½¿ç”¨ã‚³ãƒ¼ãƒ‰: **å®Œå…¨å‰Šé™¤** âœ…

### æ®‹ã£ã¦ã„ã‚‹ã‚‚ã®

1. **PCç‰ˆã®æœªä¿å­˜ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«**: æ­£å¸¸å‹•ä½œä¸­ âœ…
2. **ãƒãƒ¼ãƒ å´ã®ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•å‡¦ç†**: `team-back-to-memo-list` ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆæ­£å¸¸å‹•ä½œï¼‰âœ…
3. **å€‹äººå´ãƒ¢ãƒã‚¤ãƒ«ã®æˆ»ã‚‹ãƒœã‚¿ãƒ³**: TODOã‚³ãƒ¡ãƒ³ãƒˆã®ã¿ï¼ˆæœªå®Ÿè£…ï¼‰

### ä»Šå¾Œã®æ–¹é‡

ãƒ¢ãƒã‚¤ãƒ«ç‰ˆã®æœªä¿å­˜ç¢ºèªæ©Ÿèƒ½ã¯ã€PCç‰ˆã¨åŒã˜ä»•çµ„ã¿ã§ã¯å®Ÿè£…ãŒå›°é›£ã§ã‚ã‚‹ã“ã¨ãŒåˆ¤æ˜ã€‚ãƒ•ãƒƒã‚¿ãƒ¼ã®éšå±¤æ§‹é€ ã‚’è€ƒæ…®ã—ãŸæ–°ã—ã„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒãŒå¿…è¦ã€‚

---

## ğŸ”œ ä»Šå¾Œã®èª²é¡Œï¼ˆãƒ¢ãƒã‚¤ãƒ«ç‰ˆï¼‰

â€»ãƒ¢ãƒã‚¤ãƒ«ç‰ˆã§ã¯é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã®å®Ÿè£…ãŒç•°ãªã‚‹ãŸã‚ã€åˆ¥é€”å¯¾å¿œãŒå¿…è¦

**æ¤œè¨ã™ã¹ãã‚¢ãƒ—ãƒ­ãƒ¼ãƒ**:

1. ãƒ•ãƒƒã‚¿ãƒ¼è‡ªä½“ã‚’ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã®å­ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«ã™ã‚‹
2. ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªã‚¤ãƒ™ãƒ³ãƒˆãƒ™ãƒ¼ã‚¹ã®ç¢ºèªã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰
3. ãƒ¢ãƒã‚¤ãƒ«ç‰ˆã§ã¯æœªä¿å­˜ç¢ºèªã‚’è¡Œã‚ãªã„ï¼ˆè‡ªå‹•ä¿å­˜ã®ã¿ï¼‰

---

## å‚è€ƒãƒªãƒ³ã‚¯

- [å€‹äººå´ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°-ãƒãƒ¼ãƒ å´çµ±ä¸€è¨ˆç”».md](./å€‹äººå´ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°-ãƒãƒ¼ãƒ å´çµ±ä¸€è¨ˆç”».md)
- ConfirmationModal: `apps/web/components/ui/modals/confirmation-modal.tsx`
