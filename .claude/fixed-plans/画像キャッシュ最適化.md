# ç”»åƒã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ€é©åŒ–

> âš ï¸ Codexã«å®Ÿè£…ä¾é ¼ã™ã‚‹éš›ã¯ã€ä»¥ä¸‹ã‚’å³å®ˆã™ã‚‹ã“ã¨ï¼š
>
> - **æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸¸ã”ã¨å†ç”Ÿæˆã•ã›ãªã„ã“ã¨** â†’ Codexã¸ã®ä¾é ¼ã¯å¿…ãš **å·®åˆ†ï¼ˆpatchå½¢å¼ï¼‰** ã§è¡Œã†
> - **æ—¥æœ¬èªã‚³ãƒ¡ãƒ³ãƒˆãƒ»æ–‡å­—åˆ—ã‚’æ‰±ã†å ´åˆã¯UTF-8å‰æã§ä¾é ¼ã™ã‚‹ã“ã¨** â†’ æ–‡å­—åŒ–ã‘é˜²æ­¢ã®ãŸã‚æ˜è¨˜ã™ã‚‹
> - **Codexã« git add / git commit ã‚’å®Ÿè¡Œã•ã›ãªã„ã“ã¨**
> - **å®Œäº†ã—ãŸå ´åˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’`.claude/fixed-plans` ã«ç§»å‹•ã™ã‚‹**

## ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ğŸ“‹ è¨ˆç”»ä¸­

## å•é¡Œ

ã‚«ãƒ¼ãƒ‰ä¸€è¦§è¡¨ç¤ºæ™‚ã«ã€æ·»ä»˜ç”»åƒãŒæ¯å›APIã‹ã‚‰å–å¾—ã•ã‚Œã‚‹ã€‚

```
[wrangler:info] GET /attachments/personal/image/12 200 OK (45ms)
[wrangler:info] GET /attachments/personal/image/10 200 OK (61ms)
[wrangler:info] GET /attachments/personal/image/9 200 OK (45ms)
...
```

ãƒšãƒ¼ã‚¸é·ç§»ã‚„ã‚¿ãƒ–åˆ‡æ›¿ã®ãŸã³ã«åŒã˜ç”»åƒã‚’ä½•åº¦ã‚‚å–å¾—ã—ã¦ã—ã¾ã†ã€‚

---

## åŸå› 

`use-authenticated-image.ts` ã§ `useEffect + fetch` ã‚’ä½¿ã£ã¦ç”»åƒã‚’å–å¾—ã—ã¦ã„ã‚‹ãŸã‚ã€
ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒãƒã‚¦ãƒ³ãƒˆã•ã‚Œã‚‹ãŸã³ã«æ¯å›fetchãŒèµ°ã‚‹ã€‚

```typescript
// ç¾çŠ¶: useEffect + fetchï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã—ï¼‰
useEffect(() => {
  const loadImage = async () => {
    const response = await fetch(imageUrl, { ... });
    const blob = await response.blob();
    setBlobUrl(URL.createObjectURL(blob));
  };
  loadImage();
}, [imageUrl]);
```

---

## è§£æ±ºç­–

`useQuery` ã«å¤‰æ›ã—ã¦ `staleTime: Infinity` ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹ã€‚

```typescript
// ä¿®æ­£å¾Œ: useQueryï¼ˆæ°¸ç¶šã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
import { useQuery } from "@tanstack/react-query";

export function useAuthenticatedImage(imageUrl: string | undefined) {
  const { getToken } = useAuth();

  const { data: blobUrl, isLoading } = useQuery({
    queryKey: ["authenticated-image", imageUrl],
    queryFn: async () => {
      const token = await getToken();
      const response = await fetch(imageUrl!, {
        headers: token ? { Authorization: `Bearer ${token}` } : {},
      });
      if (!response.ok) {
        throw new Error("ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ");
      }
      const blob = await response.blob();
      return URL.createObjectURL(blob);
    },
    enabled: !!imageUrl,
    staleTime: Infinity, // æ°¸ç¶šã‚­ãƒ£ãƒƒã‚·ãƒ¥
    cacheTime: 30 * 60 * 1000, // 30åˆ†ä¿æŒ
    refetchOnMount: false,
    refetchOnWindowFocus: false,
  });

  return { blobUrl: blobUrl ?? null, isLoading };
}
```

---

## ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«

| ãƒ•ã‚¡ã‚¤ãƒ«                                        | å¤‰æ›´å†…å®¹                    |
| ----------------------------------------------- | --------------------------- |
| `apps/web/src/hooks/use-authenticated-image.ts` | useEffect â†’ useQuery ã«å¤‰æ› |

---

## æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ

| é …ç›®         | Before       | After                |
| ------------ | ------------ | -------------------- |
| ç”»åƒå–å¾—API  | æ¯å›å‘¼ã°ã‚Œã‚‹ | åˆå›ã®ã¿             |
| ãƒšãƒ¼ã‚¸é·ç§»æ™‚ | å…¨ç”»åƒå†å–å¾— | ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å³è¡¨ç¤º |

---

## æ³¨æ„äº‹é …

1. **BlobURLã®ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯å¯¾ç­–**
   - React Queryã® `cacheTime` ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒç ´æ£„ã•ã‚Œã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§BlobURLã‚’è§£æ”¾ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã‹ç¢ºèª
   - å¿…è¦ãªã‚‰ `onSuccess` ã‚„åˆ¥é€”ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å‡¦ç†ã‚’è¿½åŠ 

2. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**
   - ç¾çŠ¶ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’ç¶­æŒ

3. **æ—¢å­˜ã®ä½¿ç”¨ç®‡æ‰€**
   - `item-card.tsx` ã§ä½¿ç”¨ä¸­
   - ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼ˆ`{ blobUrl, isLoading }`ï¼‰ã¯ç¶­æŒ

---

## ãƒ†ã‚¹ãƒˆé …ç›®

- [ ] ã‚«ãƒ¼ãƒ‰ä¸€è¦§è¡¨ç¤º â†’ ç”»åƒãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ãƒšãƒ¼ã‚¸é·ç§» â†’ ç”»åƒãŒå†å–å¾—ã•ã‚Œãªã„ï¼ˆNetworkç¢ºèªï¼‰
- [ ] æ–°è¦ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ â†’ æ–°ç”»åƒãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] é•·æ™‚é–“æ”¾ç½®å¾Œ â†’ ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœŸé™åˆ‡ã‚Œã§å†å–å¾—ã•ã‚Œã‚‹
