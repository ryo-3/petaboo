# ボード削除機能が壊れやすい原因と解決策

**最終更新日**: 2025-11-06

## 問題の概要

ボード詳細画面の削除機能は**マージのたびに壊れやすい**状況にあり、過去に何度も修正が繰り返されている。

## 壊れやすい根本原因

### 1. **ボード専用の独自実装 (`use-bulk-delete-operations.tsx`)**

メモ一覧・タスク一覧は `useBulkDeleteUnified` という統一されたフックを使っているが、**ボード詳細だけが独自の `useBulkDeleteOperations` を使用**している。

#### 問題点

- **独自のタブ判定ロジック**（273-310行目）

  ```tsx
  if (activeMemoTab === "deleted") {
    const deletedMemo = boardDeletedItems?.memos?.find((m) => m.id === id);
    const originalId = deletedMemo?.originalId || id.toString();
    await permanentDeleteMemoMutation.mutateAsync(originalId);
  } else {
    await deleteMemoMutation.mutateAsync(id);
  }
  ```

  - タブ状態によって削除API（通常削除 vs 完全削除）を手動で切り替え
  - `activeMemoTab` と `activeTaskTab` の条件分岐が複雑
  - **メモ一覧/タスク一覧にはこのロジックがない（統一フック内で自動判定）**

- **originalId検索の複雑さ**（275-279行目、292-297行目）

  ```tsx
  const deletedMemo = boardDeletedItems?.memos?.find((m) => m.id === id);
  const originalId = deletedMemo?.originalId || id.toString();
  ```

  - 削除済みタブの場合、`boardDeletedItems` から手動でoriginalIdを探す必要がある
  - この検索ロジックがバグの温床

- **複数の状態管理**（12-36行目のProps）
  - `checkedMemos`, `checkedTasks`
  - `checkedNormalMemos`, `checkedDeletedMemos`
  - `checkedTodoTasks`, `checkedInProgressTasks`, `checkedCompletedTasks`, `checkedDeletedTasks`
  - `activeMemoTab`, `activeTaskTab`
  - `boardMemos`, `boardTasks`, `boardDeletedItems`
  - **これら全てをpropsで渡す必要があり、呼び出し側が複雑**

### 2. **メモ一覧/タスク一覧との設計差**

#### メモ一覧の実装（`use-memo-bulk-delete-wrapper.tsx`）

```tsx
return useBulkDeleteUnified({
  activeTab: props.activeTab,
  checkedItems: props.checkedMemos,
  checkedDeletedItems: props.checkedDeletedMemos,
  // ... その他のprops
});
```

- **シンプルな呼び出し**
- タブ判定は `useBulkDeleteUnified` 内部で自動実行
- originalId検索も統一フック内で処理

#### ボード詳細の実装（`use-bulk-delete-operations.tsx`）

```tsx
// 手動でタブ判定
if (activeMemoTab === "deleted") {
  const deletedMemo = boardDeletedItems?.memos?.find((m) => m.id === id);
  const originalId = deletedMemo?.originalId || id.toString();
  await permanentDeleteMemoMutation.mutateAsync(originalId);
} else {
  await deleteMemoMutation.mutateAsync(id);
}
```

- **手動で条件分岐**
- タブ判定、originalId検索、API呼び分けを全て自前で実装
- **メモ一覧と同じロジックなのに、コードが重複**

### 3. **呼び出し側の複雑さ**

#### ボード詳細での呼び出し（`board-detail-screen-3panel.tsx:321-341`）

```tsx
const { ... } = useBulkDeleteOperations({
  boardId,
  checkedMemos,
  checkedTasks,
  setCheckedMemos,
  setCheckedTasks,
  deleteButtonRef,
  activeMemoTab,
  activeTaskTab,
  checkedNormalMemos,
  checkedDeletedMemos,
  checkedTodoTasks,
  checkedInProgressTasks,
  checkedCompletedTasks,
  checkedDeletedTasks,
  teamMode,
  teamId: teamId || undefined,
  boardMemos,
  boardTasks,
  boardDeletedItems,
});
```

- **20個近いpropsを渡す必要**
- タブ状態とチェック状態を全て渡す
- ボードアイテムと削除済みアイテムを両方渡す

## なぜこれが壊れやすいのか

### パターン1: タブ判定ロジックの変更漏れ

```tsx
// 例: activeTaskTabに新しいステータスが追加された場合
if (activeTaskTab === "deleted") {
  // 完全削除
} else {
  // 通常削除 ← 新ステータスはここに入るが、意図通りか不明
}
```

- メモ一覧/タスク一覧を修正しても、**ボード詳細は別実装なので修正漏れ**
- マージ時に古いロジックが残る

### パターン2: originalId検索の失敗

```tsx
const deletedMemo = boardDeletedItems?.memos?.find((m) => m.id === id);
const originalId = deletedMemo?.originalId || id.toString();
```

- `boardDeletedItems` が未取得の場合、`id.toString()` をフォールバック
- これが誤ったIDでAPI呼び出しを引き起こす
- **過去のコミット `0ec14bc1` で修正された問題**

### パターン3: Props渡し忘れ

```tsx
useBulkDeleteOperations({
  // 大量のpropsを渡す
  // 1つでも渡し忘れるとバグ
  boardDeletedItems, // ← これを渡し忘れるとoriginalId検索が失敗
});
```

## 解決策の比較

### 案1: 現状維持（壊れやすいまま）

**メリット**

- 変更なし、リスクゼロ

**デメリット**

- 壊れやすい状況が続く
- 将来のメンテナンスコストが高い

### 案2: `useBulkDeleteUnified` への統一（試行済み・失敗）

**メリット**

- メモ一覧/タスク一覧と同じパターン
- タブ判定が自動化
- コード重複削除

**デメリット**

- **チェックボックスが動かなくなる問題が発生**（コミット `6fc616a5` で確認）
- wrapperを経由するため、`Set<string | number>` → `Set<number>` の型変換が必要
- 派生ステートの受け渡しでバグが起きる

**失敗した原因**

- `useMultiSelection` が返す派生ステート（`checkedDeletedMemos` など）を wrapper 経由で渡す設計が複雑すぎた
- ハンドラーがステート更新を正しくキャプチャできなかった

### 案3: タブ判定ロジックだけを共通化

**メリット**

- 最小限の変更で壊れにくくなる
- チェックボックスは既存実装のまま

**デメリット**

- 完全な統一ではない
- ある程度のコード重複は残る

**実装案**

```tsx
// 共通関数を作成
export function shouldUsePermanentDelete(
  itemType: "memo" | "task",
  activeMemoTab: "normal" | "deleted",
  activeTaskTab: "todo" | "in_progress" | "completed" | "deleted"
): boolean {
  if (itemType === "memo") {
    return activeMemoTab === "deleted";
  } else {
    return activeTaskTab === "deleted";
  }
}

export function getItemOriginalId(
  id: number,
  itemType: "memo" | "task",
  boardItems: Array<{ id: number; originalId?: string }>,
  boardDeletedItems?: { memos?: Array<...>, tasks?: Array<...> }
): string {
  // originalId検索ロジックを共通化
}
```

### 案4: ボード詳細専用の簡易統一フックを作成

**メリット**

- ボード詳細の複雑な要件に対応
- メモ一覧/タスク一覧の `useBulkDeleteUnified` は触らない
- タブ判定ロジックを内部に隠蔽

**デメリット**

- 新しいフックの作成が必要
- 完全な統一ではない

**実装案**

```tsx
// use-board-bulk-delete.tsx (新規作成)
export function useBoardBulkDelete({
  boardId,
  itemType, // "memo" | "task"
  activeTab, // タブ状態（memo: "normal" | "deleted", task: "todo" | ...）
  checkedItems,
  setCheckedItems,
  boardItems,
  boardDeletedItems,
  teamMode,
  teamId,
}) {
  // 内部でタブ判定と originalId 検索を実行
  // メモとタスクを統一的に扱う
  // useBulkDeleteOperations の複雑なロジックを吸収
}
```

## 推奨案

**案3: タブ判定ロジックだけを共通化**

理由：

1. **最小限の変更**でリスクを抑えられる
2. チェックボックスの動作に影響しない
3. 壊れやすい部分（タブ判定、originalId検索）だけを共通化
4. 将来的に案4への移行も可能

## 実装状況

### ✅ 完了（2025-11-06）

**案3: タブ判定ロジックだけを共通化** を実装しました。

#### 1. 共通関数の作成（`src/utils/boardDeleteUtils.ts`）

以下の3つの関数を作成：

- **`shouldUsePermanentDelete()`**: タブ状態から完全削除を使用すべきか判定
- **`getItemOriginalId()`**: アイテムのoriginalIdを取得（検索ロジックを統一）
- **`logDeleteOperation()`**: 削除操作のログ出力ヘルパー

#### 2. `use-bulk-delete-operations.tsx` への適用

- **L276-327**: `onApiCall` 内のタブ判定ロジックを共通関数化
  - 手動の `if (activeMemoTab === "deleted")` を `shouldUsePermanentDelete()` に置き換え
  - 手動の originalId 検索を `getItemOriginalId()` に置き換え
  - ログ出力を `logDeleteOperation()` に統一

- **L442-450**: `handleRemoveFromBoard` 内の originalId 検索も共通関数化
  - 手動の `boardMemos.find()` / `boardTasks.find()` を `getItemOriginalId()` に置き換え

#### 3. 型チェック

- ✅ `npx tsc --noEmit` でエラーなし

### メリット

1. **最小限の変更**: チェックボックスロジックは既存実装のまま
2. **壊れにくい**: タブ判定ロジックが統一され、マージ時の修正漏れを防止
3. **デバッグしやすい**: 共通関数にコメントと警告ログを追加
4. **拡張性**: 将来的に案4（専用統一フック）への移行も可能

### 残タスク

1. 動作確認（手動テスト）
   - ボード詳細でメモ/タスクの通常削除
   - ボード詳細でメモ/タスクの完全削除
   - ボードから削除機能
2. 問題なければコミット
3. 将来的に案4（専用統一フック）への移行を検討
