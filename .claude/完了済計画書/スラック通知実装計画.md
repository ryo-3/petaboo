# Slack通知機能 実装計画書

## 📋 概要

チームごとにSlack Webhook URLを保存・管理し、チーム活動の通知をSlackに送信する機能を実装する。

## 🎯 要件

### フェーズ1: 基本機能（MVP）

- チームごとにSlack Webhook URLを保存（平文）
- Webhook URLの登録・更新・削除API
- テスト通知送信機能

### フェーズ2: セキュリティ強化（後日）

- Webhook URLの暗号化保存
- 暗号化キーをWorkers Secretsで管理

## 🗄️ データベース設計

### 新規テーブル: `team_slack_configs`

```sql
CREATE TABLE team_slack_configs (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  teamId INTEGER NOT NULL UNIQUE,
  webhookUrl TEXT NOT NULL,
  isEnabled INTEGER DEFAULT 1,
  createdAt TEXT NOT NULL,
  updatedAt TEXT NOT NULL,
  FOREIGN KEY (teamId) REFERENCES teams(id) ON DELETE CASCADE
);
```

**カラム説明:**

- `teamId`: チームID（UNIQUE制約で1チーム1設定のみ）
- `webhookUrl`: Slack Webhook URL（フェーズ1は平文、フェーズ2で暗号化）
- `isEnabled`: 通知ON/OFF（0=無効, 1=有効）
- `createdAt/updatedAt`: 作成・更新日時

## 🔌 API設計

### 1. Webhook URL登録・更新

```
PUT /teams/{teamId}/slack-config
Authorization: Bearer {token}

Request:
{
  "webhookUrl": "https://hooks.slack.com/services/XXX/YYY/ZZZ",
  "isEnabled": true
}

Response: 200 OK
{
  "id": 1,
  "teamId": 5,
  "webhookUrl": "https://hooks.slack.com/services/XXX/YYY/ZZZ",
  "isEnabled": true,
  "createdAt": "2025-10-13T10:00:00Z",
  "updatedAt": "2025-10-13T10:00:00Z"
}
```

### 2. Webhook URL取得

```
GET /teams/{teamId}/slack-config
Authorization: Bearer {token}

Response: 200 OK
{
  "id": 1,
  "teamId": 5,
  "webhookUrl": "https://hooks.slack.com/services/XXX/YYY/ZZZ",
  "isEnabled": true,
  "createdAt": "2025-10-13T10:00:00Z",
  "updatedAt": "2025-10-13T10:00:00Z"
}

Response: 404 Not Found（未設定の場合）
{
  "error": "Slack configuration not found"
}
```

### 3. Webhook URL削除

```
DELETE /teams/{teamId}/slack-config
Authorization: Bearer {token}

Response: 204 No Content
```

### 4. テスト通知送信

```
POST /teams/{teamId}/slack-config/test
Authorization: Bearer {token}

Response: 200 OK
{
  "success": true,
  "message": "Test notification sent successfully"
}

Response: 400 Bad Request（送信失敗時）
{
  "success": false,
  "error": "Failed to send notification: invalid_webhook_url"
}
```

## 🛠️ 実装手順

### ステップ1: データベーススキーマ追加

- [ ] `apps/api/src/db/schema.ts` に `teamSlackConfigs` テーブル定義追加
- [ ] マイグレーションファイル生成: `npm run db:generate`
- [ ] ローカルマイグレーション実行: `npm run db:migration:local`

### ステップ2: API実装

- [ ] `apps/api/src/routes/teams/slack-config/route.ts` 作成
- [ ] `apps/api/src/routes/teams/slack-config/api.ts` 実装
  - PUT `/teams/{teamId}/slack-config` - 登録・更新
  - GET `/teams/{teamId}/slack-config` - 取得
  - DELETE `/teams/{teamId}/slack-config` - 削除
  - POST `/teams/{teamId}/slack-config/test` - テスト送信
- [ ] `apps/api/worker-d1.ts` にルート登録（重要！）

### ステップ3: 権限チェック実装

- [ ] チーム管理者（owner/admin）のみがWebhook URL設定可能
- [ ] チームメンバー全員が設定内容を閲覧可能

### ステップ4: Slack通知ユーティリティ作成

- [ ] `apps/api/src/utils/slack-notifier.ts` 作成
- [ ] 通知送信共通関数実装

```typescript
// apps/api/src/utils/slack-notifier.ts
export async function sendSlackNotification(
  webhookUrl: string,
  message: string,
): Promise<boolean> {
  try {
    const response = await fetch(webhookUrl, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ text: message }),
    });
    return response.ok;
  } catch (error) {
    console.error("Slack notification error:", error);
    return false;
  }
}
```

### ステップ5: フロントエンド実装

- [ ] チーム設定画面にSlack連携セクション追加
- [ ] Webhook URL入力フォーム作成
- [ ] ON/OFFトグル実装
- [ ] テスト送信ボタン実装

## 🧪 テスト計画

### APIテスト

```bash
# 1. Webhook URL登録
apitest "/teams/1/slack-config" "PUT" '{"webhookUrl":"https://hooks.slack.com/services/TEST","isEnabled":true}'

# 2. Webhook URL取得
apitest "/teams/1/slack-config" "GET"

# 3. テスト通知送信
apitest "/teams/1/slack-config/test" "POST"

# 4. Webhook URL削除
apitest "/teams/1/slack-config" "DELETE"
```

### データベース確認

```bash
npx wrangler d1 execute DB --local --command "SELECT * FROM team_slack_configs;"
```

## 📝 通知イベント設計

### フェーズ1: コメント・メンション通知（優先実装）

既存のコメント機能（`team_comments`テーブル）と統合し、以下の通知を実装：

#### 既存のコメント機能

- **テーブル**: `team_comments`
- **API**: `POST /comments?teamId=X` - コメント投稿（メンション自動解析）
- **メンション**: `@displayName` 形式で自動検出、`mentions`カラムにJSON配列保存

#### 1. メンション通知

**トリガー**: コメントに `@displayName` が含まれる場合
**通知方式**: チームのSlackチャンネルに投稿（Webhook URL使用）
**通知内容**:

```
🔔 @{displayName} さんがメンションされました

📝 {targetType}: {targetTitle}
💬 {commenterDisplayName}: {commentContent}

🔗 {リンク}
```

**実装箇所**: `POST /comments` API内（L234-277）でコメント作成後にSlack通知送信

**実装詳細**:

```typescript
// 1. メンション解析済み（L256）
const mentionedUserIds = await extractMentions(content, teamId, db);

// 2. コメント作成（L262-274）
const result = await db.insert(teamComments).values({...}).returning();

// 3. Slack通知送信（追加実装）
if (mentionedUserIds.length > 0) {
  // mentionedUserIdsからdisplayName取得
  const mentionedUsers = await getMentionedUsersDisplayNames(mentionedUserIds, teamId, db);

  // Slack設定取得
  const slackConfig = await getTeamSlackConfig(teamId, db);

  if (slackConfig?.isEnabled) {
    const message = formatMentionNotification(mentionedUsers, result[0], commenter);
    await sendSlackNotification(slackConfig.webhookUrl, message);
  }
}
```

**重要**: Webhook URLでは個別DM送信不可。チーム全員が見えるチャンネルに投稿される。

#### 2. コメント通知（オプション）

**トリガー**: メモ・タスク・ボードにコメントが投稿された場合
**通知対象**: 対象の作成者 or チーム全体（設定による）
**通知内容**:

```
💬 新しいコメントが投稿されました

📝 {targetType}: {targetTitle}
👤 {commenterDisplayName}: {commentContent}

🔗 {リンク}
```

### フェーズ2: セキュリティ強化

- Webhook URLの暗号化保存
- Workers Secretsで暗号化キー管理

### フェーズ3: その他の通知イベント

- チームメンバー招待・承認通知
- タスク割り当て通知
- 定期サマリー通知

### 通知設定の詳細化（将来）

- 通知種別ごとのON/OFF
- 通知時間帯設定
- 通知フォーマットカスタマイズ

## 🚨 注意事項

- **ルーティング登録必須**: `worker-d1.ts` への登録を忘れないこと
- **権限チェック**: チーム管理者のみが設定変更可能
- **エラーハンドリング**: Webhook URL無効時の適切なエラーメッセージ
- **レート制限**: Slack APIの制限に注意（1チャンネルあたり1メッセージ/秒）
