# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆè©³ç´°

## æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã®æ•´åˆæ€§åˆ†æ

### æ—¢å­˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã®çµ±ä¸€
- **ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—**: `integer`å‹ + `{ mode: "timestamp" }` + `sql`(unixepoch())`
- **ID**: `integer`å‹ + `primaryKey({ autoIncrement: true })`
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼ID**: `text("user_id").notNull()`
- **originalId**: `text("original_id").notNull()` (ãƒ¡ãƒ¢ãƒ»ã‚¿ã‚¹ã‚¯ã®ã¿)
- **å‰Šé™¤ãƒ†ãƒ¼ãƒ–ãƒ«**: å…ƒãƒ†ãƒ¼ãƒ–ãƒ« + `deletedAt`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

## 1. ã‚¿ã‚°ã‚·ã‚¹ãƒ†ãƒ  ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆ

### tagsãƒ†ãƒ¼ãƒ–ãƒ« (ã‚¿ã‚°ãƒã‚¹ã‚¿ãƒ¼)
```typescript
// apps/api/src/db/schema/tags.ts
import { sqliteTable, text, integer } from "drizzle-orm/sqlite-core";
import { sql } from "drizzle-orm";

export const tags = sqliteTable("tags", {
  id: integer("id").primaryKey({ autoIncrement: true }),
  name: text("name").notNull(),
  color: text("color"), // hexå½¢å¼ ä¾‹: "#3B82F6"
  userId: text("user_id").notNull(),
  createdAt: integer("created_at", { mode: "timestamp" })
    .notNull()
    .default(sql`(unixepoch())`),
  updatedAt: integer("updated_at", { mode: "timestamp" })
    .notNull()
    .default(sql`(unixepoch())`)
    .$onUpdate(() => new Date()),
});

// ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¯ã«ã‚¿ã‚°åã¯ä¸€æ„
// CREATE UNIQUE INDEX idx_tags_user_name ON tags(user_id, name);
```

### taggingsãƒ†ãƒ¼ãƒ–ãƒ« (ã‚¿ã‚°ä»˜ã‘ä¸­é–“ãƒ†ãƒ¼ãƒ–ãƒ«)
```typescript
export const taggings = sqliteTable("taggings", {
  id: integer("id").primaryKey({ autoIncrement: true }),
  tagId: integer("tag_id").notNull().references(() => tags.id, { onDelete: "cascade" }),
  targetType: text("target_type").notNull(), // 'memo' | 'task' | 'board'
  targetOriginalId: text("target_original_id").notNull(), // å¯¾è±¡ã®originalId
  userId: text("user_id").notNull(), // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šã®ãŸã‚é‡è¤‡ä¿å­˜
  createdAt: integer("created_at", { mode: "timestamp" })
    .notNull()
    .default(sql`(unixepoch())`),
});

// è¤‡åˆãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: åŒã˜ã‚¢ã‚¤ãƒ†ãƒ ã«åŒã˜ã‚¿ã‚°ã¯1ã¤ã¾ã§
// CREATE UNIQUE INDEX idx_taggings_unique ON taggings(tag_id, target_type, target_original_id);
// æ¤œç´¢ç”¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
// CREATE INDEX idx_taggings_target ON taggings(target_type, target_original_id);
// CREATE INDEX idx_taggings_user ON taggings(user_id);
```

### å‹å®šç¾©
```typescript
export type Tag = typeof tags.$inferSelect;
export type NewTag = typeof tags.$inferInsert;
export type Tagging = typeof taggings.$inferSelect;
export type NewTagging = typeof taggings.$inferInsert;
```

## 2. ãƒœãƒ¼ãƒ‰ã‚«ãƒ†ã‚´ãƒªãƒ¼ ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆ

### boardCategoriesãƒ†ãƒ¼ãƒ–ãƒ« âœ… **å®Ÿè£…æ¸ˆã¿ï¼ˆãƒœãƒ¼ãƒ‰å°‚ç”¨ã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼‰**
```typescript
// apps/api/src/db/schema/board-categories.ts
import { sqliteTable, text, integer } from "drizzle-orm/sqlite-core";
import { sql } from "drizzle-orm";

export const boardCategories = sqliteTable("board_categories", {
  id: integer("id").primaryKey({ autoIncrement: true }),
  name: text("name").notNull(),
  boardId: integer("board_id").notNull(), // â˜…ãƒœãƒ¼ãƒ‰å°‚ç”¨ã‚«ãƒ†ã‚´ãƒªãƒ¼
  icon: text("icon"), // ã‚¢ã‚¤ã‚³ãƒ³å ä¾‹: "folder", "project"
  sortOrder: integer("sort_order").notNull().default(0), // è¡¨ç¤ºé †åº
  userId: text("user_id").notNull(),
  createdAt: integer("created_at", { mode: "timestamp" })
    .notNull()
    .default(sql`(unixepoch())`),
  updatedAt: integer("updated_at", { mode: "timestamp" })
    .notNull()
    .default(sql`(unixepoch())`)
    .$onUpdate(() => new Date()),
});

// ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: ãƒœãƒ¼ãƒ‰æ¯ã«ã‚«ãƒ†ã‚´ãƒªãƒ¼ç®¡ç†
// CREATE INDEX idx_board_categories_board ON board_categories(board_id, sort_order);
// CREATE INDEX idx_board_categories_user ON board_categories(user_id);
```

### tasksãƒ†ãƒ¼ãƒ–ãƒ«æ‹¡å¼µ âœ… **å®Ÿè£…æ¸ˆã¿**
```typescript
// apps/api/src/db/schema/tasks.ts ã«è¿½åŠ 
export const tasks = sqliteTable("tasks", {
  // æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰...
  id: integer("id").primaryKey({ autoIncrement: true }),
  originalId: text("original_id").notNull(),
  title: text("title").notNull(),
  description: text("description"),
  status: text("status").notNull(),
  priority: text("priority").notNull(),
  dueDate: integer("due_date", { mode: "timestamp" }),
  categoryId: integer("category_id"),
  userId: text("user_id").notNull(),
  
  // â˜…æ–°è¦è¿½åŠ ï¼ˆãƒœãƒ¼ãƒ‰ã‚«ãƒ†ã‚´ãƒªãƒ¼ã§ã‚¿ã‚¹ã‚¯åˆ†é¡ï¼‰
  boardCategoryId: integer("board_category_id"),
  
  createdAt: integer("created_at", { mode: "timestamp" })
    .notNull()
    .default(sql`(unixepoch())`),
  updatedAt: integer("updated_at", { mode: "timestamp" })
    .notNull()
    .default(sql`(unixepoch())`)
    .$onUpdate(() => new Date()),
});

// ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ 
// CREATE INDEX idx_tasks_board_category ON tasks(board_category_id);
```

### deletedTasksãƒ†ãƒ¼ãƒ–ãƒ«æ‹¡å¼µ âœ… **å®Ÿè£…æ¸ˆã¿**
```typescript
export const deletedTasks = sqliteTable("deleted_tasks", {
  // æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰...
  id: integer("id").primaryKey({ autoIncrement: true }),
  userId: text("user_id").notNull(),
  originalId: text("original_id").notNull(),
  title: text("title").notNull(),
  description: text("description"),
  status: text("status").notNull(),
  priority: text("priority").notNull(),
  dueDate: integer("due_date", { mode: "timestamp" }),
  categoryId: integer("category_id"),
  
  // â˜…æ–°è¦è¿½åŠ ï¼ˆå‰Šé™¤æ™‚ã«ãƒœãƒ¼ãƒ‰ã‚«ãƒ†ã‚´ãƒªãƒ¼æƒ…å ±ã‚‚ä¿å­˜ï¼‰
  boardCategoryId: integer("board_category_id"),
  
  createdAt: integer("created_at").notNull(),
  updatedAt: integer("updated_at"),
  deletedAt: integer("deleted_at").notNull(), // å‰Šé™¤æ—¥æ™‚
});
```

### å‹å®šç¾© âœ… **å®Ÿè£…æ¸ˆã¿**
```typescript
export type BoardCategory = typeof boardCategories.$inferSelect;
export type NewBoardCategory = typeof boardCategories.$inferInsert;

// Taskå‹ã®æ‹¡å¼µï¼ˆãƒœãƒ¼ãƒ‰ã‚«ãƒ†ã‚´ãƒªãƒ¼å¯¾å¿œï¼‰âœ… **å®Ÿè£…æ¸ˆã¿**
export type Task = typeof tasks.$inferSelect & {
  boardCategoryId: number | null; // ãƒœãƒ¼ãƒ‰ã‚«ãƒ†ã‚´ãƒªãƒ¼ID
};

export type CreateTaskData = {
  // ... æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
  boardCategoryId?: number | null; // ãƒœãƒ¼ãƒ‰ã‚«ãƒ†ã‚´ãƒªãƒ¼ID
};

export type UpdateTaskData = {
  // ... æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
  boardCategoryId?: number | null; // ãƒœãƒ¼ãƒ‰ã‚«ãƒ†ã‚´ãƒªãƒ¼ID
};
```

## 3. é‡è¦ãªè¨­è¨ˆåˆ¤æ–­

### originalIdã®æ‰±ã„
- **ãƒœãƒ¼ãƒ‰**: æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã§ã¯`boards.id`ã‚’ç›´æ¥ä½¿ç”¨
- **ã‚¿ã‚°ä»˜ã‘**: `targetOriginalId`ã§ãƒ¡ãƒ¢ãƒ»ã‚¿ã‚¹ã‚¯ãƒ»ãƒœãƒ¼ãƒ‰ã‚’çµ±ä¸€çš„ã«æ‰±ã†
- **ãƒœãƒ¼ãƒ‰ã®originalId**: `board.id.toString()`ã¨ã—ã¦ç”Ÿæˆ

### ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã®çµ±ä¸€
```typescript
// æ—¢å­˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã«åˆã‚ã›ãŸçµ±ä¸€å½¢å¼
createdAt: integer("created_at", { mode: "timestamp" })
  .notNull()
  .default(sql`(unixepoch())`),
updatedAt: integer("updated_at", { mode: "timestamp" })
  .notNull()
  .default(sql`(unixepoch())`)
  .$onUpdate(() => new Date()),
```

### å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã®æˆ¦ç•¥
- **tags â†’ taggings**: `onDelete: "cascade"` (ã‚¿ã‚°å‰Šé™¤æ™‚ã«ã‚¿ã‚°ä»˜ã‘ã‚‚å‰Šé™¤)
- **boardCategories â†’ tasks**: å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ãªã—ï¼ˆãƒœãƒ¼ãƒ‰å°‚ç”¨ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®ãŸã‚ã€boardIdãƒ™ãƒ¼ã‚¹ã§ç®¡ç†ï¼‰

### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥
```sql
-- ã‚¿ã‚°ç³»
CREATE UNIQUE INDEX idx_tags_user_name ON tags(user_id, name);
CREATE UNIQUE INDEX idx_taggings_unique ON taggings(tag_id, target_type, target_original_id);
CREATE INDEX idx_taggings_target ON taggings(target_type, target_original_id);
CREATE INDEX idx_taggings_user ON taggings(user_id);

-- ãƒœãƒ¼ãƒ‰ã‚«ãƒ†ã‚´ãƒªãƒ¼ç³»  
CREATE INDEX idx_board_categories_board ON board_categories(board_id, sort_order);
CREATE INDEX idx_board_categories_user ON board_categories(user_id);
CREATE INDEX idx_tasks_board_category ON tasks(board_category_id);
```

## 4. Drizzleã‚¹ã‚­ãƒ¼ãƒãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

### ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ 
```
apps/api/src/db/schema/
â”œâ”€â”€ memos.ts              # æ—¢å­˜
â”œâ”€â”€ tasks.ts              # æ—¢å­˜  
â”œâ”€â”€ boards.ts             # æ—¢å­˜ + boardCategoryIdè¿½åŠ 
â”œâ”€â”€ categories.ts         # æ—¢å­˜
â”œâ”€â”€ user-preferences.ts   # æ—¢å­˜
â”œâ”€â”€ tags.ts               # æ–°è¦
â””â”€â”€ board-categories.ts   # æ–°è¦
```

### index.tsã®æ›´æ–°
```typescript
// apps/api/src/db/index.ts
export * from "./schema/memos";
export * from "./schema/tasks";
export * from "./schema/user-preferences";
export * from "./schema/categories";
export * from "./schema/boards";
export * from "./schema/tags";              // æ–°è¦è¿½åŠ 
export * from "./schema/board-categories";  // æ–°è¦è¿½åŠ 
```

## 5. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è€ƒæ…®äº‹é …

### æ®µéšçš„è¿½åŠ æˆ¦ç•¥ âœ… **ãƒœãƒ¼ãƒ‰ã‚«ãƒ†ã‚´ãƒªãƒ¼å®Œäº†**
1. **Phase 1**: `tags`, `taggings`ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ âœ… å®Œäº†
2. âœ… **Phase 2**: `board_categories`ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆï¼ˆãƒœãƒ¼ãƒ‰å°‚ç”¨ã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼‰
3. âœ… **Phase 3**: `tasks`ãƒ†ãƒ¼ãƒ–ãƒ«ã«`board_category_id`è¿½åŠ 
4. âœ… **Phase 4**: `deleted_tasks`ãƒ†ãƒ¼ãƒ–ãƒ«ã«`board_category_id`è¿½åŠ 

### æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¸ã®å½±éŸ¿
- æ—¢å­˜ã®memos, tasksãƒ†ãƒ¼ãƒ–ãƒ«ã«å½±éŸ¿ãªã—
- âœ… `tasks.boardCategoryId`ã¯`NULL`è¨±å¯ã§æ—¢å­˜ãƒ‡ãƒ¼ã‚¿å½±éŸ¿ãªã—
- âœ… `deleted_tasks.boardCategoryId`ã‚‚`NULL`è¨±å¯ã§å¾Œæ–¹äº’æ›æ€§ç¢ºä¿

## 6. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### ã‚¯ã‚¨ãƒªãƒ‘ã‚¿ãƒ¼ãƒ³æœ€é©åŒ–
```sql
-- ã‚ˆãä½¿ã‚ã‚Œã‚‹ã‚¯ã‚¨ãƒªãƒ‘ã‚¿ãƒ¼ãƒ³
-- 1. ç‰¹å®šã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¿ã‚°ä¸€è¦§
SELECT t.* FROM tags t 
JOIN taggings tg ON t.id = tg.tag_id 
WHERE tg.target_type = ? AND tg.target_original_id = ?;

-- 2. ç‰¹å®šã‚¿ã‚°ã®ã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§
SELECT tg.target_type, tg.target_original_id 
FROM taggings tg 
WHERE tg.tag_id = ?;

-- 3. ãƒœãƒ¼ãƒ‰ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ¥ã‚¿ã‚¹ã‚¯ä¸€è¦§ âœ… **å®Ÿè£…æ¸ˆã¿**
SELECT t.*, bc.name as category_name 
FROM tasks t 
LEFT JOIN board_categories bc ON t.board_category_id = bc.id 
WHERE t.board_category_id = ?;
```

### ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡å¯¾ç­–
- `userId`ã®é‡è¤‡ä¿å­˜ã§JOINå›æ•°å‰Šæ¸›
- é©åˆ‡ãªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã§ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚­ãƒ£ãƒ³å›é¿
- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å‰æã®è¨­è¨ˆ

## 7. å®Ÿè£…å„ªå…ˆé †ä½

### å¿…é ˆå®Ÿè£… âœ… **ãƒœãƒ¼ãƒ‰ã‚«ãƒ†ã‚´ãƒªãƒ¼å®Œäº†**
1. âœ… `tags`ãƒ†ãƒ¼ãƒ–ãƒ« + åŸºæœ¬CRUD
2. âœ… `taggings`ãƒ†ãƒ¼ãƒ–ãƒ« + åŸºæœ¬æ“ä½œ
3. âœ… `board_categories`ãƒ†ãƒ¼ãƒ–ãƒ« + åŸºæœ¬CRUDï¼ˆãƒœãƒ¼ãƒ‰å°‚ç”¨ï¼‰
4. âœ… `tasks.boardCategoryId`è¿½åŠ 

### æ®µéšçš„å®Ÿè£… ğŸ”¶ **éƒ¨åˆ†å®Œäº†**
1. âœ… ãƒ¡ãƒ¢ãƒ»ã‚¿ã‚¹ã‚¯ã®ã‚¿ã‚°æ©Ÿèƒ½
2. âŒ ãƒœãƒ¼ãƒ‰ã®ã‚¿ã‚°æ©Ÿèƒ½ï¼ˆæœªå®Ÿè£…ï¼‰
3. âœ… ãƒœãƒ¼ãƒ‰ã‚«ãƒ†ã‚´ãƒªãƒ¼æ©Ÿèƒ½ï¼ˆå®Œå…¨å®Ÿè£…æ¸ˆã¿ï¼‰
4. âŒ æ¨ªæ–­æ¤œç´¢æ©Ÿèƒ½ï¼ˆæœªå®Ÿè£…ï¼‰

## 8. âœ… 2025/08/16 ãƒœãƒ¼ãƒ‰ã‚«ãƒ†ã‚´ãƒªãƒ¼å®Ÿè£…å®Œäº†
### å®Ÿè£…ã•ã‚ŒãŸæ©Ÿèƒ½
- **ãƒœãƒ¼ãƒ‰å°‚ç”¨ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚·ã‚¹ãƒ†ãƒ **: å„ãƒœãƒ¼ãƒ‰ãŒç‹¬è‡ªã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ä½“ç³»ã‚’æŒã¤
- **ã‚¿ã‚¹ã‚¯ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ†é¡**: boardCategoryIdã§ã‚¿ã‚¹ã‚¯ã‚’åˆ†é¡å¯èƒ½
- **å®Œå…¨ãªCRUDæ“ä½œ**: ä½œæˆãƒ»èª­ã¿å–ã‚Šãƒ»æ›´æ–°ãƒ»å‰Šé™¤ãƒ»ä¸¦ã³æ›¿ãˆ
- **UIçµ±åˆ**: TaskEditorã€BoardCategoryManagerå®Ÿè£…å®Œäº†
- **å¤‰æ›´æ¤œçŸ¥**: ã‚«ãƒ†ã‚´ãƒªãƒ¼å¤‰æ›´ã®ã¿ã§ã‚‚ä¿å­˜å¯èƒ½

ã“ã®è¨­è¨ˆã§å•é¡Œã‚ã‚Šã¾ã›ã‚“ã‹ï¼Ÿç‰¹ã«æ°—ã«ãªã‚‹ç‚¹ã‚„å¤‰æ›´ã—ãŸã„éƒ¨åˆ†ãŒã‚ã‚Œã°ãŠçŸ¥ã‚‰ã›ãã ã•ã„ã€‚