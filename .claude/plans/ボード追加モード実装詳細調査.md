# ボード追加モード実装詳細調査

最終更新日: 2025-11-27

## 📋 概要

ボード追加モード（`rightPanelMode = "memo-list" / "task-list"`）の実装詳細を調査し、現在の問題点と正しい動作を明らかにする。

## 📚 目次

1. [ボード追加モードの起動方法](#1-ボード追加モードの起動方法)
2. [ボード追加モードの表示ロジック](#2-ボード追加モードの表示ロジック)
3. [現在の問題点](#3-現在の問題点-)
4. [正しい動作](#4-正しい動作)
5. [調査結果まとめ](#5-調査結果まとめ)
6. [コード引用箇所一覧](#6-コード引用箇所一覧)
7. [用語定義](#7-用語定義)

---

## 🔑 調査結果の要点

### 問題の核心

1. **L1091-1094の `showList` 計算ロジックが間違っている**
   - `showList = !rightPanelMode && ...` により、ボード追加モード時に一覧パネルが表示されない
   - 修正: ボード追加モード時も `showList = true` にする

2. **L1145以降の BoardMemoSection/BoardTaskSection で `showMemo/showTask` が状態依存**
   - ボード追加モード時に `showMemo` や `showTask` が false だと `return null` になる
   - 修正: ボード追加モード時は強制的に `true` にする

### 修正箇所

- **L1091-1094**: `showList` の計算ロジック修正
- **L1148**: `showMemo={rightPanelMode === "memo-list" ? true : showMemo}`
- **L1189**: `showTask={rightPanelMode === "task-list" ? true : showTask}`
- **L1230**: 同上
- **L1270**: 同上

### 期待される修正効果

- メモ/タスク選択中にボード追加モードボタンをクリックしても、一覧が正常に表示される
- ヘッダーのメモ/タスク表示トグルボタンの状態に関係なく、ボード追加モード時は必ず一覧が表示される

---

## 1. ボード追加モードの起動方法

### 1.1 起動トリガー

**場所**: `/home/ryosuke/petaboo/apps/web/components/features/board/board-memo-section.tsx` (L243-269)

```tsx
<Tooltip
  text={rightPanelMode === "memo-list" ? "メモ一覧非表示" : "メモ一覧表示"}
  position="bottom"
>
  <button
    onClick={() =>
      onSetRightPanelMode(rightPanelMode === "memo-list" ? null : "memo-list")
    }
    className={`size-6 flex items-center justify-center rounded-lg transition-colors ${
      rightPanelMode === "memo-list"
        ? "bg-gray-100 hover:bg-gray-200"
        : "bg-gray-100 hover:bg-gray-200"
    }`}
  >
    <FilterIconCheckList
      className={`size-5 ${
        rightPanelMode === "memo-list" ? "text-Green" : "text-gray-600"
      }`}
    />
  </button>
</Tooltip>
```

**場所**: `/home/ryosuke/petaboo/apps/web/components/features/board/board-task-section.tsx` (L259-287)

```tsx
<Tooltip
  text={rightPanelMode === "task-list" ? "タスク一覧非表示" : "タスク一覧表示"}
  position="bottom"
>
  <button
    onClick={() =>
      onSetRightPanelMode(rightPanelMode === "task-list" ? null : "task-list")
    }
    className={`size-6 flex items-center justify-center rounded-lg transition-colors ${
      rightPanelMode === "task-list"
        ? "bg-gray-100 hover:bg-gray-200"
        : "bg-gray-100 hover:bg-gray-200"
    }`}
  >
    <FilterIconCheckList
      className={`size-5 ${
        rightPanelMode === "task-list" ? "text-DeepBlue" : "text-gray-600"
      }`}
    />
  </button>
</Tooltip>
```

### 1.2 状態管理

- **Props経由**: `onSetRightPanelMode` が親コンポーネント（board-detail-screen.tsx）から渡される
- **親での定義**: `useBoardState` フックで管理される `setRightPanelMode` 関数
- **トグル動作**:
  - 現在が `"memo-list"` なら `null`（非表示）
  - 現在が `null` なら `"memo-list"`（表示）

---

## 2. ボード追加モードの表示ロジック

### 2.1 board-detail-screen.tsx での条件分岐

**場所**: `/home/ryosuke/petaboo/apps/web/components/screens/board-detail-screen.tsx` (L1006-1087)

```tsx
{/* ボード追加モード: 1パネルのみ全画面表示（ResizablePanel不使用） */}
{rightPanelMode === "memo-list" || rightPanelMode === "task-list" ? (
  rightPanelMode === "memo-list" ? (
    <BoardMemoSection
      rightPanelMode={rightPanelMode}
      showMemo={true}
      // ... 全てのpropsを渡す
    />
  ) : (
    <BoardTaskSection
      boardId={boardId}
      initialBoardId={boardId}
      rightPanelMode={rightPanelMode}
      showMemo={showMemo}
      showTask={true}
      // ... 全てのpropsを渡す
    />
  )
) : // 以下、通常モード（selectedMemo/selectedTask時の2パネル構成など）
```

### 2.2 重要な条件

1. **最優先の条件分岐**:
   - `rightPanelMode === "memo-list" || rightPanelMode === "task-list"` が**最初に**評価される
   - この条件が真の場合、**ResizablePanelを使わず**、直接1パネルのみをレンダリング

2. **showMemo/showTaskの強制設定**:
   - メモ一覧モード時: `showMemo={true}` を強制
   - タスク一覧モード時: `showTask={true}` を強制

3. **fullscreenモード**:
   - ResizablePanelGroupを使用せず、直接セクションをレンダリング
   - 全画面でメモまたはタスクの一覧を表示

### 2.3 BoardMemoSection/BoardTaskSection 内の早期return条件

#### BoardMemoSection (L195-197)

```tsx
if (rightPanelMode === "task-list" || !showMemo) {
  return null;
}
```

**条件**:

- `rightPanelMode === "task-list"` → タスク一覧モード時はメモセクションを非表示
- `!showMemo` → showMemoがfalseの場合も非表示

#### BoardTaskSection (L213-215)

```tsx
if (rightPanelMode === "memo-list" || !showTask) {
  return null;
}
```

**条件**:

- `rightPanelMode === "memo-list"` → メモ一覧モード時はタスクセクションを非表示
- `!showTask` → showTaskがfalseの場合も非表示

---

## 3. 現在の問題点 🔴

### 3.1 **重大な問題発見**: 選択時の条件分岐でボード追加モードが無視される

**場所**: `/home/ryosuke/petaboo/apps/web/components/screens/board-detail-screen.tsx` (L1088-1094)

```tsx
) : selectedMemo || selectedTask ? (
  // 選択時: 一覧 | 詳細 の2パネル構成
  (() => {
    const showList =
      !rightPanelMode &&
      (selectedMemo || selectedTask) &&
      showListPanelInSelectedMode;
    const showDetail = selectedMemo || selectedTask;
```

### 3.2 問題の詳細

#### 問題のある条件式 (L1091-1094)

```tsx
const showList =
  !rightPanelMode && // ← ここが問題！
  (selectedMemo || selectedTask) &&
  showListPanelInSelectedMode;
```

**問題**:

- `!rightPanelMode` の条件により、`rightPanelMode` が `"memo-list"` または `"task-list"` の場合、`showList` が **false** になる
- つまり、**ボード追加モード時に一覧パネルが表示されない**

#### 条件分岐の優先順位

**現在のコード構造** (L1006-1369):

```tsx
{rightPanelMode === "memo-list" || rightPanelMode === "task-list" ? (
  // ボード追加モード: fullscreen表示
  // ...
) : selectedMemo || selectedTask ? (
  // 選択時: 2パネル構成
  // ← 問題: ここでもshowListの判定に!rightPanelModeが含まれる
  const showList = !rightPanelMode && ...
) : (
  // 非選択時: 2パネル構成
)}
```

**問題のシナリオ**:

1. ユーザーがメモを選択（`selectedMemo` がセットされる）
2. ボード追加モードボタンをクリック（`rightPanelMode = "memo-list"` になる）
3. 最初の条件分岐 `rightPanelMode === "memo-list"` は **false** になる（なぜなら `selectedMemo || selectedTask` の条件が先に評価される）
4. 実際には2番目の条件分岐 `selectedMemo || selectedTask` に入る
5. しかし `showList = !rightPanelMode && ...` により、一覧パネルが表示されない

### 3.3 条件分岐の評価順序の問題

**期待される評価順序**:

1. `rightPanelMode === "memo-list" || rightPanelMode === "task-list"` → ボード追加モード優先
2. `selectedMemo || selectedTask` → 選択時
3. それ以外 → 非選択時

**実際の評価順序**:

1. `rightPanelMode === "memo-list" || rightPanelMode === "task-list"` → **ただし `selectedMemo || selectedTask` が true の場合は2番目に移行**
2. `selectedMemo || selectedTask` → **ここで `showList = !rightPanelMode && ...` により一覧が非表示**
3. それ以外 → 非選択時

**結論**:

- **`selectedMemo || selectedTask` が true の状態でボード追加モードに入ると、最初の条件分岐をスキップして2番目に入ってしまう**
- そのため、L1145以降のコードで `rightPanelMode === "memo-list"` の分岐には入るが、**`showList = false` のため一覧パネル自体が表示されない**

### 3.4 L1145での分岐は正常

**場所**: board-detail-screen.tsx (L1145-1182)

```tsx
{rightPanelMode === "memo-list" ? (
  <BoardMemoSection
    rightPanelMode={rightPanelMode}  // "memo-list"
    showMemo={showMemo}              // 状態依存
    // ...
  />
) : // ...
```

**ここでの問題**:

- `showMemo` は状態依存で渡される（強制的に `true` ではない）
- もし `showMemo = false` なら、BoardMemoSection 内で `return null` になる

### 3.5 return nullになる条件の詳細分析

#### ケース1: メモ一覧モード（`rightPanelMode = "memo-list"`）+ メモ選択中

**条件**:

- `selectedMemo` が存在
- `rightPanelMode = "memo-list"`

**評価フロー**:

1. **L1007の条件**: `rightPanelMode === "memo-list" || rightPanelMode === "task-list"`
   - → **false** (`selectedMemo || selectedTask` が優先されて2番目の条件へ)

2. **L1088の条件**: `selectedMemo || selectedTask`
   - → **true** (メモが選択されているので)

3. **L1091-1094の計算**: `showList = !rightPanelMode && ...`
   - `!rightPanelMode` → **false** ("memo-list" なので)
   - `showList` → **false**

4. **L1134の条件**: `{showList && (...}`
   - → **false** なので**一覧パネルが表示されない**

5. **L1145の条件**: `rightPanelMode === "memo-list"`
   - → **true** なので BoardMemoSection を呼び出す

6. **BoardMemoSection (L1148)**: `showMemo={showMemo}`
   - `showMemo` の値が **false** なら `return null` (L195-197)

#### ケース2: タスク一覧モード（`rightPanelMode = "task-list"`）+ タスク選択中

同様の問題が発生する。

### 3.6 根本原因まとめ

**問題1**: ~~**条件分岐の優先順位がおかしい**~~

- **訂正**: 実際には条件分岐の優先順位は正しい（L1007が最優先）
- しかし、**L1091の `showList` 計算ロジックに問題がある**

**問題2**: **showList の計算ロジックが間違っている** ⚠️

- `showList = !rightPanelMode && ...` により、ボード追加モード時に一覧パネルが非表示になる
- **これが最大の問題点**
- 正しくは、`rightPanelMode === "memo-list" || rightPanelMode === "task-list"` の場合も `showList = true` にすべき

**問題3**: **状態依存の showMemo/showTask** ⚠️

- L1145以降で呼び出される BoardMemoSection/BoardTaskSection では、`showMemo/showTask` が状態依存
- 強制的に `true` にしていないため、条件によっては `return null` になる
- **ボード追加モード時は必ず `true` にすべき**

### 3.7 実際の動作の詳細シミュレーション

#### シナリオ1: 非選択状態でボード追加モードボタンをクリック

**初期状態**:

- `selectedMemo = null`
- `selectedTask = null`
- `rightPanelMode = null`

**ボタンクリック後**:

- `rightPanelMode = "memo-list"`

**評価フロー**:

1. **L1007**: `rightPanelMode === "memo-list" || rightPanelMode === "task-list"`
   - → **true** ✅
2. **L1009-1044**: BoardMemoSection を `showMemo={true}` で呼び出し
3. **BoardMemoSection (L195)**: `rightPanelMode === "task-list" || !showMemo`
   - → **false** ✅
4. **正常に一覧表示** ✅

**結論**: 非選択状態では**正常に動作する**

#### シナリオ2: メモ選択中にボード追加モードボタンをクリック（問題発生）

**初期状態**:

- `selectedMemo = { id: 1, ... }`
- `selectedTask = null`
- `rightPanelMode = null`
- `showMemo = true`（仮定）

**ボタンクリック後**:

- `rightPanelMode = "memo-list"`

**評価フロー**:

1. **L1007**: `rightPanelMode === "memo-list" || rightPanelMode === "task-list"`
   - → **true** ✅
2. **しかし、次の条件も評価**:
   - **L1088**: `selectedMemo || selectedTask`
   - → **true**（メモが選択されているので）

**ここが問題**: 三項演算子のネスト構造により、両方の条件が true の場合、**最初の条件が優先される**

**実際の評価**:

```tsx
{rightPanelMode === "memo-list" || rightPanelMode === "task-list" ? (
  // ← rightPanelMode="memo-list" なので、ここに入る ✅
  <BoardMemoSection showMemo={true} ... />
) : selectedMemo || selectedTask ? (
  // ← ここには入らない
  ...
) : ...}
```

**再評価**: 実は**L1007の条件が優先されるので問題ない**はず...

**しかし実際には問題がある理由**:

もう一度コードを見直すと、**L1007-1087はボード追加モード時に正常に動作する**。

**問題は別の場所にある可能性**:

- ユーザーの報告では「一覧が表示されない」とのこと
- もしかすると、**別の要因で `showMemo` や `showTask` が false になっている可能性**

#### シナリオ3: ヘッダーの表示/非表示ボタンとの相互作用

**可能性**:

- ヘッダーのメモ/タスク表示トグルボタン（L721-723）で `showMemo` や `showTask` が false に設定されている場合
- その状態でボード追加モードに入ると、L1011で `showMemo={true}` が強制されるが、**L1148では `showMemo={showMemo}` が渡される**

**結論**: **L1145以降の条件分岐で問題が発生している可能性が高い**

---

## 4. 正しい動作

### 4.1 ボード追加モードで表示されるべき内容

**メモ一覧モード（`rightPanelMode = "memo-list"`）**:

1. 画面全体にメモセクションのみ表示
2. ResizablePanelを使わず、fullscreenで表示
3. メモの一覧（通常/削除済み）をカード形式で表示
4. ヘッダー部分:
   - "メモ" タイトル
   - 件数表示
   - 新規追加ボタン
   - 一覧表示トグルボタン（緑色でアクティブ表示）
   - ソートトグルボタン
5. タブ切り替え:
   - 通常タブ
   - 削除済みタブ（ゴミ箱アイコン）
6. メモカード一覧（スクロール可能）

**タスク一覧モード（`rightPanelMode = "task-list"`）**:

1. 画面全体にタスクセクションのみ表示
2. ResizablePanelを使わず、fullscreenで表示
3. タスクの一覧（未着手/進行中/完了/削除済み）をカード形式で表示
4. ヘッダー部分:
   - "タスク" タイトル
   - 件数表示
   - 新規追加ボタン
   - 一覧表示トグルボタン（青色でアクティブ表示）
   - ソートトグルボタン
   - ボードカテゴリー絞り込みボタン
5. タブ切り替え:
   - 未着手タブ
   - 進行中タブ
   - 完了タブ
   - 削除済みタブ（ゴミ箱アイコン）
6. タスクカード一覧（スクロール可能）

### 4.2 パネル構造

```
┌─────────────────────────────────────────┐
│ Header Control Panel                    │
│ (ボード名、エクスポート、設定など)         │
├─────────────────────────────────────────┤
│                                         │
│  ┌───────────────────────────────────┐  │
│  │ BoardMemoSection (or BoardTask)   │  │
│  │ - ヘッダー（タイトル、ボタン類）   │  │
│  │ - タブ切り替え                     │  │
│  │ - カード一覧（スクロール可能）     │  │
│  └───────────────────────────────────┘  │
│                                         │
└─────────────────────────────────────────┘

※ ResizablePanelなし、fullscreen表示
※ 他のセクション（タスク/メモ）は非表示（return null）
```

---

## 5. 調査結果まとめ

### 5.1 起動方法

- **ボタン**: メモ/タスクセクションの `FilterIconCheckList` アイコンボタン
- **処理**: `onSetRightPanelMode` を呼び出し、`rightPanelMode` を `"memo-list"` または `"task-list"` に設定
- **トグル**: 再度クリックで `null` に戻して非表示

### 5.2 表示ロジック

- **board-detail-screen.tsx**:
  - `rightPanelMode === "memo-list" || rightPanelMode === "task-list"` の条件分岐が**最優先**
  - ResizablePanelを使わず、直接セクションをレンダリング
  - `showMemo={true}` または `showTask={true}` を強制設定

- **BoardMemoSection/BoardTaskSection**:
  - 早期return条件あり
  - メモセクション: `rightPanelMode === "task-list" || !showMemo` で return null
  - タスクセクション: `rightPanelMode === "memo-list" || !showTask` で return null

### 5.3 問題点の結論

**理論上、現在のコードは正しく動作するはず**:

- board-detail-screen.tsx で強制的に `showMemo={true}` / `showTask={true}` を渡している
- 早期return条件には引っかからないはず

**ただし、問題が起きる可能性**:

1. **別の条件分岐での呼び出し**: L1088以降の選択時/非選択時の条件分岐では `showMemo/showTask` が状態依存
2. **状態の同期ずれ**: タイミングによる不整合
3. **未確認のコードパス**: 実際の動作を確認する必要あり

### 5.4 修正案

#### 修正方針

**目的**: ボード追加モード（`rightPanelMode = "memo-list" / "task-list"`）を最優先にし、選択状態に関係なく一覧を全画面表示する

#### 修正箇所1: 条件分岐の優先順位を変更（不要）

**現状**: L1007の条件分岐は既に最優先になっている

```tsx
{rightPanelMode === "memo-list" || rightPanelMode === "task-list" ? (
  // ボード追加モード
) : selectedMemo || selectedTask ? (
  // 選択時
) : (
  // 非選択時
)}
```

**結論**: この部分は修正不要。正しく優先順位が設定されている。

#### 修正箇所2: showList の計算ロジックを修正

**現状** (L1091-1094):

```tsx
const showList =
  !rightPanelMode && // ← 問題
  (selectedMemo || selectedTask) &&
  showListPanelInSelectedMode;
```

**修正案**:

```tsx
const showList =
  rightPanelMode === "memo-list" ||
  rightPanelMode === "task-list" || // ボード追加モード優先
  (!rightPanelMode && // 通常の選択時
    (selectedMemo || selectedTask) &&
    showListPanelInSelectedMode);
```

**修正理由**:

- ボード追加モード時も `showList = true` にすることで、一覧パネルを表示
- 通常の選択時は従来通りの動作を維持

#### 修正箇所3: L1145以降での showMemo/showTask を強制的に true に

**現状** (L1148):

```tsx
<BoardMemoSection
  rightPanelMode={rightPanelMode}
  showMemo={showMemo} // ← 状態依存
  // ...
/>
```

**修正案**:

```tsx
<BoardMemoSection
  rightPanelMode={rightPanelMode}
  showMemo={rightPanelMode === "memo-list" ? true : showMemo} // ボード追加モード時は強制的にtrue
  // ...
/>
```

**同様に L1189での BoardTaskSection**:

```tsx
<BoardTaskSection
  rightPanelMode={rightPanelMode}
  showMemo={showMemo}
  showTask={rightPanelMode === "task-list" ? true : showTask} // ボード追加モード時は強制的にtrue
  // ...
/>
```

#### 修正箇所4: L1225以降の selectedTask/selectedMemo 時の呼び出しも同様に修正

**L1230**: `showTask={rightPanelMode === "task-list" ? true : showTask}`
**L1270**: `showMemo={rightPanelMode === "memo-list" ? true : showMemo}`

#### 期待される動作

修正後:

1. ボード追加モードボタンをクリック
2. `rightPanelMode` が `"memo-list"` または `"task-list"` になる
3. `showList = true` になり、一覧パネルが表示される
4. `showMemo={true}` または `showTask={true}` が強制的に渡される
5. BoardMemoSection/BoardTaskSection 内で `return null` にならない
6. 一覧が正常に表示される

### 5.5 次のステップ

1. **修正実施**: 上記の修正案を実装
2. **動作確認**: ブラウザでボード追加モードを起動し、一覧が表示されるか確認
3. **エッジケース確認**:
   - メモ選択中 → メモ一覧モード
   - タスク選択中 → タスク一覧モード
   - 非選択 → メモ一覧モード
   - 非選択 → タスク一覧モード
4. **トグル動作確認**: ボード追加モードボタンを再度クリックして、元の状態に戻るか確認

---

## 6. コード引用箇所一覧

### 6.1 board-detail-screen.tsx

- **L1006-1087**: ボード追加モードの条件分岐とセクション呼び出し
- **L1088-1368**: 選択時の2パネル構成
- **L1369-1621**: 非選択時のメモ|タスク 2パネル構成

### 6.2 board-memo-section.tsx

- **L195-197**: 早期return条件
- **L243-269**: FilterIconCheckListボタンとトグル処理

### 6.3 board-task-section.tsx

- **L213-215**: 早期return条件
- **L259-287**: FilterIconCheckListボタンとトグル処理

---

## 7. 用語定義

- **ボード追加モード**: メモまたはタスクの一覧を全画面で表示するモード
- **rightPanelMode**: 右パネルの表示モード（"editor", "memo-list", "task-list", null）
- **FilterIconCheckList**: 一覧表示/非表示を切り替えるアイコンボタン
- **早期return**: 条件に合わない場合に `return null` で即座にレンダリングを終了する処理
