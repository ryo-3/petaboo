# ãºãŸã¼ãƒ¼ ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­è¨ˆæ–¹é‡

## ä½œæˆæ—¥: 2024-12-08

## æœ€çµ‚æ›´æ–°: 2024-12-09

## ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: âœ… ç¢ºå®š

---

## ğŸ¯ è¨­è¨ˆæ€æƒ³

### æ ¸å¿ƒã®ã‚¢ã‚¤ãƒ‡ã‚¢

```
ã€Œã™ã¹ã¦ã®å¤‰æ›´ã¯ä¿å­˜ãƒœã‚¿ãƒ³ã‚’é€šã‚‹ã€
  â†“
ä¿å­˜å‡¦ç†ã‚’å…±é€šåŒ–ã™ã‚Œã°ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†ã‚‚ä¸€ç®‡æ‰€ã§æ¸ˆã‚€
  â†“
ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£åˆ¥ï¼ˆã‚¿ã‚¹ã‚¯/ãƒ¡ãƒ¢/ãƒœãƒ¼ãƒ‰...ï¼‰ã§ã¯ãªã
ã€Œä¿å­˜ã€ã¨ã„ã†æ“ä½œ + itemType ã§çµ±ä¸€çš„ã«ç®¡ç†
```

### æ—§æ–¹é‡ vs æ–°æ–¹é‡

| é …ç›®       | æ—§æ–¹é‡                                    | æ–°æ–¹é‡                 |
| ---------- | ----------------------------------------- | ---------------------- |
| å˜ä½       | ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£åˆ¥ï¼ˆuse-tasks, use-memos...ï¼‰ | æ“ä½œåˆ¥ï¼ˆå…±é€šä¿å­˜å‡¦ç†ï¼‰ |
| ç®¡ç†ç®‡æ‰€   | å„hooksãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆåˆ†æ•£ï¼‰                   | å…±é€šä¿å­˜å‡¦ç†ï¼ˆé›†ç´„ï¼‰   |
| invalidate | 163ç®‡æ‰€                                   | ã»ã¼ã‚¼ãƒ­               |
| ãƒ‘ã‚¿ãƒ¼ãƒ³   | ãƒ•ã‚¡ã‚¤ãƒ«ã”ã¨ã«å¾®å¦™ã«é•ã†                  | çµ±ä¸€                   |

---

## ğŸ¯ æœ€çµ‚ã‚´ãƒ¼ãƒ«

### æ•°å€¤ç›®æ¨™

| é …ç›®              | ç¾çŠ¶    | ã‚´ãƒ¼ãƒ« |
| ----------------- | ------- | ------ |
| invalidateQueries | 163ç®‡æ‰€ | 10ä»¥ä¸‹ |
| refetchQueries    | 33ç®‡æ‰€  | 0      |

### è¨±å¯ã•ã‚Œã‚‹ invalidate

| å ´é¢                    | ç†ç”±           |
| ----------------------- | -------------- |
| ä¸€æ‹¬æ“ä½œï¼ˆ6ä»¶ä»¥ä¸Šï¼‰     | å€‹åˆ¥æ›´æ–°ãŒè¤‡é›‘ |
| CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ           | å¤§é‡ãƒ‡ãƒ¼ã‚¿     |
| ç«¶åˆæ¤œçŸ¥å¾Œï¼ˆ409ã‚¨ãƒ©ãƒ¼ï¼‰ | æ•´åˆæ€§å›å¾©     |

---

## ğŸ“ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### çµ±ä¸€ä¿å­˜ãƒ«ãƒ¼ãƒˆ

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œï¼ˆä½œæˆ/æ›´æ–°/å‰Šé™¤/å¾©å…ƒï¼‰
        â†“
    ä¿å­˜ãƒœã‚¿ãƒ³
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         å…±é€šä¿å­˜å‡¦ç†                  â”‚
â”‚                                     â”‚
â”‚  itemType ã§åˆ†å²:                    â”‚
â”‚  - "task"                           â”‚
â”‚  - "memo"                           â”‚
â”‚  - "board"                          â”‚
â”‚                                     â”‚
â”‚  1. æ¥½è¦³çš„æ›´æ–°ï¼ˆsetQueryDataï¼‰        â”‚
â”‚     - è©²å½“ã‚¢ã‚¤ãƒ†ãƒ ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã¿æ›´æ–°  â”‚
â”‚                                     â”‚
â”‚  2. APIå‘¼ã³å‡ºã—                      â”‚
â”‚     - updatedAt ã‚’é€ä¿¡ï¼ˆãƒãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ï¼‰ â”‚
â”‚                                     â”‚
â”‚  3. ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‡¦ç†                    â”‚
â”‚     - æˆåŠŸ â†’ å®Œäº†                    â”‚
â”‚     - 409 â†’ ãƒˆãƒ¼ã‚¹ãƒˆ + æœ€æ–°ãƒ‡ãƒ¼ã‚¿åæ˜   â”‚
â”‚     - ã‚¨ãƒ©ãƒ¼ â†’ ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å‹å®šç¾©

```typescript
// ã‚¢ã‚¤ãƒ†ãƒ ç¨®åˆ¥
type ItemType = "task" | "memo";

// ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã®ç”Ÿæˆ
const getCacheKey = (itemType: ItemType, teamId?: number) => {
  if (teamId) {
    return [`team-${itemType}s`, teamId]; // ["team-tasks", 123]
  }
  return [itemType === "task" ? "tasks" : "memos"]; // ["tasks"] or ["memos"]
};

const getDeletedCacheKey = (itemType: ItemType, teamId?: number) => {
  if (teamId) {
    return [`team-deleted-${itemType}s`, teamId];
  }
  return itemType === "task" ? ["deleted-tasks"] : ["deletedMemos"];
};
```

### ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°ã®åŸå‰‡

```typescript
// ä¿å­˜æˆåŠŸæ™‚: è©²å½“ã‚¢ã‚¤ãƒ†ãƒ ã®ã¿æ›´æ–°
queryClient.setQueryData(
  getCacheKey(itemType, teamId),
  (old) => è©²å½“ã‚¢ã‚¤ãƒ†ãƒ ã®ã¿æ›´æ–°ã—ãŸæ–°é…åˆ—,
);

// invalidate ã¯ä½¿ã‚ãªã„ï¼ˆä¾‹å¤–ã‚’é™¤ãï¼‰
```

### å–å¾—æ™‚ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®šï¼ˆuseQueryï¼‰

å€‹äººãƒ¢ãƒ¼ãƒ‰ã§ã¯ `setQueryData` ã§å¸¸ã«æœ€æ–°åŒ–ã•ã‚Œã‚‹ãŸã‚ã€ãƒšãƒ¼ã‚¸é·ç§»æ™‚ã®APIå†å–å¾—ã¯ä¸è¦ã€‚

```typescript
// å€‹äººãƒ¢ãƒ¼ãƒ‰ç”¨è¨­å®š
{
  staleTime: Infinity,        // æ°¸ç¶šã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆsetQueryDataã§æ›´æ–°ï¼‰
  refetchOnMount: false,      // ãƒã‚¦ãƒ³ãƒˆæ™‚ã«å†å–å¾—ã—ãªã„
  refetchOnWindowFocus: false // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã«å†å–å¾—ã—ãªã„
}

// ãƒãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ç”¨è¨­å®š
{
  staleTime: 30 * 1000,       // 30ç§’ï¼ˆä»–ãƒ¡ãƒ³ãƒãƒ¼ã®å¤‰æ›´å–å¾—ã®ãŸã‚çŸ­ã‚ï¼‰
  refetchOnMount: true,       // ãƒã‚¦ãƒ³ãƒˆæ™‚ã«å†å–å¾—
  refetchOnWindowFocus: false,
  refetchInterval: 60 * 1000  // 60ç§’ã”ã¨ã«è‡ªå‹•å–å¾—
}
```

| è¨­å®š                 | å€‹äººãƒ¢ãƒ¼ãƒ‰ | ãƒãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ |
| -------------------- | ---------- | ------------ |
| staleTime            | Infinity   | 30ç§’         |
| refetchOnMount       | false      | true         |
| refetchOnWindowFocus | false      | false        |
| refetchInterval      | ãªã—       | 60ç§’         |

---

## ğŸš€ å®Ÿè£…ã‚¹ãƒ†ãƒƒãƒ—

### Step 1: å€‹äººãƒ¢ãƒ¼ãƒ‰ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ï¼‰

```
ç›®æ¨™: ä¿å­˜ â†’ setQueryData ã®ã¿

ã‚„ã‚‹ã“ã¨:
- å…±é€šã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°é–¢æ•°ã‚’ä½œæˆ
- å„hooksï¼ˆuse-tasks, use-memosç­‰ï¼‰ã§å…±é€šé–¢æ•°ã‚’ä½¿ç”¨
- invalidate/refetch ã‚’å‰Šé™¤
```

### Step 2: ãƒãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ï¼ˆå€‹äººã¨åŒã˜ï¼‰

```
ç›®æ¨™: ã¾ãšå€‹äººãƒ¢ãƒ¼ãƒ‰ã¨åŒã˜ä»•çµ„ã¿ã«ã™ã‚‹

ã‚„ã‚‹ã“ã¨:
- ãƒãƒ¼ãƒ ç”¨hooksã‚‚åŒã˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã«çµ±ä¸€
- ã“ã®æ™‚ç‚¹ã§ã¯ç«¶åˆãƒã‚§ãƒƒã‚¯ãªã—
```

### Step 3: ãƒãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ï¼ˆç«¶åˆãƒã‚§ãƒƒã‚¯è¿½åŠ ï¼‰

```
ç›®æ¨™: æ¥½è¦³çš„ãƒ­ãƒƒã‚¯ã§ç«¶åˆæ¤œçŸ¥

ã‚„ã‚‹ã“ã¨:
- APIå´: å…±é€šãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ä½œæˆ
- ãƒ•ãƒ­ãƒ³ãƒˆå´: updatedAt ã‚’é€ä¿¡
- 409ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°è¿½åŠ 
```

### Step 4: ãƒãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ï¼ˆå®šæœŸå–å¾—ï¼‰

```
ç›®æ¨™: ä»–äººã®å¤‰æ›´ã‚’å–å¾—

ã‚„ã‚‹ã“ã¨:
- refetchInterval: 60ç§’ï¼ˆæ—¢å­˜ã®ã¾ã¾ã§OKï¼‰
```

---

## ğŸ“ å…±é€šã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°é–¢æ•°

### updateItemCacheï¼ˆä½œæˆäºˆå®šï¼‰

```typescript
// apps/web/src/lib/cache-utils.ts

type ItemType = "task" | "memo";
type Operation = "create" | "update" | "delete" | "restore" | "permanentDelete";

interface UpdateItemCacheParams {
  queryClient: QueryClient;
  itemType: ItemType;
  operation: Operation;
  item: Task | Memo;
  teamId?: number;
  boardId?: number;
}

export const updateItemCache = ({
  queryClient,
  itemType,
  operation,
  item,
  teamId,
  boardId,
}: UpdateItemCacheParams) => {
  const cacheKey = getCacheKey(itemType, teamId);
  const deletedCacheKey = getDeletedCacheKey(itemType, teamId);

  switch (operation) {
    case "create":
      // ä¸€è¦§ã«è¿½åŠ 
      queryClient.setQueryData(cacheKey, (old) => [...(old || []), item]);
      break;

    case "update":
      // ä¸€è¦§ã®è©²å½“ã‚¢ã‚¤ãƒ†ãƒ ã‚’ç½®æ›
      queryClient.setQueryData(cacheKey, (old) =>
        old?.map((i) => (i.id === item.id ? item : i)),
      );
      break;

    case "delete":
      // ä¸€è¦§ã‹ã‚‰å‰Šé™¤ + å‰Šé™¤æ¸ˆã¿ã«è¿½åŠ 
      queryClient.setQueryData(cacheKey, (old) =>
        old?.filter((i) => i.id !== item.id),
      );
      queryClient.setQueryData(deletedCacheKey, (old) => [
        ...(old || []),
        item,
      ]);
      break;

    case "restore":
      // å‰Šé™¤æ¸ˆã¿ã‹ã‚‰å‰Šé™¤ + ä¸€è¦§ã«è¿½åŠ 
      queryClient.setQueryData(deletedCacheKey, (old) =>
        old?.filter((i) => i.id !== item.id),
      );
      queryClient.setQueryData(cacheKey, (old) => [...(old || []), item]);
      break;

    case "permanentDelete":
      // å‰Šé™¤æ¸ˆã¿ã‹ã‚‰å‰Šé™¤ã®ã¿
      queryClient.setQueryData(deletedCacheKey, (old) =>
        old?.filter((i) => i.id !== item.id),
      );
      break;
  }

  // ãƒœãƒ¼ãƒ‰é€£æº
  if (boardId) {
    updateBoardItemCache({
      queryClient,
      boardId,
      itemType,
      operation,
      item,
      teamId,
    });
  }
};
```

### updateBoardItemCacheï¼ˆä½œæˆäºˆå®šï¼‰

```typescript
export const updateBoardItemCache = ({
  queryClient,
  boardId,
  itemType,
  operation,
  item,
  teamId,
}: {
  queryClient: QueryClient;
  boardId: number;
  itemType: ItemType;
  operation: Operation;
  item: Task | Memo;
  teamId?: number;
}) => {
  const boardCacheKey = teamId
    ? ["team-boards", teamId.toString(), boardId, "items"]
    : ["boards", boardId, "items"];

  const boardDeletedCacheKey = teamId
    ? ["team-board-deleted-items", teamId.toString(), boardId]
    : ["board-deleted-items", boardId];

  switch (operation) {
    case "create":
    case "restore":
      queryClient.setQueryData(boardCacheKey, (old) => [
        ...(old || []),
        { type: itemType, item },
      ]);
      break;

    case "update":
      queryClient.setQueryData(boardCacheKey, (old) =>
        old?.map((i) =>
          i.type === itemType && i.item.id === item.id ? { ...i, item } : i,
        ),
      );
      break;

    case "delete":
      queryClient.setQueryData(boardCacheKey, (old) =>
        old?.filter((i) => !(i.type === itemType && i.item.id === item.id)),
      );
      break;
  }
};
```

---

## ğŸ”’ ç«¶åˆãƒã‚§ãƒƒã‚¯ï¼ˆãƒãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ - Step 3ï¼‰

### APIå´ï¼ˆå…±é€šãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ï¼‰

```typescript
// apps/api/src/middleware/conflict-check.ts
export const conflictCheck = async (
  tableName: string,
  id: number,
  clientUpdatedAt: string,
  db: D1Database,
): Promise<{ conflict: boolean; reason?: string }> => {
  const current = await db
    .prepare(`SELECT updatedAt FROM ${tableName} WHERE id = ?`)
    .bind(id)
    .first();

  if (!current) {
    return { conflict: true, reason: "not_found" };
  }

  if (current.updatedAt !== clientUpdatedAt) {
    return { conflict: true, reason: "outdated" };
  }

  return { conflict: false };
};
```

### ãƒ•ãƒ­ãƒ³ãƒˆå´ï¼ˆ409ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼‰

```typescript
onError: (error, variables, context) => {
  // ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
  if (context?.previousData) {
    queryClient.setQueryData(cacheKey, context.previousData);
  }

  // ç«¶åˆã‚¨ãƒ©ãƒ¼
  if (error.status === 409) {
    toast.error("ä»–ã®ãƒ¡ãƒ³ãƒãƒ¼ãŒå¤‰æ›´ã—ã¾ã—ãŸ");
    // æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã§æ›´æ–°
    updateItemCache({
      queryClient,
      itemType: variables.itemType,
      operation: "update",
      item: error.latestData,
      teamId: variables.teamId,
    });
  }
};
```

---

## ğŸš« ç¦æ­¢äº‹é …

```typescript
// âŒ invalidate + refetch ã®ä½µç”¨
queryClient.invalidateQueries(["tasks"]);
queryClient.refetchQueries(["tasks"]);

// âŒ predicateã«ã‚ˆã‚‹åºƒç¯„å›²ãƒãƒƒãƒ
queryClient.invalidateQueries({
  predicate: (query) => query.queryKey[0] === "boards",
});

// âŒ setTimeoutã§ã®é…å»¶refetch
setTimeout(() => queryClient.refetchQueries(["tasks"]), 1000);

// âŒ keepPreviousData: trueï¼ˆä¸€è¦§ç³»ï¼‰
// âŒ ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£åˆ¥ã«ãƒãƒ©ãƒãƒ©ãªå®Ÿè£…
```

---

## âœ… ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### æ–°ã—ã„mutationè¿½åŠ æ™‚

- [ ] å…±é€šã® updateItemCache ã‚’ä½¿ã£ã¦ã„ã‚‹ã‹
- [ ] invalidateQueries ã‚’ä½¿ã£ã¦ã„ãªã„ã‹ï¼ˆä¾‹å¤–é™¤ãï¼‰
- [ ] refetchQueries ã‚’ä½¿ã£ã¦ã„ãªã„ã‹
- [ ] ãƒœãƒ¼ãƒ‰é€£æºãŒã‚ã‚‹å ´åˆã€boardId ã‚’æ¸¡ã—ã¦ã„ã‚‹ã‹
- [ ] ãƒãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã§ updatedAt ã‚’é€ä¿¡ã—ã¦ã„ã‚‹ã‹
- [ ] 409ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒã‚ã‚‹ã‹

---

## ğŸ“ é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

### ä½œæˆäºˆå®š

- `apps/web/src/lib/cache-utils.ts` - å…±é€šã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°é–¢æ•°

### å®Ÿè£…Plan

- `.claude/plans/PETABOO-55_step1_å€‹äººãƒ¢ãƒ¼ãƒ‰.md`

### ç¾çŠ¶åˆ†æ

- `.claude/é–‹ç™ºãƒ¡ãƒ¢/ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç¾çŠ¶åˆ†æ.md`

### ã‚­ãƒ£ãƒƒã‚·ãƒ¥é–¢é€£ã®ä¸»è¦ãƒ•ã‚¡ã‚¤ãƒ«

| ãƒ•ã‚¡ã‚¤ãƒ«                       | å½¹å‰²          | invalidateæ•° |
| ------------------------------ | ------------- | ------------ |
| use-tasks.ts                   | ã‚¿ã‚¹ã‚¯CRUD    | 17           |
| use-unified-item-operations.ts | çµ±ä¸€å‰Šé™¤/å¾©å…ƒ | 16           |
| use-boards.ts                  | ãƒœãƒ¼ãƒ‰CRUD    | 15           |
| use-memos.ts                   | ãƒ¡ãƒ¢CRUD      | 14           |

---

## ğŸ”® ã‚„ã‚‰ãªã„ã“ã¨ï¼ˆå°†æ¥æ¤œè¨ï¼‰

| é …ç›®         | ç†ç”±                         |
| ------------ | ---------------------------- |
| å·®åˆ†API      | æ¥½è¦³çš„ãƒ­ãƒƒã‚¯ã§ååˆ†           |
| revæ–¹å¼      | è¤‡é›‘åŒ–ã®ã‚ã‚Šã«ãƒ¡ãƒªãƒƒãƒˆå°‘ãªã„ |
| ç·¨é›†ä¸­ãƒ­ãƒƒã‚¯ | æ¥ç¶šç®¡ç†ãŒè¤‡é›‘ã€ä»Šã¯éå‰°     |
| WebSocket    | Cloudflare Workersã§ã¯è¤‡é›‘   |
