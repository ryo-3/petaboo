# ボード削除機能の共通化実装

**実装日**: 2025-11-06
**対応課題**: ボード削除機能が壊れやすい問題（タブ判定ロジックとoriginalId検索の共通化）

---

## 📋 実装内容

### 1. 新規ファイル作成

**`apps/web/src/utils/boardDeleteUtils.ts`**

壊れやすい部分（タブ判定、originalId検索）を共通関数化：

```typescript
// 1. タブ判定ロジックを共通化
shouldUsePermanentDelete(itemType, activeMemoTab, activeTaskTab): boolean

// 2. originalId検索ロジックを共通化
getItemOriginalId(id, itemType, isPermanentDelete, boardItems, boardDeletedItems): string

// 3. ログ出力を統一
logDeleteOperation(itemType, isPermanentDelete, id, originalId, activeTab, context): void
```

### 2. 既存ファイル修正

**`apps/web/src/hooks/use-bulk-delete-operations.tsx`**

#### 変更箇所1: インポート追加（L11-15）

```typescript
import {
  shouldUsePermanentDelete,
  getItemOriginalId,
  logDeleteOperation,
} from "@/src/utils/boardDeleteUtils";
```

#### 変更箇所2: `onApiCall` 内のタブ判定ロジック（L276-327）

**修正前:**

```typescript
if (activeMemoTab === "deleted") {
  const deletedMemo = boardDeletedItems?.memos?.find(m => m.id === id);
  const originalId = deletedMemo?.originalId || id.toString();
  console.log("🗑️ メモ完全削除:", { ... });
  await permanentDeleteMemoMutation.mutateAsync(originalId);
} else {
  await deleteMemoMutation.mutateAsync(id);
}
```

**修正後:**

```typescript
const isPermanentDelete = shouldUsePermanentDelete(itemType, activeMemoTab, activeTaskTab);

if (isPermanentDelete) {
  const originalId = getItemOriginalId(id, "memo", true, boardMemos, boardDeletedItems);
  logDeleteOperation("memo", true, id, originalId, activeMemoTab, { ... });
  await permanentDeleteMemoMutation.mutateAsync(originalId);
} else {
  logDeleteOperation("memo", false, id, id.toString(), activeMemoTab);
  await deleteMemoMutation.mutateAsync(id);
}
```

#### 変更箇所3: `handleRemoveFromBoard` 内の originalId 検索（L442-450）

**修正前:**

```typescript
let originalId: string;
if (deletingItemType === "memo") {
  const memo = boardMemos.find((m) => m.id === id);
  originalId = memo?.originalId || id.toString();
} else {
  const task = boardTasks.find((t) => t.id === id);
  originalId = task?.originalId || id.toString();
}
```

**修正後:**

```typescript
const originalId = getItemOriginalId(
  id,
  deletingItemType,
  false, // ボードから削除は通常削除扱い
  deletingItemType === "memo" ? boardMemos : boardTasks,
  boardDeletedItems,
);
```

---

## ✅ メリット

### 1. 壊れにくい設計

- タブ判定ロジックが一箇所に集約
- メモ一覧/タスク一覧を修正しても、共通関数を更新すればボード詳細も自動的に修正

### 2. 最小限の変更

- チェックボックスロジックは既存実装のまま
- 過去に失敗した「案2: 統一フックへの移行」のようなリスクなし

### 3. デバッグしやすい

- 共通関数に詳細なコメント
- 警告ログで originalId が見つからない場合を検知

### 4. 拡張性

- 将来的に「案4: 専用統一フック」への移行も可能
- 共通関数を活用して段階的にリファクタリング

---

## 🧪 検証項目

### 手動テスト

1. **ボード詳細でメモの通常削除**
   - 通常タブでメモを選択 → 削除
   - ゴミ箱タブに移動することを確認

2. **ボード詳細でメモの完全削除**
   - ゴミ箱タブでメモを選択 → 削除
   - 完全に削除されることを確認

3. **ボード詳細でタスクの通常削除**
   - TODO/進行中/完了タブでタスクを選択 → 削除
   - ゴミ箱タブに移動することを確認

4. **ボード詳細でタスクの完全削除**
   - ゴミ箱タブでタスクを選択 → 削除
   - 完全に削除されることを確認

5. **ボードから削除機能**
   - メモ/タスクをボードから削除
   - ボード一覧から消えることを確認

### 型チェック

- ✅ `npx tsc --noEmit` でエラーなし

---

## 📝 技術的な詳細

### なぜこの設計にしたか

#### 問題の根本原因

- ボード詳細は独自実装（`useBulkDeleteOperations`）
- メモ一覧/タスク一覧は統一フック（`useBulkDeleteUnified`）
- この差異がマージ時のバグの温床

#### 案3を選んだ理由

- **案1（現状維持）**: 壊れやすいまま
- **案2（統一フックへの移行）**: チェックボックスが動かなくなる問題が発生（過去に失敗）
- **案3（タブ判定のみ共通化）**: 最小限の変更で壊れにくくなる ✅
- **案4（専用統一フック）**: 新しいフックの作成が必要（将来的な選択肢）

### 共通関数の設計

#### `shouldUsePermanentDelete()`

- **責務**: タブ状態から完全削除を使用すべきか判定
- **入力**: itemType, activeMemoTab, activeTaskTab
- **出力**: boolean
- **利点**: タブ判定ロジックが一箇所に集約

#### `getItemOriginalId()`

- **責務**: アイテムの originalId を取得
- **入力**: id, itemType, isPermanentDelete, boardItems, boardDeletedItems
- **出力**: originalId (string)
- **利点**:
  - 完全削除時は `boardDeletedItems` から検索
  - 通常削除時は `boardItems` から検索
  - 見つからない場合は警告ログを出力

#### `logDeleteOperation()`

- **責務**: 削除操作のログ出力
- **入力**: itemType, isPermanentDelete, id, originalId, activeTab, context
- **出力**: なし（console.log）
- **利点**: ログ形式が統一され、デバッグしやすい

---

## 🔮 今後の展開

### 次のステップ

1. 手動テストで動作確認
2. 問題なければコミット
3. しばらく運用して安定性を確認

### 将来的な改善

- **案4（専用統一フック）への移行**を検討
- 現在の共通関数を活用しながら、段階的にリファクタリング
- チェックボックスロジックも含めた完全な統一

---

## 📚 関連ドキュメント

- [ボード削除機能が壊れやすい原因と解決策.md](./.開発メモ/ボード削除機能が壊れやすい原因と解決策.md)
- [use-bulk-delete-operations.tsx](../../apps/web/src/hooks/use-bulk-delete-operations.tsx)
- [boardDeleteUtils.ts](../../apps/web/src/utils/boardDeleteUtils.ts)
