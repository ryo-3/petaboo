# 📱 モバイルフッター切り替えロジック完全ガイド

## 🎯 1. フッター切り替えの核心ロジック（最重要）

### どこを見ればいい？

**[sidebar.tsx:170-174](apps/web/components/layout/sidebar.tsx#L170-L174)**

```typescript
// モバイルでメモエディターが開いている場合は専用フッターを表示
// 新規作成時（selectedMemoId === null かつ isCreatingMemo === true）も含む
const isShowingMemoEditor = selectedMemoId !== undefined || isCreatingMemo;

// モバイルでタスクエディターが開いている場合は専用フッターを表示
// 新規作成時も含む
const isShowingTaskEditor = selectedTaskId !== undefined || isCreatingTask;
```

**👉 この2つの変数が `true` になるとモバイルフッターが切り替わる！**

---

## 🔄 2. フッター表示の優先順位

**[sidebar.tsx:177-262](apps/web/components/layout/sidebar.tsx#L177-L262)**

```
優先順位: タスクエディターフッター > メモエディターフッター > 通常フッター (null)
```

```typescript
const mobileFooter = isShowingTaskEditor ? (
  // タスクエディター用フッター（ItemEditorFooter type="task"）
  <ItemEditorFooter type="task" ... />
) : isShowingMemoEditor ? (
  // メモエディター用フッター（ItemEditorFooter type="memo"）
  <ItemEditorFooter type="memo" ... />
) : null;
  // 通常時はフッターなし（通常のサイドバーが表示される）
```

---

## 📍 3. 重要な変数の追跡場所

### 個人モード（ルートページ）

#### `isCreatingMemo` と `isCreatingTask` の生成

**[main-client-mobile.tsx:59-60](apps/web/components/client/main-client-mobile.tsx#L59-L60)**

```typescript
const isCreatingMemo = screenMode === "create" && currentMode === "memo";
const isCreatingTask = screenMode === "create" && currentMode === "task";
```

👉 `screenMode` が `"create"` かつ `currentMode` が `"memo"` or `"task"` で判定

#### `selectedMemoId` と `selectedTaskId`

- 親コンポーネント（`page.tsx` など）から Props として渡される
- メモ/タスクを選択すると `undefined` 以外の値になる

---

### チームモード（`/team/[customUrl]` ページ）

#### `isCreatingMemo` と `isCreatingTask` の管理

**[team-detail-context.tsx:46-47](apps/web/src/contexts/team-detail-context.tsx#L46-L47)**

```typescript
const [isCreatingMemo, setIsCreatingMemo] = useState(false);
const [isCreatingTask, setIsCreatingTask] = useState(false);
```

👉 TeamDetailContext で状態管理（useState）

#### 状態の更新タイミング例

**[memo-screen.tsx:347](apps/web/components/screens/memo-screen.tsx#L347)**

```typescript
useEffect(() => {
  if (teamDetailContext) {
    teamDetailContext.setIsCreatingMemo(memoScreenMode === "create");
  }
}, [memoScreenMode, teamDetailContext]);
```

👉 MemoScreenの`memoScreenMode`が"create"になると自動的にContextを更新

---

### Sidebar での Props と Context の統合

**[sidebar.tsx:89-100](apps/web/components/layout/sidebar.tsx#L89-L100)**

```typescript
let isCreatingMemo = isCreatingMemoProp ?? false;
let isCreatingTask = isCreatingTaskProp ?? false;

// チームモードの場合はTeamDetailContextからも取得
if (isTeamMode) {
  try {
    const teamDetail = useTeamDetail();
    isCreatingMemo = teamDetail.isCreatingMemo;
    isCreatingTask = teamDetail.isCreatingTask ?? false;
  } catch {
    // チームモード外では無視
  }
}
```

👉 チームモードでは Context を優先、個人モードでは Props を使用

---

## 🎪 4. イベントシステム全体図

### イベントフロー

```
【発火元】
Sidebar (ItemEditorFooter の onBack)
  ↓
【発火されるイベント】
  個人モード:
    - memo-editor-mobile-back-requested    (メモ一覧へ戻る)
    - task-editor-mobile-back-requested    (タスク一覧へ戻る)

  チームモード:
    - team-back-to-memo-list              (メモ一覧へ戻る)
    - team-back-to-task-list              (タスク一覧へ戻る)
  ↓
【受信・処理】
  個人モード:
    - memo-editor.tsx (メモエディター本体)
    - task-screen.tsx (タスク画面)
    - create-screen.tsx (新規作成画面)
    - memo-screen.tsx (メモ一覧画面)

  チームモード:
    - memo-screen.tsx (team-back-to-memo-list を受信)
    - task-screen.tsx (team-back-to-task-list を受信)
    - team-detail.tsx (両イベントを受信して状態更新)
```

### イベント名の使い分け

**メモの戻るボタン - [sidebar.tsx:228-234](apps/web/components/layout/sidebar.tsx#L228-L234)**

```typescript
const backEventName = isTeamMode
  ? "team-back-to-memo-list"
  : "memo-editor-mobile-back-requested";
window.dispatchEvent(new CustomEvent(backEventName));
```

**タスクの戻るボタン - [sidebar.tsx:182-185](apps/web/components/layout/sidebar.tsx#L182-L185)**

```typescript
const backEventName = isTeamMode
  ? "team-back-to-task-list"
  : "task-editor-mobile-back-requested";
window.dispatchEvent(new CustomEvent(backEventName));
```

👉 チーム/個人でイベント名を切り替え

---

## 📂 5. 各ファイルの役割と重要な行番号

すべて `apps/web/components/` 配下

| ファイルパス                             | 役割                           | 重要な行番号             | 説明                                              |
| ---------------------------------------- | ------------------------------ | ------------------------ | ------------------------------------------------- |
| **layout/sidebar.tsx**                   | **フッター切り替え本体**       | **89-100, 170-262, 272** | Props/Context統合、判定ロジック、フッター表示制御 |
| **mobile/item-editor-footer.tsx**        | メモ/タスク/ボード統合フッター | 全体                     | type prop でメモ/タスク/ボードを切り替え          |
| **mobile/mobile-fab-button.tsx**         | 新規作成FABボタン              | 全体                     | メモ/タスクのFABボタンを統一化                    |
| **client/main-client-mobile.tsx**        | 個人モード状態生成             | 59-60, 91-92             | screenMode から isCreating 判定                   |
| **src/contexts/team-detail-context.tsx** | チームモード状態管理           | 46-47, 65-67             | Context で状態を一元管理                          |
| **features/team/team-detail.tsx**        | チームページ本体               | 450-462, 980-996         | イベントハンドラー、Context更新                   |
| **screens/memo-screen.tsx**              | メモ一覧画面                   | 347, 653-688             | Context 更新 + イベント受信                       |
| **screens/task-screen.tsx**              | タスク画面                     | 389-414                  | イベント受信処理                                  |

---

## 🔍 6. デバッグ時のチェックポイント

### フッターが切り替わらない場合

1. **判定ロジックを確認**
   - `sidebar.tsx:170-174` の `isShowingMemoEditor` / `isShowingTaskEditor` の値をログ出力
   - `selectedMemoId !== undefined` または `isCreatingMemo` が `true` になっているか？

2. **Props/Context の値を確認**
   - 個人モード: `main-client-mobile.tsx:59-60` の `screenMode` と `currentMode` をログ出力
   - チームモード: `team-detail-context.tsx:46-47` の状態をログ出力

3. **Sidebar への伝播を確認**
   - `sidebar.tsx:89-100` で Props/Context が正しく統合されているか？
   - `isTeamMode` の判定が正しいか？

4. **表示条件を確認**
   - `sidebar.tsx:272` の `className` に `hidden md:flex` が含まれているか？
   - モバイル時に通常フッターが非表示になっているか？

### イベントが発火しない場合

1. **イベント名を確認**
   - チーム/個人で正しいイベント名が使われているか？
   - `sidebar.tsx:182-185, 228-234` のイベント名を確認

2. **リスナー登録を確認**
   - 該当画面（memo-screen, task-screen など）でリスナーが登録されているか？
   - `useEffect` の依存配列が正しいか？

3. **イベント受信を確認**
   - `console.log` でイベント受信を確認
   - ログに受信メッセージが表示されているか？

---

## 💡 7. よくある問題パターン

### パターン1: 新規作成時にフッターが表示されない

**原因:** `isCreatingMemo` / `isCreatingTask` が `false` のまま

**確認箇所:**

- 個人モード: `screenMode` が `"create"` になっているか？
- チームモード: Context の `isCreatingMemo` が `true` になっているか？

### パターン2: 通常フッターとエディターフッターが両方表示される

**原因:** `sidebar.tsx:272` の条件分岐が正しく動作していない

**確認箇所:**

```typescript
className={`... ${isShowingMemoEditor ? "hidden md:flex" : "flex"}`}
```

👉 `isShowingMemoEditor` が `true` の時にモバイルで `hidden` になるか？

### パターン3: チーム/個人でフッターの動作が異なる

**原因:** イベント名の不一致、または Context の使い分けミス

**確認箇所:**

- `sidebar.tsx:89-100` の `isTeamMode` 判定
- `sidebar.tsx:182-185, 228-234` のイベント名切り替え
- リスナー側のイベント名（`team-` プレフィックスの有無）

---

## ➕ 8. モバイル右下の新規追加ボタン（FAB）

### 共通化されたFABボタンコンポーネント

**[mobile-fab-button.tsx](apps/web/components/ui/buttons/mobile-fab-button.tsx)**

```typescript
export default function MobileFabButton({
  type,
  teamMode,
  show = true,
}: MobileFabButtonProps) {
  const config = {
    memo: {
      color: "bg-Green hover:bg-Green/90",
      eventName: teamMode ? "team-memo-create" : "personal-memo-create",
    },
    task: {
      color: "bg-DeepBlue hover:bg-DeepBlue/90",
      eventName: teamMode ? "team-task-create" : "personal-task-create",
    },
  };
  // ...
}
```

### 使用例

**メモ一覧画面 - [memo-screen.tsx:1023-1027](apps/web/components/screens/memo-screen.tsx#L1023-L1027)**

```typescript
<MobileFabButton
  type="memo"
  teamMode={teamMode}
  show={activeTab !== "deleted"}
/>
```

**タスク一覧画面 - [task-screen.tsx](apps/web/components/screens/task-screen.tsx)**

```typescript
<MobileFabButton
  type="task"
  teamMode={teamMode}
  show={activeTab !== "deleted"}
/>
```

### デザイン仕様

**配置:**

- `fixed bottom-16 right-2`: 下部フッター（h-14）の上、右端から8px
- `size-9`: 36px × 36px（正円）
- `z-20`: フッターより前面に表示

**カラー:**

- メモ: `bg-Green` (緑色)
- タスク: `bg-DeepBlue` (青色)

**表示条件:**

- `md:hidden`: モバイルのみ表示（PC では非表示）
- メモ/タスク一覧画面でのみ表示
- エディター画面では非表示（フッターが切り替わる）
- 削除済みタブでは非表示

### 動作

1. **クリック時の処理:**
   - チーム/個人モードに応じたイベントを発火
   - `team-memo-create` / `personal-memo-create`
   - `team-task-create` / `personal-task-create`

2. **フッター切り替えとの連携:**
   ```
   FABボタンをクリック
     ↓
   イベント発火（team-memo-create など）
     ↓
   MemoScreen/TaskScreen がイベント受信
     ↓
   handleCreateNew() 実行 → screenMode が "create" に
     ↓
   isCreatingMemo / isCreatingTask が true に
     ↓
   sidebar.tsx:170-174 の判定で isShowingMemoEditor / isShowingTaskEditor が true に
     ↓
   モバイルフッターがエディター用に切り替わる
     ↓
   FABボタンは非表示になる（エディター画面のため）
   ```

---

## 🔧 9. チーム側の新規作成・戻る処理（重要）

### チーム側の新規作成から一覧に戻るフロー

```
1. ユーザーがFABボタン（右下の+ボタン）をクリック
   ↓
2. MobileFabButton が team-memo-create / team-task-create イベントを発火
   ↓
3. MemoScreen / TaskScreen がイベントを受信
   ↓
4. handleCreateNew() が実行され、memoScreenMode / taskScreenMode が "create" に
   ↓
5. MemoScreen の useEffect で teamDetailContext.setIsCreatingMemo(true) を実行
   ↓
6. Sidebar の isCreatingMemo が true になり、ItemEditorFooter が表示される
   ↓
【戻るボタンをクリック】
   ↓
7. Sidebar が team-back-to-memo-list / team-back-to-task-list イベントを発火
   ↓
8. MemoScreen / TaskScreen がイベントを受信（handleBackRequest）
   ↓
9. setMemoScreenMode("list") で新規作成モードを解除 ← これが重要！
   ↓
10. onDeselectAndStayOnMemoList() を呼び出し
   ↓
11. team-detail.tsx の handleBackToMemoList が実行
   ↓
12. setIsCreatingMemo(false) で状態をクリア
   ↓
13. Sidebar の isCreatingMemo が false になり、通常フッターに戻る
   ↓
14. メモ/タスク一覧が表示される
```

### 重要な実装ポイント

**[memo-screen.tsx:653-688](apps/web/components/screens/memo-screen.tsx#L653-L688)**

```typescript
const handleBackRequest = () => {
  // 新規作成モードから抜ける（これがないと一覧に戻れない！）
  if (screenMode === "create") {
    console.log("→ setMemoScreenMode('list') を呼び出し");
    setMemoScreenMode("list");
  }

  if (onDeselectAndStayOnMemoList) {
    console.log("→ onDeselectAndStayOnMemoList() を呼び出し");
    onDeselectAndStayOnMemoList();
  } else {
    console.log("→ onSelectMemo(null) を呼び出し");
    onSelectMemo(null);
  }
};

// チーム/個人で異なるイベント名をリッスン
const backEventName = teamMode
  ? "team-back-to-memo-list"
  : "memo-editor-mobile-back-requested";
window.addEventListener(backEventName, handleBackRequest);
```

**[task-screen.tsx:389-414](apps/web/components/screens/task-screen.tsx#L389-L414)**

```typescript
const handleBackRequest = () => {
  const backEventName = teamMode
    ? "team-back-to-task-list"
    : "task-editor-mobile-back-requested";
  console.log(`📱 TaskScreen: ${backEventName} イベント受信`);
  // タスクエディターを閉じてリストに戻る
  console.log("→ onSelectTask(null) 呼び出し");
  onSelectTaskRef.current(null);
};

// チーム/個人で異なるイベント名をリッスン
const backEventName = teamMode
  ? "team-back-to-task-list"
  : "task-editor-mobile-back-requested";
window.addEventListener(backEventName, handleBackRequest);
```

**[team-detail.tsx:450-462, 980-996](apps/web/components/features/team/team-detail.tsx)**

```typescript
// イベントハンドラー
const handleBackToMemoList = (_event: CustomEvent) => {
  console.log("📱 team-back-to-memo-list イベント受信");
  setSelectedMemo(null);
  setSelectedDeletedMemo(null);
  setIsCreatingMemo(false); // ← Context の状態をクリア
  console.log("→ setIsCreatingMemo(false) 呼び出し");
  // URL更新 + router.replace
};

// MemoScreen に渡す props
onDeselectAndStayOnMemoList={() => {
  console.log("📱 onDeselectAndStayOnMemoList 呼び出し");
  // URL更新 + 状態クリア
  setSelectedMemo(null);
  setSelectedDeletedMemo(null);
  setIsCreatingMemo(false); // ← これも必要！
  console.log("→ setIsCreatingMemo(false) 完了");
}}
```

### よくあるエラーと解決策

#### エラー1: 戻るボタンを押しても一覧に戻らない

**原因:** `MemoScreen` / `TaskScreen` で `setScreenMode("list")` を呼んでいない

**解決:** `handleBackRequest` 内で `screenMode === "create"` の時に `setScreenMode("list")` を呼ぶ

#### エラー2: イベントが受信されない

**原因:** イベント名の不一致（`team-task-editor-mobile-back-requested` vs `team-back-to-task-list`）

**解決:** Sidebar とリスナー側のイベント名を統一する

#### エラー3: 無限ループが発生する

**原因:** `team-detail.tsx` が同じイベントを再発火している

**解決:** `team-detail.tsx` では `team-memo-create` / `team-task-create` をリッスンしない（MemoScreen/TaskScreen に任せる）

---

## 🏗️ 10. ボード詳細ページのフッター

### チーム側のボード詳細ページ専用フッター

**[team/[customUrl]/layout.tsx:350-377](apps/web/app/team/[customUrl]/layout.tsx#L350-L377)**

```typescript
{isTeamBoardDetailPage ? (
  // ボード詳細専用ナビゲーション：ItemEditorFooterを使用
  <ItemEditorFooter
    type="board"
    onBack={handleBackToBoardList}
    onMemoClick={() =>
      window.dispatchEvent(
        new CustomEvent("board-section-change", {
          detail: { section: "memos" },
        }),
      )
    }
    onTaskClick={() =>
      window.dispatchEvent(
        new CustomEvent("board-section-change", {
          detail: { section: "tasks" },
        }),
      )
    }
    onCommentClick={() =>
      window.dispatchEvent(
        new CustomEvent("board-section-change", {
          detail: { section: "comments" },
        }),
      )
    }
    activeSection={activeBoardSection}
  />
) : (
  // 通常のサイドバーナビゲーション
  <Sidebar ... />
)}
```

### ItemEditorFooter の type="board" 対応

**[item-editor-footer.tsx](apps/web/components/mobile/item-editor-footer.tsx)**

```typescript
interface BoardFooterProps {
  type: "board";
  onBack: () => void;
  onMemoClick: () => void;
  onTaskClick: () => void;
  onCommentClick: () => void;
  activeSection: "memos" | "tasks" | "comments";
  commentCount?: number;
}

type ItemEditorFooterProps = EditorFooterProps | BoardFooterProps;
```

### ボード詳細フッターのボタン構成

```
戻る | メモ | タスク | コメント
```

- **戻る**: ボード一覧に戻る
- **メモ**: ボード内のメモセクションを表示
- **タスク**: ボード内のタスクセクションを表示
- **コメント**: ボードコメントセクションを表示

---

## 📌 11. まとめ

### フッター切り替えの流れ

```
1. ユーザーがメモ/タスクを選択 or 新規作成ボタンをクリック
   ↓
2. selectedMemoId / selectedTaskId が設定される
   または isCreatingMemo / isCreatingTask が true になる
   ↓
3. Sidebar の Props/Context に値が伝播
   ↓
4. sidebar.tsx:170-174 で isShowingMemoEditor / isShowingTaskEditor が true に
   ↓
5. sidebar.tsx:177-262 の三項演算子で適切なフッターを返す
   ↓
6. モバイル時のみフッターが表示され、通常サイドバーは hidden になる
```

### 最重要ファイル

1. **[sidebar.tsx](apps/web/components/layout/sidebar.tsx)** - フッター切り替え本体
2. **[item-editor-footer.tsx](apps/web/components/mobile/item-editor-footer.tsx)** - 統合フッターコンポーネント（memo/task/board対応）
3. **[team-detail-context.tsx](apps/web/src/contexts/team-detail-context.tsx)** - チームモード状態管理
4. **[memo-screen.tsx](apps/web/components/screens/memo-screen.tsx)** - メモ画面（戻る処理実装）
5. **[task-screen.tsx](apps/web/components/screens/task-screen.tsx)** - タスク画面（戻る処理実装）

---

**最終更新日:** 2025-10-31
**対象バージョン:** Next.js 15.3.0 / React 19.0.0
**主な修正:** チーム側新規作成時の戻るボタン実装、FAB統一化、ボード詳細フッター対応
