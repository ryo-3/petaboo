# 個人側リファクタリング - チーム側統一計画

> ⚠️ Codexに実装依頼する際は、以下を厳守すること：
>
> - **既存ファイルを丸ごと再生成させないこと**
>   → Codexへの依頼は必ず **差分（patch形式）** で行う
> - **日本語コメント・文字列を扱う場合はUTF-8前提で依頼すること**
>   → 文字化け防止のため明記する
> - **Codexに git add / git commit を実行させないこと**
> - **完了した場合ファイルを`.claude/fixed-plans` に移動する**

---

## 📋 背景・現状の問題

### 現在の構造の問題点

1. **個人とチームでディレクトリ構造が違いすぎる**

   ```
   個人側：
   - メモ・タスク → / (page.tsx)
   - ボード詳細 → /boards/[slug]

   チーム側：
   - すべて統一 → /team/[customUrl]?tab=memos|tasks|boards
   ```

2. **コンポーネントの設計が分断されている**
   - 個人側：レガシーな実装が多い
   - チーム側：新しい設計パターン、モバイル対応も考慮済み
   - 共通化されていないため、バグ修正が二重管理になる

3. **モバイル版の未保存確認が個人側で動かない**
   - チーム側では動作する可能性が高い
   - 個人側の複雑な構造が原因で修正が困難

4. **URL設計の一貫性がない**
   - チーム：`/team/xxx?tab=boards&slug=yyy` → 分かりやすい
   - 個人：`/boards/yyy` → 他の画面と統一感がない

---

## 🎯 最終目標（3段階）

### Phase 1: チーム側を完成させる（短期・優先度：高）

**目的：** チーム側をリファレンス実装として完成させる

**実施内容：**

1. チーム詳細画面のモバイル対応を完璧にする
   - タブ切り替え（メモ・タスク・ボード）
   - ボード詳細の未保存確認モーダル
   - FABボタン、戻るボタンの動作

2. チーム側のバグを全て潰す
   - 既知の不具合を修正
   - エッジケースの対応

3. チーム側のコード品質を上げる
   - 型安全性の向上
   - パフォーマンス最適化
   - 不要なログの削除

**成果物：**

- `/team/[customUrl]` が完璧に動作する状態
- モバイル・デスクトップ両対応
- これが個人側のお手本になる

---

### Phase 2: 個人側をチーム側と同じ設計に統一（中期・優先度：中）

**目的：** 個人側を段階的にチーム側と同じパターンに移行

#### 2-1. ディレクトリ構造の統一

**現在：**

```
apps/web/app/
├── page.tsx              # メモ・タスク一覧
├── boards/[slug]/        # ボード詳細（別ルート）
└── team/[customUrl]/     # チーム詳細（全部入り）
```

**変更後（案A - シンプル）：**

```
apps/web/app/
├── page.tsx              # 個人画面（メモ・タスク・ボード全部、タブ切り替え）
└── team/[customUrl]/     # チーム詳細
```

**変更後（案B - 明示的）：**

```
apps/web/app/
├── personal/
│   └── page.tsx          # /personal → メモ・タスク・ボード（タブ）
├── team/[customUrl]/     # /team/xxx?tab=...
└── page.tsx              # / → どちらかにリダイレクト or 選択画面
```

**実施手順：**

1. 新しい個人画面用コンポーネントを作成
   - チーム詳細画面のコンポーネントをベースにする
   - `teamId` が `null` の場合は個人モードとして動作

2. タブ実装
   - メモタブ：既存のメモ一覧を移植
   - タスクタブ：既存のタスク一覧を移植
   - ボードタブ：既存のボード一覧を移植

3. ボード詳細の統合
   - `/boards/[slug]` を廃止
   - `/?tab=boards&slug=xxx` のようなクエリパラメータ方式に変更
   - または `/personal?tab=boards&slug=xxx`

4. 段階的移行
   - 新旧両方を並行稼働させる期間を設ける
   - フィーチャーフラグで切り替え可能にする
   - テスト完了後に旧版を削除

#### 2-2. コンポーネントの統一

**共通化するコンポーネント：**

1. **画面全体のレイアウト**
   - `TeamDetailScreen` → `UnifiedScreen` にリネーム
   - Props: `{ teamId?: number, userId: string }`
   - teamIdがあればチームモード、なければ個人モード

2. **タブコンポーネント**
   - `TeamTabs` → `UnifiedTabs` にリネーム
   - メモ・タスク・ボード・設定タブ

3. **アイテム一覧**
   - `TeamMemoList` と `PersonalMemoList` を統合
   - `TeamTaskList` と `PersonalTaskList` を統合
   - `TeamBoardList` と `PersonalBoardList` を統合

4. **アイテム詳細**
   - `MemoEditor` は既に共通化済み（良い例）
   - `TaskEditor` も同様に共通化
   - `BoardDetailScreen` も共通化（現在は個人側のみ）

**実施手順：**

1. 既存のチーム側コンポーネントを抽象化
2. `teamId` による条件分岐を追加
3. 個人側のデータフェッチロジックを統合
4. 段階的に置き換え

---

### Phase 3: 完全統一とコード削減（長期・優先度：低）

**目的：** 重複コードを完全に排除し、保守性を最大化

**実施内容：**

1. **レガシーコードの削除**
   - 旧個人画面の完全削除
   - 使われていないhooksの削除
   - 重複したユーティリティ関数の統合

2. **型定義の統一**
   - `PersonalMemo` と `TeamMemo` → `Memo` に統一
   - `PersonalTask` と `TeamTask` → `Task` に統一
   - 共通型定義を `packages/` に移動

3. **Hooks の統一**
   - `useMemos` と `useTeamMemos` → `useMemos({ teamId? })` に統一
   - `useTasks` と `useTeamTasks` → `useTasks({ teamId? })` に統一
   - `useBoards` と `useTeamBoards` → `useBoards({ teamId? })` に統一

4. **API エンドポイントの統一**
   - 個人用とチーム用で別々のエンドポイントを統合
   - クエリパラメータ `?teamId=xxx` で切り替え
   - 例：`GET /memos` → `GET /memos?teamId=xxx` (なければ個人)

**成果物：**

- コードベースが大幅に削減
- 個人とチームで99%同じコードを使用
- バグ修正が一箇所で済む

---

## 📊 優先順位と実施タイミング

### 今すぐやること（Phase 1）

- [x] この計画書の作成
- [ ] チーム側の既知バグリストアップ
- [ ] チーム側モバイル対応の完成
- [ ] チーム側のボード詳細未保存確認の実装・検証

### 次にやること（Phase 2）

- [ ] 新個人画面のディレクトリ構造決定（案A or 案B）
- [ ] UnifiedScreen コンポーネントの設計
- [ ] メモタブの実装・移行
- [ ] タスクタブの実装・移行
- [ ] ボードタブの実装・移行
- [ ] 旧個人画面との並行稼働
- [ ] ユーザーテスト
- [ ] 旧個人画面の削除

### 将来的にやること（Phase 3）

- [ ] Hooks の統一
- [ ] API エンドポイントの統一
- [ ] レガシーコード削除
- [ ] 型定義の完全統一

---

## 🚨 現在の未保存確認モーダル問題について

**結論：** Phase 1 完了まで一旦保留

**理由：**

1. 個人側のボード詳細は構造が複雑すぎて修正が困難
2. チーム側で同じ機能を実装すれば、それをコピーできる
3. 時間対効果が悪すぎる（泥沼化している）

**代替案：**

- 個人側ボード詳細では一旦諦める
- メモ一覧・タスク一覧では動作しているのでそれで良しとする
- Phase 2 で新個人画面に移行したタイミングで自然に解決

---

## 💡 設計上の重要な決定事項

### URL設計

**個人モード：**

```
オプションA（シンプル）：
/ → メモ・タスク・ボード全部
/?tab=memos → メモタブ
/?tab=tasks → タスクタブ
/?tab=boards → ボード一覧タブ
/?tab=boards&slug=xxx → ボード詳細

オプションB（明示的）：
/personal → 個人画面
/personal?tab=memos
/personal?tab=boards&slug=xxx
```

**チームモード：**

```
/team/my-team → チーム詳細（デフォルトタブ）
/team/my-team?tab=memos → メモタブ
/team/my-team?tab=boards&slug=xxx → ボード詳細
```

**推奨：** オプションA（シンプル）

- URLが短い
- 個人モードはデフォルトなので `/` で十分

### データフェッチ戦略

**統一パターン：**

```typescript
// Before (分断)
const personalMemos = useMemos();
const teamMemos = useTeamMemos(teamId);

// After (統一)
const memos = useMemos({ teamId: teamMode ? teamId : undefined });
```

**利点：**

- コンポーネント側は同じhookを使える
- teamIdの有無で自動的に個人/チーム切り替え
- キャッシュキーも統一しやすい

### コンポーネント設計

**統一コンポーネントの例：**

```typescript
interface UnifiedScreenProps {
  teamId?: number;        // undefined = 個人モード
  teamName?: string;      // チーム名（チームモードのみ）
  userId: string;         // ログインユーザーID
  initialTab?: string;    // 初期表示タブ
}

function UnifiedScreen({ teamId, teamName, userId, initialTab }: UnifiedScreenProps) {
  const isTeamMode = teamId !== undefined;

  // データフェッチは全て同じhookで
  const memos = useMemos({ teamId });
  const tasks = useTasks({ teamId });
  const boards = useBoards({ teamId });

  // UI も 99% 同じ
  return (
    <div>
      <Header title={isTeamMode ? teamName : "個人"} />
      <Tabs>
        <TabPanel name="memos">
          <MemoList memos={memos} teamId={teamId} />
        </TabPanel>
        <TabPanel name="tasks">
          <TaskList tasks={tasks} teamId={teamId} />
        </TabPanel>
        <TabPanel name="boards">
          <BoardList boards={boards} teamId={teamId} />
        </TabPanel>
      </Tabs>
    </div>
  );
}
```

---

## ✅ チェックリスト（Phase 1 - チーム側完成）

### モバイル対応

- [ ] チーム詳細のタブ切り替え動作確認
- [ ] チームボード詳細の未保存確認モーダル実装
- [ ] チームメモエディタの未保存確認動作確認
- [ ] チームタスクエディタの未保存確認動作確認
- [ ] FABボタンの動作確認
- [ ] モバイル戻るボタンの動作確認

### バグ修正

- [ ] 既知バグのリストアップ
- [ ] 優先度高バグの修正
- [ ] エッジケースの洗い出し
- [ ] エラーハンドリングの追加

### コード品質

- [ ] TypeScript型エラー 0件
- [ ] ESLint警告 0件
- [ ] 不要なconsole.logの削除
- [ ] パフォーマンス最適化（React.memo等）

### ドキュメント

- [ ] チーム側のコンポーネント構成図作成
- [ ] データフローの図解
- [ ] 個人側移行時の参考資料作成

---

## 📝 次のアクション

1. **今日中：** このPlanをユーザーと合意
2. **今週中：** チーム側の既知バグをリストアップ
3. **来週開始：** チーム側モバイル対応の完成に着手

---

## 💬 質問・確認事項

1. **URL設計はオプションA（シンプル）で良いか？**
   - `/` = 個人画面
   - `/team/xxx` = チーム画面

2. **Phase 1 の完成目標はいつか？**
   - 目安：1-2週間？

3. **Phase 2 の開始タイミングは？**
   - Phase 1 完了後すぐ？
   - 他の優先タスクがあれば後回し？

4. **旧個人画面との並行稼働期間はどれくらい？**
   - フィーチャーフラグで切り替え可能にする期間

---

**作成日：** 2025-11-20
**最終更新：** 2025-11-20
