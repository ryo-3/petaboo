# ãƒãƒ¼ãƒ ç”³è«‹é€šçŸ¥å®Ÿè£…è¨ˆç”»æ›¸

## ğŸ¯ å®Ÿè£…ç›®æ¨™

`http://localhost:7593/team/moricrew` ãƒšãƒ¼ã‚¸ã§**ç®¡ç†è€…ã®ã¿**ãŒãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ãƒãƒ¼ãƒ ç”³è«‹é€šçŸ¥ã‚’å—ã‘å–ã‚‹æ©Ÿèƒ½ã‚’å®Ÿè£…

## ğŸ“‹ å®Ÿè£…ä»•æ§˜

### 1. æ¡ä»¶ä»˜ããƒ­ãƒ³ã‚°ãƒ»ãƒãƒ¼ãƒªãƒ³ã‚°ã®é©ç”¨

**ç™ºå‹•æ¡ä»¶**:

- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒãƒ¼ãƒ è©³ç´°ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ã¦ã„ã‚‹
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãã®ãƒãƒ¼ãƒ ã®ç®¡ç†è€…ã§ã‚ã‚‹
- ãƒ–ãƒ©ã‚¦ã‚¶ã‚¿ãƒ–ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹

**ãƒãƒ¼ãƒªãƒ³ã‚°é–“éš”**: 2åˆ†å¾…æ©Ÿ + å³åº§ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆæ–°è¦ç”³è«‹ãŒã‚ã£ãŸå ´åˆï¼‰

## ğŸ”§ æŠ€è¡“å®Ÿè£…

### Phase 1: ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰å®Ÿè£…

#### 1.1 æ–°APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

```typescript
// apps/api/src/routes/teams/wait-updates.ts
POST / teams / { customUrl } / wait - updates;
```

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:

```json
{
  "lastCheckedAt": "2024-09-11T02:30:00.000Z",
  "waitTimeoutSec": 120
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆæ–°è¦ç”³è«‹æœ‰ã‚Šï¼‰**:

```json
{
  "hasUpdates": true,
  "updates": {
    "newApplications": [
      {
        "id": 123,
        "userId": "user_abc123",
        "displayName": "å±±ç”°å¤ªéƒ",
        "appliedAt": "2024-09-11T02:31:15.000Z"
      }
    ]
  },
  "timestamp": "2024-09-11T02:31:15.000Z"
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‰**:

```json
{
  "hasUpdates": false,
  "timestamp": "2024-09-11T02:32:00.000Z"
}
```

#### 1.2 æ¨©é™ãƒã‚§ãƒƒã‚¯

- JWTè§£æã§ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼
- ãƒãƒ¼ãƒ ç®¡ç†è€…æ¨©é™ç¢ºèª
- ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã¯403ã‚¨ãƒ©ãƒ¼

#### 1.3 åŠ¹ç‡çš„ã‚¯ã‚¨ãƒªè¨­è¨ˆ

```sql
-- æ–°è¦ç”³è«‹ãƒã‚§ãƒƒã‚¯ï¼ˆlastCheckedAtä»¥é™ï¼‰
SELECT ua.id, ua.userId, ua.appliedAt, u.displayName
FROM user_applications ua
JOIN users u ON ua.userId = u.id
WHERE ua.teamId = ?
  AND ua.status = 'pending'
  AND ua.appliedAt > ?
ORDER BY ua.appliedAt DESC;
```

### Phase 2: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰å®Ÿè£…

#### 2.1 æ±ç”¨ãƒ•ãƒƒã‚¯ `useConditionalPolling`

```typescript
// apps/web/src/hooks/use-conditional-polling.ts
export function useConditionalPolling<T>({
  endpoint,
  condition,
  onUpdate,
  waitTimeoutSec = 120,
  enabled = true,
}: ConditionalPollingOptions<T>) {
  // ãƒšãƒ¼ã‚¸ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ¤œçŸ¥
  // æ¡ä»¶è©•ä¾¡
  // ãƒ­ãƒ³ã‚°ãƒ»ãƒãƒ¼ãƒªãƒ³ã‚°å®Ÿè¡Œ
  // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
}
```

#### 2.2 ãƒãƒ¼ãƒ ç”³è«‹å°‚ç”¨ãƒ•ãƒƒã‚¯

```typescript
// apps/web/src/hooks/use-team-applications-polling.ts
export function useTeamApplicationsPolling(customUrl: string) {
  const { user } = useAuth();
  const { data: teamDetail } = useTeamDetail(customUrl);

  return useConditionalPolling({
    endpoint: `/teams/${customUrl}/wait-updates`,
    condition: () => {
      return Boolean(teamDetail?.role === "admin" && document.hasFocus());
    },
    onUpdate: (updates) => {
      // React Query ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°
      queryClient.invalidateQueries(["team-applications", customUrl]);

      // é€šçŸ¥è¡¨ç¤º
      showNotification({
        title: "æ–°ã—ã„ç”³è«‹",
        message: `${updates.newApplications.length}ä»¶ã®æ–°è¦ç”³è«‹ãŒã‚ã‚Šã¾ã™`,
        type: "info",
      });
    },
  });
}
```

#### 2.3 UIçµ±åˆ

**TeamDetail ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆçµ±åˆ**:

```typescript
// apps/web/components/features/team/team-detail.tsx ã«çµ±åˆ
export function TeamDetail({ customUrl }: { customUrl: string }) {
  // æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯...

  // æ¡ä»¶ä»˜ããƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹
  useTeamApplicationsPolling(customUrl);

  // æ—¢å­˜JSX...
}
```

## ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### ãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨é‡äºˆæ¸¬

**å¾“æ¥ã®ãƒãƒ¼ãƒªãƒ³ã‚°ï¼ˆ30ç§’é–“éš”ï¼‰vs æ¡ä»¶ä»˜ããƒ­ãƒ³ã‚°ãƒ»ãƒãƒ¼ãƒªãƒ³ã‚°**:

| æŒ‡æ¨™             | å¾“æ¥  | æ¡ä»¶ä»˜ãLP | å‰Šæ¸›ç‡ |
| ---------------- | ----- | ---------- | ------ |
| APIå‘¼ã³å‡ºã—/æ™‚é–“ | 120å› | 0.5-2å›    | 98.3%  |
| ã‚µãƒ¼ãƒãƒ¼è² è·     | é«˜    | æ¥µå°       | 95%+   |
| é€šä¿¡é‡           | å¤š    | æœ€å°é™     | 90%+   |

### ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£

- **1000ãƒãƒ¼ãƒ åŒæ™‚**: å¾“æ¥120,000ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/æ™‚ â†’ æ¡ä»¶ä»˜ãLP 500-2,000ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/æ™‚
- **ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡**: å¾…æ©Ÿã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†ï¼ˆCloudflare Workerså¯¾å¿œï¼‰

## ğŸš€ æ®µéšçš„å®Ÿè£…ãƒ—ãƒ©ãƒ³

### Step 1: ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰åŸºç›¤

1. `wait-updates` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä½œæˆ
2. æ¨©é™ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½å®Ÿè£…
3. åŠ¹ç‡çš„DB ã‚¯ã‚¨ãƒªå®Ÿè£…

### Step 2: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰åŸºç›¤

1. `useConditionalPolling` æ±ç”¨ãƒ•ãƒƒã‚¯ä½œæˆ
2. ãƒšãƒ¼ã‚¸ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ¤œçŸ¥æ©Ÿèƒ½
3. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° & ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½

### Step 3: æ©Ÿèƒ½çµ±åˆ

1. `useTeamApplicationsPolling` å°‚ç”¨ãƒ•ãƒƒã‚¯
2. TeamDetail ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆçµ±åˆ
3. UIé€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ é€£æº

### Step 4: ãƒ†ã‚¹ãƒˆ & èª¿æ•´

1. ç®¡ç†è€…æ¨©é™ã§ã®ãƒ†ã‚¹ãƒˆ
2. éç®¡ç†è€…ã§ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ãƒ†ã‚¹ãƒˆ
3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®š & èª¿æ•´

## ğŸ¯ æœŸå¾…åŠ¹æœ

1. **çœŸã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ä½“é¨“**: æ–°è¦ç”³è«‹ã‹ã‚‰1-3ç§’ä»¥å†…ã§é€šçŸ¥
2. **ã‚µãƒ¼ãƒãƒ¼è² è·æ¿€æ¸›**: 98%ä»¥ä¸Šã®APIå‘¼ã³å‡ºã—å‰Šæ¸›
3. **æ±ç”¨æ€§**: ãƒ¡ãƒ¢æ›´æ–°ã€ã‚¿ã‚¹ã‚¯å¤‰æ›´ç­‰ã¸ã®æ¨ªå±•é–‹å¯èƒ½
4. **é–‹ç™ºä½“é¨“å‘ä¸Š**: é–‹ç™ºç’°å¢ƒã§ã®ã‚¨ãƒ©ãƒ¼å›é¿

## ğŸ” å®Ÿè£…å¾Œã®æ‹¡å¼µå¯èƒ½æ€§

- **ãƒ¡ãƒ¢ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ**: `useConditionalPolling` å†åˆ©ç”¨
- **ã‚¿ã‚¹ã‚¯é€²æ—é€šçŸ¥**: åŒä¸€ãƒ‘ã‚¿ãƒ¼ãƒ³ã§å®Ÿè£…å¯èƒ½
- **ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼å¤‰æ›´é€šçŸ¥**: ç®¡ç†è€…å‘ã‘è¿½åŠ é€šçŸ¥
- **ãƒãƒ«ãƒãƒãƒ¼ãƒ å¯¾å¿œ**: è¤‡æ•°ãƒãƒ¼ãƒ åŒæ™‚ç›£è¦–

---

> **è¨­è¨ˆæ€æƒ³**: å¿…è¦ãªæ™‚ã ã‘ã€å¿…è¦ãªäººã ã‘ãŒã€å¿…è¦æœ€å°é™ã®ãƒªã‚½ãƒ¼ã‚¹ã§ã€æœ€å¤§é™ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ä½“é¨“ã‚’æä¾›
