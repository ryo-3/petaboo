"use client";

import MemoEditor from "@/components/features/memo/memo-editor";
import TaskEditor from "@/components/features/task/task-editor";
import MemoScreen from "@/components/screens/memo-screen";
import TaskScreen from "@/components/screens/task-screen";
import RightPanel from "@/components/ui/layout/right-panel";
import { Memo, DeletedMemo } from "@/src/types/memo";
import { Task, DeletedTask } from "@/src/types/task";
import type { Tagging, Tag } from "@/src/types/tag";
import type { Board } from "@/src/types/board";
import { useTags } from "@/src/hooks/use-tags";
import { useTeamTags } from "@/src/hooks/use-team-tags";
import { useAllTaggings } from "@/src/hooks/use-all-data";
import { useAllTeamTaggings } from "@/src/hooks/use-team-taggings";
import { useState, useEffect } from "react";
import { useNavigation } from "@/contexts/navigation-context";
import { useAuth } from "@clerk/nextjs";
import { useQueryClient } from "@tanstack/react-query";
import { useCreatorInfo } from "@/src/hooks/use-creator-info";
import { toCreatorProps } from "@/src/types/creator";
import { useUnifiedItemOperations } from "@/src/hooks/use-unified-item-operations";
import {
  useMemoDeleteWithNextSelection,
  useTaskDeleteWithNextSelection,
} from "@/src/hooks/use-memo-delete-with-next-selection";
import { useMemos } from "@/src/hooks/use-memos";
import { useTasks } from "@/src/hooks/use-tasks";

interface BoardRightPanelProps {
  isOpen: boolean;
  boardId: number;
  selectedMemo?: Memo | DeletedMemo | null;
  selectedTask?: Task | DeletedTask | null;
  rightPanelMode: "editor" | "memo-list" | "task-list" | null;
  activeMemoTab?: "normal" | "deleted"; // ÁèæÂú®„ÅÆ„É°„É¢„Çø„Éñ
  selectedItemsFromList: Set<number>;
  allMemos?: Memo[];
  allTasks?: Task[];
  allBoards?: Board[]; // ÂÖ®„Éú„Éº„ÉâÊÉÖÂ†±
  allTaggings?: Tagging[]; // ÂÖ®„Çø„Ç∞ÊÉÖÂ†±
  allBoardItems?: Array<{
    boardId: number;
    boardName: string;
    itemType: "memo" | "task";
    itemId: string;
    originalId: string;
    addedAt: number;
  }>; // ÂÖ®„Éú„Éº„Éâ„Ç¢„Ç§„ÉÜ„É†ÊÉÖÂ†±
  // „ÉÅ„Éº„É†Ê©üËÉΩÈñ¢ÈÄ£
  teamMode?: boolean;
  teamId?: number | null;
  onClose: () => void;
  onSelectMemo?: (memo: Memo) => void;
  onSelectTask?: (task: Task | null, fromFullList?: boolean) => void;
  onAddSelectedItems: () => void;
  onToggleItemSelection: (itemId: number) => void;
  onMemoDeleteAndSelectNext?: (deletedMemo: Memo) => void;
  onTaskDeleteAndSelectNext?: (deletedTask: Task) => void;
  onDeletedMemoDeleteAndSelectNext?: (deletedMemo: DeletedMemo) => void;
  onDeletedTaskDeleteAndSelectNext?: (deletedTask: DeletedTask) => void;
  onMemoRestoreAndSelectNext?: (deletedMemo: DeletedMemo) => void;
  onTaskRestoreAndSelectNext?: (deletedTask: DeletedTask) => void;
  onAddMemoToBoard?: (memo: Memo) => void;
  onAddTaskToBoard?: (task: Task) => void;
}

export default function BoardRightPanel({
  isOpen,
  boardId,
  selectedMemo,
  selectedTask,
  rightPanelMode,
  activeMemoTab = "normal",
  allBoards,
  allTaggings: propsAllTaggings,
  allBoardItems,
  teamMode = false,
  teamId = null,
  onClose,
  onSelectMemo,
  onSelectTask,
  onMemoDeleteAndSelectNext,
  onTaskDeleteAndSelectNext,
  onDeletedMemoDeleteAndSelectNext,
  onDeletedTaskDeleteAndSelectNext,
  onMemoRestoreAndSelectNext,
  onTaskRestoreAndSelectNext,
  onAddMemoToBoard, // eslint-disable-line @typescript-eslint/no-unused-vars
  onAddTaskToBoard, // eslint-disable-line @typescript-eslint/no-unused-vars
}: BoardRightPanelProps) {
  console.log("üìã [BoardRightPanel] Props:", {
    teamMode,
    teamId,
    allBoardsCount: allBoards?.length,
    allBoards: allBoards?.map((b) => ({ id: b.id, name: b.name })),
  });
  const { handleMainSelectMemo, handleMainSelectTask } = useNavigation();
  const { data: personalTags } = useTags();
  const { data: teamTags } = useTeamTags(teamId || 0);
  const tags = teamMode && teamId ? teamTags : personalTags;

  // „Çø„Ç∞‰ªò„Åë„Éá„Éº„Çø„ÇíÁõ¥Êé•ÂèñÂæóÔºàprops„Åß„ÅØ„Å™„ÅèReact Query„Åã„ÇâÊúÄÊñ∞„Éá„Éº„Çø„ÇíÂèñÂæóÔºâ
  const { data: personalTaggings } = useAllTaggings();
  const { data: teamTaggings } = useAllTeamTaggings(teamId || 0);
  const allTaggings = teamMode && teamId ? teamTaggings : personalTaggings;

  const { getToken } = useAuth();
  const queryClient = useQueryClient();

  // „É°„É¢‰∏ÄË¶ß„Éá„Éº„Çø„ÇíÂèñÂæóÔºàÂâäÈô§Âá¶ÁêÜÁî®Ôºâ
  const { data: allMemosData } = useMemos({
    teamMode: teamMode || false,
    teamId: teamMode ? teamId || undefined : undefined,
  });
  const allMemos = allMemosData || [];

  const { data: allTasksData } = useTasks({
    teamMode: teamMode || false,
    teamId: teamMode ? teamId || undefined : undefined,
  });
  const allTasks = allTasksData || [];

  // Áµ±‰∏ÄÊìç‰Ωú„Éï„ÉÉ„ÇØ
  const memoOperations = useUnifiedItemOperations({
    itemType: "memo",
    context: teamMode ? "team" : "board-detail",
    teamId: teamId || undefined,
    boardId,
  });

  const taskOperations = useUnifiedItemOperations({
    itemType: "task",
    context: teamMode ? "team" : "board-detail",
    teamId: teamId || undefined,
    boardId,
  });

  // ÂâäÈô§Âá¶ÁêÜÁî®„ÅÆstate
  const [isRightMemoLidOpen, setIsRightMemoLidOpen] = useState(false);

  // „É°„É¢Áî®ÂÖ±ÈÄöÂâäÈô§„Éï„ÉÉ„ÇØÔºàDOMÂâäÈô§Á¢∫Ë™ç„ÅÆ„Åø„ÄÅAPIÂâäÈô§„ÅØÂà•ÈÄîË°å„ÅÜÔºâ
  const {
    handleDeleteWithNextSelection: handleMemoDeleteWithNextSelection,
    checkDomDeletionAndSelectNext: checkMemoDomDeletionAndSelectNext,
  } = useMemoDeleteWithNextSelection({
    memos: allMemos,
    onSelectMemo: (memo: Memo | null) => {
      if (memo) {
        onSelectMemo?.(memo);
      } else {
        onClose();
      }
    },
    onDeselectAndStayOnMemoList: onClose,
    handleRightEditorDelete: () => {
      // ‰Ωï„ÇÇ„Åó„Å™„ÅÑÔºàÂâäÈô§Âá¶ÁêÜ„ÅØÂ§ñÈÉ®„ÅßÂÆüË°åÊ∏à„ÅøÔºâ
    },
  });

  // „Çø„Çπ„ÇØÁî®ÂÖ±ÈÄöÂâäÈô§„Éï„ÉÉ„ÇØÔºàDOMÂâäÈô§Á¢∫Ë™ç„ÅÆ„Åø„ÄÅAPIÂâäÈô§„ÅØÂà•ÈÄîË°å„ÅÜÔºâ
  const {
    handleDeleteWithNextSelection: handleTaskDeleteWithNextSelection,
    checkDomDeletionAndSelectNext: checkTaskDomDeletionAndSelectNext,
  } = useTaskDeleteWithNextSelection({
    tasks: allTasks,
    onSelectTask: (task: Task | null) => {
      if (task) {
        onSelectTask?.(task);
      } else {
        onClose();
      }
    },
    onDeselectAndStayOnTaskList: onClose,
    handleRightEditorDelete: () => {
      // ‰Ωï„ÇÇ„Åó„Å™„ÅÑÔºàÂâäÈô§Âá¶ÁêÜ„ÅØÂ§ñÈÉ®„ÅßÂÆüË°åÊ∏à„ÅøÔºâ
    },
    setIsRightLidOpen: setIsRightMemoLidOpen,
  });

  // DOMÂâäÈô§Á¢∫Ë™çÔºà„É°„É¢„Éª„Çø„Çπ„ÇØ‰∏ÄË¶ß„ÅåÂ§âÊõ¥„Åï„Çå„Åü„Å®„Åç„Å´„ÉÅ„Çß„ÉÉ„ÇØÔºâ
  useEffect(() => {
    checkMemoDomDeletionAndSelectNext();
  }, [allMemos, checkMemoDomDeletionAndSelectNext]);

  useEffect(() => {
    checkTaskDomDeletionAndSelectNext();
  }, [allTasks, checkTaskDomDeletionAndSelectNext]);

  // „ÉÅ„Éº„É†Ê©üËÉΩÁî®: ‰ΩúÊàêËÄÖÊÉÖÂ†±„ÇíÂèñÂæó
  const { selectedTaskCreatorInfo, selectedMemoCreatorInfo } = useCreatorInfo(
    teamMode,
    teamId,
    selectedMemo,
    selectedTask,
  );

  // ÁèæÂú®„ÅÆ„Éú„Éº„Éâ„Å´Êó¢„Å´ËøΩÂä†„Åï„Çå„Å¶„ÅÑ„Çã„Ç¢„Ç§„ÉÜ„É†ID„ÅÆ„É™„Çπ„Éà„Çí‰ΩúÊàê
  const currentBoardMemoIds =
    allBoardItems
      ?.filter((item) => item.boardId === boardId && item.itemType === "memo")
      .map((item) => parseInt(item.itemId, 10)) || [];

  const currentBoardTaskIds =
    allBoardItems
      ?.filter((item) => item.boardId === boardId && item.itemType === "task")
      .map((item) => parseInt(item.itemId, 10)) || [];

  const [isDeletingMemo, setIsDeletingMemo] = useState(false);

  // ÂâäÈô§Ê∏à„Åø„Ç¢„Ç§„ÉÜ„É†„Åã„Å©„ÅÜ„Åã„ÇíÂà§ÂÆö„Åô„Çã„Éò„É´„Éë„ÉºÈñ¢Êï∞
  const isDeletedMemo = (memo: Memo | DeletedMemo): memo is DeletedMemo => {
    // „Çà„ÇäÁ¢∫ÂÆü„Å™Âà§ÂÆöÔºödeletedAt„Éó„É≠„Éë„ÉÜ„Ç£„ÅåÂ≠òÂú®„Åó„ÄÅÂÄ§„Åå„ÅÇ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
    return (
      "deletedAt" in memo &&
      memo.deletedAt !== undefined &&
      memo.deletedAt !== null &&
      typeof memo.deletedAt === "number" &&
      memo.deletedAt > 0
    );
  };

  const isDeletedTask = (task: Task | DeletedTask): task is DeletedTask => {
    // „Çà„ÇäÁ¢∫ÂÆü„Å™Âà§ÂÆöÔºödeletedAt„Éó„É≠„Éë„ÉÜ„Ç£„ÅåÂ≠òÂú®„Åó„ÄÅÂÄ§„Åå„ÅÇ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
    return (
      "deletedAt" in task &&
      task.deletedAt !== undefined &&
      task.deletedAt !== null &&
      typeof task.deletedAt === "number" &&
      task.deletedAt > 0
    );
  };

  // Áµ±‰∏ÄÂâäÈô§„Éï„ÉÉ„ÇØ„ÅØÂâäÈô§ÔºàMemoScreenÂÜÖ„ÅßÂá¶ÁêÜÔºâ

  // „É°„É¢„Çí„Éú„Éº„Éâ„Å´ËøΩÂä†
  const handleAddMemosToBoard = async (memoIds: number[]) => {
    try {
      const token = await getToken();
      const promises = memoIds.map((memoId) => {
        return fetch(
          `${process.env.NEXT_PUBLIC_API_URL || "http://localhost:7594"}/boards/${boardId}/items`,
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              ...(token && { Authorization: `Bearer ${token}` }),
            },
            body: JSON.stringify({
              itemType: "memo",
              itemId: memoId.toString(),
            }),
          },
        );
      });

      await Promise.all(promises);

      // „Ç≠„É£„ÉÉ„Ç∑„É•„ÇíÁÑ°ÂäπÂåñ„Åó„Å¶„Éú„Éº„Éâ‰∏ÄË¶ß„ÇíÂÜçÂèñÂæó
      queryClient.invalidateQueries({ queryKey: ["boards", boardId, "items"] });
      queryClient.invalidateQueries({ queryKey: ["boards", "all-items"] });
    } catch (error) {
      console.error("„É°„É¢„ÅÆËøΩÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:", error);
    }
  };

  // „Çø„Çπ„ÇØ„Çí„Éú„Éº„Éâ„Å´ËøΩÂä†
  const handleAddTasksToBoard = async (taskIds: number[]) => {
    try {
      const token = await getToken();
      const promises = taskIds.map((taskId) => {
        return fetch(
          `${process.env.NEXT_PUBLIC_API_URL || "http://localhost:7594"}/boards/${boardId}/items`,
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              ...(token && { Authorization: `Bearer ${token}` }),
            },
            body: JSON.stringify({
              itemType: "task",
              itemId: taskId.toString(),
            }),
          },
        );
      });

      await Promise.all(promises);

      // „Ç≠„É£„ÉÉ„Ç∑„É•„ÇíÁÑ°ÂäπÂåñ„Åó„Å¶„Éú„Éº„Éâ‰∏ÄË¶ß„ÇíÂÜçÂèñÂæó
      queryClient.invalidateQueries({ queryKey: ["boards", boardId, "items"] });
      queryClient.invalidateQueries({ queryKey: ["boards", "all-items"] });
    } catch (error) {
      console.error("„Çø„Çπ„ÇØ„ÅÆËøΩÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:", error);
    }
  };

  // „É°„É¢ÂâäÈô§„Éè„É≥„Éâ„É©„ÉºÔºà„É°„É¢„Ç®„Éá„Ç£„Çø„Éº„ÅÆÂâäÈô§Á¢∫Ë™çÂæå„Å´Âëº„Å∞„Çå„ÇãÔºâ
  const handleMemoDelete = async () => {
    if (selectedMemo && !isDeletedMemo(selectedMemo) && !isDeletingMemo) {
      // ÂâäÈô§Âá¶ÁêÜ‰∏≠„Éï„É©„Ç∞„ÇíË®≠ÂÆö
      setIsDeletingMemo(true);

      try {
        const memoId =
          typeof selectedMemo.id === "number"
            ? selectedMemo.id
            : parseInt(selectedMemo.id, 10);
        if (isNaN(memoId)) {
          console.error(`‚ùå ÁÑ°Âäπ„Å™„É°„É¢ID: ${selectedMemo.id}`);
          setIsRightMemoLidOpen(false);
          setIsDeletingMemo(false);
          return;
        }
        // Áµ±‰∏ÄÂâäÈô§„Éï„ÉÉ„ÇØ„Å´„Çà„ÇãÂâäÈô§ÔºàMemoScreenÂÜÖ„ÅßÂá¶ÁêÜ„Åï„Çå„ÇãÔºâ

        // ÂâäÈô§ÊàêÂäüÂæå„Å´Ëìã„ÇíÈñâ„Åò„Çã
        setTimeout(() => {
          setIsRightMemoLidOpen(false);
        }, 200);

        // ÂÖ±ÈÄöÂâäÈô§„Éï„ÉÉ„ÇØ„Çí‰ΩøÁî®„Åó„ÅüÊ¨°ÈÅ∏ÊäûÂá¶ÁêÜ
        try {
          handleMemoDeleteWithNextSelection(selectedMemo as Memo);
        } catch (nextSelectError) {}

        // useDeleteMemo„ÅÆonSuccess„ÅßËá™ÂãïÁöÑ„Å´„Ç≠„É£„ÉÉ„Ç∑„É•„ÅåÁÑ°ÂäπÂåñ„Åï„Çå„Çã„Åü„ÇÅ„ÄÅÊâãÂãï„Åß„ÅÆÁÑ°ÂäπÂåñ„ÅØ‰∏çË¶Å
      } catch (error) {
        // „Ç®„É©„ÉºÊôÇ„ÅØËìã„ÇíÈñâ„Åò„Çã
        setIsRightMemoLidOpen(false);
      } finally {
        // ÂâäÈô§Âá¶ÁêÜ‰∏≠„Éï„É©„Ç∞„Çí„É™„Çª„ÉÉ„Éà
        setIsDeletingMemo(false);
      }
    } else {
    }
  };

  return (
    <RightPanel isOpen={isOpen} onClose={onClose}>
      {selectedMemo && !selectedTask && rightPanelMode === null && (
        <div className="flex flex-col h-full overflow-hidden">
          <div className="flex-shrink-0">
            {activeMemoTab === "deleted" ? (
              <MemoEditor
                memo={selectedMemo}
                onClose={() => {
                  // „Ç®„Éá„Ç£„Çø„ÉºÂÜÖ„Åã„Çâ„ÅÆÈñâ„Åò„ÇãÊìç‰Ωú„ÅØÁÑ°Ë¶ñÔºàÂè≥„Éë„Éç„É´„ÅÆ√ó„Éú„Çø„É≥„ÅÆ„Åø„ÅßÈñâ„Åò„ÇãÔºâ
                }}
                onRestore={async () => {
                  if (
                    selectedMemo &&
                    selectedMemo.originalId &&
                    onMemoRestoreAndSelectNext
                  ) {
                    try {
                      await memoOperations.restoreItem.mutateAsync(
                        selectedMemo.originalId,
                      );
                      onMemoRestoreAndSelectNext(selectedMemo as DeletedMemo);
                    } catch (error) {
                      console.error("„É°„É¢Âæ©ÂÖÉAPIÂÆüË°å„Ç®„É©„Éº:", error);
                    }
                  }
                }}
                onDelete={() => {
                  if (onDeletedMemoDeleteAndSelectNext) {
                    onDeletedMemoDeleteAndSelectNext(
                      selectedMemo as DeletedMemo,
                    );
                  }
                }}
                onDeleteAndSelectNext={(deletedMemo: Memo | DeletedMemo) => {
                  if (onDeletedMemoDeleteAndSelectNext) {
                    onDeletedMemoDeleteAndSelectNext(
                      deletedMemo as DeletedMemo,
                    );
                  }
                }}
                initialBoardId={boardId}
                teamMode={teamMode}
                teamId={teamId || undefined}
                {...toCreatorProps(selectedMemoCreatorInfo)}
                preloadedTags={tags || []}
                preloadedBoards={allBoards || []}
                preloadedTaggings={allTaggings || []}
                preloadedBoardItems={allBoardItems}
              />
            ) : (
              <MemoEditor
                memo={selectedMemo}
                initialBoardId={boardId}
                teamMode={teamMode}
                teamId={teamId || undefined}
                {...toCreatorProps(selectedMemoCreatorInfo)}
                preloadedTags={tags || []}
                preloadedBoards={allBoards || []}
                preloadedTaggings={allTaggings || []}
                preloadedBoardItems={allBoardItems}
                onClose={() => {
                  // „Ç®„Éá„Ç£„Çø„ÉºÂÜÖ„Åã„Çâ„ÅÆÈñâ„Åò„ÇãÊìç‰Ωú„ÅØÁÑ°Ë¶ñÔºàÂè≥„Éë„Éç„É´„ÅÆ√ó„Éú„Çø„É≥„ÅÆ„Åø„ÅßÈñâ„Åò„ÇãÔºâ
                }}
                onSaveComplete={(savedMemo) => {
                  // ‰øùÂ≠òÂæå„Å´ÈÅ∏ÊäûÁä∂ÊÖã„ÇíÊõ¥Êñ∞
                  onSelectMemo?.(savedMemo);
                }}
                onRestore={async () => {
                  if (
                    selectedMemo &&
                    selectedMemo.originalId &&
                    onMemoRestoreAndSelectNext
                  ) {
                    try {
                      await memoOperations.restoreItem.mutateAsync(
                        selectedMemo.originalId,
                      );
                      onMemoRestoreAndSelectNext(selectedMemo as DeletedMemo);
                    } catch (error) {
                      console.error("„É°„É¢Âæ©ÂÖÉAPIÂÆüË°å„Ç®„É©„Éº:", error);
                    }
                  }
                }}
                onDelete={async () => {
                  // „Éú„Éº„ÉâË©≥Á¥∞„Åß„ÅÆ„É°„É¢ÂâäÈô§Âá¶ÁêÜÔºàÂâäÈô§„Éú„Çø„É≥Ë°®Á§∫Áî®Ôºâ
                }}
                onDeleteAndSelectNext={async (deletedMemo: Memo) => {
                  // APIÂâäÈô§ÈñãÂßãÔºàÊ•ΩË¶≥ÁöÑÊõ¥Êñ∞„Åß„Ç¢„Ç§„ÉÜ„É†„ÅåÂç≥Â∫ß„Å´Ê∂à„Åà„ÇãÔºâ
                  const deletePromise = memoOperations.deleteItem.mutateAsync(
                    deletedMemo.id,
                  );

                  // ÂÖ±ÈÄöÂâäÈô§„Éï„ÉÉ„ÇØ„Å´„Çà„ÇãÂá¶ÁêÜÔºàDOMÂâäÈô§Á¢∫Ë™çÊ∏à„ÅøÔºâ
                  handleMemoDeleteWithNextSelection(deletedMemo);

                  // APIÂÆå‰∫Ü„ÇíÂæÖ„Å§
                  await deletePromise;
                }}
                isLidOpen={isRightMemoLidOpen}
              />
            )}
          </div>
        </div>
      )}

      {selectedTask && !selectedMemo && rightPanelMode === null && (
        <div className="flex flex-col h-full overflow-hidden">
          <div className="flex-shrink-0">
            {isDeletedTask(selectedTask) ? (
              <TaskEditor
                task={selectedTask}
                initialBoardId={boardId}
                isFromBoardDetail={true}
                teamMode={teamMode}
                teamId={teamId || undefined}
                {...toCreatorProps(selectedTaskCreatorInfo)}
                preloadedTags={tags || []}
                preloadedBoards={allBoards || []}
                preloadedTaggings={allTaggings || []}
                preloadedBoardItems={allBoardItems}
                onSelectTask={onSelectTask}
                unifiedOperations={taskOperations}
                onClose={() => {
                  // „Ç®„Éá„Ç£„Çø„ÉºÂÜÖ„Åã„Çâ„ÅÆÈñâ„Åò„ÇãÊìç‰Ωú„ÅØÁÑ°Ë¶ñÔºàÂè≥„Éë„Éç„É´„ÅÆ√ó„Éú„Çø„É≥„ÅÆ„Åø„ÅßÈñâ„Åò„ÇãÔºâ
                }}
                onRestore={async () => {
                  if (
                    selectedTask &&
                    selectedTask.originalId &&
                    onTaskRestoreAndSelectNext
                  ) {
                    try {
                      await taskOperations.restoreItem.mutateAsync(
                        selectedTask.originalId,
                      );
                      onTaskRestoreAndSelectNext(selectedTask as DeletedTask);
                    } catch (error) {
                      console.error("„Çø„Çπ„ÇØÂæ©ÂÖÉAPIÂÆüË°å„Ç®„É©„Éº:", error);
                    }
                  }
                }}
                onDelete={async () => {
                  if (selectedTask && onDeletedTaskDeleteAndSelectNext) {
                    // ÂâäÈô§Ê∏à„Åø„Çø„Çπ„ÇØ„ÅÆÂÆåÂÖ®ÂâäÈô§Âá¶ÁêÜÔºàusePermanentDeleteTask„ÅåÂøÖË¶ÅÔºâ
                    onDeletedTaskDeleteAndSelectNext(selectedTask);
                  }
                }}
              />
            ) : (
              <TaskEditor
                task={selectedTask}
                initialBoardId={boardId}
                isFromBoardDetail={true}
                teamMode={teamMode}
                teamId={teamId || undefined}
                {...toCreatorProps(selectedTaskCreatorInfo)}
                preloadedTags={tags || []}
                preloadedBoards={allBoards || []}
                preloadedTaggings={allTaggings || []}
                preloadedBoardItems={allBoardItems}
                onSelectTask={onSelectTask}
                unifiedOperations={taskOperations}
                onClose={() => {
                  // „Ç®„Éá„Ç£„Çø„ÉºÂÜÖ„Åã„Çâ„ÅÆÈñâ„Åò„ÇãÊìç‰Ωú„ÅØÁÑ°Ë¶ñÔºàÂè≥„Éë„Éç„É´„ÅÆ√ó„Éú„Çø„É≥„ÅÆ„Åø„ÅßÈñâ„Åò„ÇãÔºâ
                }}
                onSaveComplete={(savedTask, isNewTask, isContinuousMode) => {
                  if (!isNewTask) {
                    // Á∑®ÈõÜ„ÅÆÂ†¥Âêà„ÅØ‰øùÂ≠òÂæå„Å´ÈÅ∏ÊäûÁä∂ÊÖã„ÇíÊõ¥Êñ∞
                    onSelectTask?.(savedTask);
                  } else if (!isContinuousMode) {
                    // Êñ∞Ë¶è‰ΩúÊàê„ÅßÈÄ£Á∂ö‰ΩúÊàê„É¢„Éº„ÉâOFF„ÅÆÂ†¥Âêà„ÅØ‰ΩúÊàê„Åï„Çå„Åü„Çø„Çπ„ÇØ„ÇíÈÅ∏Êäû
                    onSelectTask?.(savedTask);
                  }
                  // ÈÄ£Á∂ö‰ΩúÊàê„É¢„Éº„ÉâON„ÅÆÂ†¥Âêà„ÅØTaskEditorÂÜÖ„Åß„ÅÆ„Éï„Ç©„Éº„É†„É™„Çª„ÉÉ„Éà„Å´‰ªª„Åõ„Çã
                }}
                onDelete={async () => {
                  // „Éú„Éº„ÉâË©≥Á¥∞„Åß„ÅÆ„Çø„Çπ„ÇØÂâäÈô§Âá¶ÁêÜÔºàÂâäÈô§„Éú„Çø„É≥Ë°®Á§∫Áî®Ôºâ
                }}
                onDeleteAndSelectNext={async (deletedTask: Task) => {
                  // APIÂâäÈô§ÈñãÂßãÔºàÊ•ΩË¶≥ÁöÑÊõ¥Êñ∞„Åß„Ç¢„Ç§„ÉÜ„É†„ÅåÂç≥Â∫ß„Å´Ê∂à„Åà„ÇãÔºâ
                  const deletePromise = taskOperations.deleteItem.mutateAsync(
                    deletedTask.id,
                  );

                  // ÂÖ±ÈÄöÂâäÈô§„Éï„ÉÉ„ÇØ„Å´„Çà„ÇãÂá¶ÁêÜÔºàDOMÂâäÈô§Á¢∫Ë™çÊ∏à„ÅøÔºâ
                  handleTaskDeleteWithNextSelection(deletedTask);

                  // APIÂÆå‰∫Ü„ÇíÂæÖ„Å§
                  await deletePromise;
                }}
              />
            )}
          </div>
        </div>
      )}

      {/* „É°„É¢‰∏ÄË¶ßË°®Á§∫ */}
      {rightPanelMode === "memo-list" && (
        <MemoScreen
          onSelectMemo={(memo) => {
            if (memo && handleMainSelectMemo) {
              // ÈÅ∏ÊäûËß£Èô§„Åï„Çå„Å¶„Ç¢„Ç§„ÉÜ„É†„ÅåÈÅ∏Êäû„Åï„Çå„ÅüÂ†¥Âêà„ÅØ„ÄÅ„É°„É¢ÁîªÈù¢„Å´ÁßªÂãï
              handleMainSelectMemo(memo);
            }
          }}
          onSelectDeletedMemo={() => {}}
          onClose={onClose}
          rightPanelDisabled={true}
          hideHeaderButtons={true}
          hideBulkActionButtons={true}
          onAddToBoard={handleAddMemosToBoard}
          excludeItemIds={currentBoardMemoIds}
          excludeBoardIdFromFilter={boardId}
          initialSelectionMode="check"
          teamMode={teamMode}
          teamId={teamId || undefined}
          unifiedOperations={memoOperations}
        />
      )}

      {/* „Çø„Çπ„ÇØ‰∏ÄË¶ßË°®Á§∫ */}
      {rightPanelMode === "task-list" && (
        <TaskScreen
          onSelectTask={(task) => {
            if (task && handleMainSelectTask) {
              // ÈÅ∏ÊäûËß£Èô§„Åï„Çå„Å¶„Ç¢„Ç§„ÉÜ„É†„ÅåÈÅ∏Êäû„Åï„Çå„ÅüÂ†¥Âêà„ÅØ„ÄÅ„Çø„Çπ„ÇØÁîªÈù¢„Å´ÁßªÂãï
              handleMainSelectTask(task);
            }
          }}
          onSelectDeletedTask={() => {}}
          onClose={onClose}
          rightPanelDisabled={true}
          hideHeaderButtons={true}
          hideBulkActionButtons={true}
          onAddToBoard={handleAddTasksToBoard}
          excludeItemIds={currentBoardTaskIds}
          excludeBoardIdFromFilter={boardId}
          initialSelectionMode="check"
          unifiedOperations={taskOperations}
        />
      )}
    </RightPanel>
  );
}
